<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ã–ÄŸrenci Listesi YÃ¶neticisi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* --- SUPER MODERN PALET --- */
      --primary-hue: 250; /* Deep Purple / Indigo */
      --primary: hsl(var(--primary-hue), 80%, 60%);
      --primary-dark: hsl(var(--primary-hue), 80%, 45%);
      --primary-light: hsl(var(--primary-hue), 90%, 96%);
      --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      
      --bg-body: #f8fafc;
      --bg-surface: rgba(255, 255, 255, 0.85); /* Glass base */
      --bg-panel: #ffffff;
      
      --text-main: #1e293b;     /* Slate 800 */
      --text-muted: #64748b;    /* Slate 500 */
      --text-light: #94a3b8;    
      
      --border: #e2e8f0;
      --border-focus: #8b5cf6;
      
      /* Durum Renkleri (Pastel & CanlÄ±) */
      --success-bg: #dcfce7;
      --success-text: #15803d;
      --warning-bg: #fef9c3;
      --warning-text: #a16207;
      --danger-bg: #fee2e2;
      --danger-text: #b91c1c;
      --info-bg: #e0f2fe;
      --info-text: #0369a1;

      /* Modern GÃ¶lgeler */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
      --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.3);

      /* Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-body);
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
      background-attachment: fixed;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      line-height: 1.6;
    }

    /* Arkaplan Deseni */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; height: 400px;
      background: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%);
      opacity: 0.15;
      z-index: -1;
      mask-image: linear-gradient(to bottom, black, transparent);
    }

    /* Layout */
    .app-shell {
      max-width: 1600px;
      margin: 0 auto;
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 30px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Glass Header */
    header.app-header {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      padding: 20px 30px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(255,255,255,0.6);
      position: sticky;
      top: 20px;
      z-index: 50;
    }

    .app-title-block h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 800;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 16px;
      letter-spacing: -0.5px;
    }

    .app-title-block h1 span.icon { 
      background: var(--primary-gradient);
      color: white;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      font-size: 22px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .app-title-block p {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .chip {
      background: white;
      border: 1px solid var(--border);
      padding: 6px 14px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow-xs);
    }
    .chip::before {
      content: '';
      display: block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary);
    }

    .print-title-block { display: none; }

    /* Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 30px;
      align-items: start;
    }
    @media (max-width: 1200px) { .dashboard-grid { grid-template-columns: 1fr; } }

    /* Panels & Cards */
    .panel {
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(226, 232, 240, 0.8);
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .panel-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-main);
      padding-bottom: 12px;
      border-bottom: 2px solid #f1f5f9;
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 18px;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-xs);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover { 
      transform: translateY(-4px); 
      box-shadow: var(--shadow-md); 
      border-color: var(--primary);
    }

    /* Gradient borders for stats */
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 4px; height: 100%;
      background: var(--border);
      transition: background 0.3s;
    }
    .stat-card.total::after { background: var(--primary); }
    .stat-card.new::after { background: var(--success-text); }
    .stat-card.updated::after { background: var(--warning-text); }
    .stat-card.removed::after { background: var(--danger-text); }

    .stat-card.total { grid-column: 1 / -1; background: linear-gradient(to right, #ffffff, #f8fafc); }
    
    .stat-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 6px; }
    .stat-value { font-size: 36px; font-weight: 800; line-height: 1; color: var(--text-main); letter-spacing: -1px; }
    .stat-desc { font-size: 12px; opacity: 0.8; margin-top: 4px; color: var(--text-muted); }

    /* Inputs & Forms */
    .filters-stack { display: flex; flex-direction: column; gap: 18px; }
    .field-group { display: flex; flex-direction: column; gap: 8px; }
    .field-label { font-size: 13px; font-weight: 600; color: var(--text-main); }

    input[type="text"], input[type="date"], select {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      background: #f8fafc;
      transition: all 0.2s ease;
      color: var(--text-main);
    }

    input:focus, select:focus {
      outline: none;
      background: white;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    /* Class Chips */
    .class-chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .class-chips label { cursor: pointer; user-select: none; }
    .class-chips input { display: none; }
    .class-chips span {
      display: inline-block;
      padding: 8px 14px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .class-chips input:checked + span {
      background: var(--primary-gradient);
      color: white;
      border: 1px solid transparent;
      box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
      transform: scale(1.05);
    }

    /* Modern Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .btn:active { transform: scale(0.97); }

    .btn-primary { 
      background: var(--primary-gradient); 
      color: white; 
      box-shadow: 0 4px 6px rgba(99, 102, 241, 0.25);
    }
    .btn-primary:hover { 
      box-shadow: 0 8px 15px rgba(99, 102, 241, 0.35);
      transform: translateY(-2px);
    }

    .btn-secondary { 
      background: white; 
      border: 1px solid var(--border); 
      color: var(--text-main); 
    }
    .btn-secondary:hover { 
      border-color: #cbd5e1; 
      background: #f8fafc;
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 8px; }

    /* Accordion Details */
    .change-lists details {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-xs);
    }
    .change-lists summary {
      padding: 14px 18px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      background: #fcfcfc;
      transition: background 0.2s;
    }
    .change-lists summary:hover { background: #f1f5f9; }
    .change-lists ul {
      background: white;
      border-top: 1px solid var(--border);
      padding: 0;
      margin: 0;
      max-height: 250px;
      overflow-y: auto;
    }
    .change-lists li {
      padding: 10px 18px;
      border-bottom: 1px solid #f8fafc;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Table Toolbar */
    .table-tools-container {
      background: var(--bg-panel);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .toolbar-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to bottom, #ffffff, #f8fafc);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .view-toggles {
      background: #f1f5f9;
      padding: 4px;
      border-radius: 10px;
      display: inline-flex;
    }
    .view-toggles button {
      background: transparent;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 8px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .view-toggles button.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Modern Table */
    .table-scroll-area { max-height: 750px; overflow: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    
    thead th {
      background: #f8fafc;
      position: sticky;
      top: 0;
      text-align: left;
      padding: 14px 16px;
      font-weight: 700;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      z-index: 10;
      backdrop-filter: blur(8px);
    }

    tbody tr td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text-main);
      font-size: 14px;
      transition: all 0.2s;
    }

    tbody tr:last-child td { border-bottom: none; }
    
    tbody tr:hover td {
      background-color: #f8fafc;
    }

    /* Row Highlights */
    tr.new-row td { background-color: #f0fdf4; color: #166534; }
    tr.updated-row td { background-color: #fffbeb; color: #92400e; }
    
    /* Status Pills */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-badge.normal { background: #f1f5f9; color: var(--text-muted); }
    .status-badge.new { background: #dcfce7; color: #15803d; box-shadow: 0 0 0 1px #86efac; }
    .status-badge.updated { background: #fef9c3; color: #a16207; box-shadow: 0 0 0 1px #fde047; }

    /* Modal */
    .modal-overlay {
      background: rgba(15, 23, 42, 0.4); /* Darker blur */
      backdrop-filter: blur(6px);
    }
    .modal-card {
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    /* Toast */
    .toast {
      background: #1e293b;
      color: white;
      border-radius: 99px;
      padding: 16px 32px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      font-weight: 500;
    }

    /* Print Styles */
    @media print {
      body { background: white !important; background-image: none !important; }
      .app-shell { padding: 0; max-width: none; }
      .print-title-block { display: block !important; margin-bottom: 20px; text-align: center; border-bottom: 2px solid black; }
      header.app-header, .panel, .table-tools-container > div:not(.table-scroll-area) { display: none !important; }
      .table-tools-container { border: none; box-shadow: none; background: white; }
      .table-scroll-area { max-height: none; overflow: visible; }
      table { border: 1px solid #000; }
      th { background: #eee !important; color: black !important; border: 1px solid #000; }
      td { border: 1px solid #000; color: black !important; }
      tr.new-row td, tr.updated-row td { background: white !important; color: black !important; font-weight: bold; }
    }
  </style>
</head>
<body>

  <div class="app-shell">
    
    <div class="print-title-block">
        <h1>Ã–ÄRENCÄ° LÄ°STESÄ°</h1>
        <p id="printDateInfo">Rapor Tarihi: -</p>
    </div>

    <header class="app-header">
      <div class="app-title-block">
        <h1><span class="icon">ğŸ“</span> Ã–ÄŸrenci YÃ¶neticisi</h1>
        <p>Google Eâ€‘Tablo Entegrasyonu + Firebase Takip Sistemi</p>
      </div>
      <div class="header-meta">
        <div class="chip">
          <span id="lastLoadedInfo">Veri bekleniyor...</span>
        </div>
        <div class="chip">
           <span id="compareSourceLabel">KarÅŸÄ±laÅŸtÄ±rma: Yok</span>
        </div>
      </div>
    </header>

    <div class="dashboard-grid">
      
      <div style="display: flex; flex-direction: column; gap: 30px;">
        
        <section>
          <div class="stats-container">
            <div class="stat-card total">
              <div class="stat-label">Toplam Ã–ÄŸrenci</div>
              <div class="stat-value" id="totalCount">â€“</div>
              <div class="stat-desc">Aktif listedeki kayÄ±t sayÄ±sÄ±</div>
            </div>
            <div class="stat-card new">
              <div class="stat-label">Yeni</div>
              <div class="stat-value" id="newCount">â€“</div>
              <div class="stat-desc">Ã–nceki listeye gÃ¶re</div>
            </div>
            <div class="stat-card updated">
              <div class="stat-label">GÃ¼ncel</div>
              <div class="stat-value" id="updatedCount">â€“</div>
              <div class="stat-desc">Bilgisi deÄŸiÅŸenler</div>
            </div>
            <div class="stat-card removed">
              <div class="stat-label">Silinen</div>
              <div class="stat-value" id="removedCount">â€“</div>
              <div class="stat-desc">Listeden dÃ¼ÅŸenler</div>
            </div>
          </div>
          
          <div class="change-lists">
            <details>
              <summary>ğŸ†• Yeni KayÄ±tlar <span class="status-badge new" id="newTagCount" style="margin-left:auto">0</span></summary>
              <ul id="newList"></ul>
            </details>
            <details>
              <summary>âœï¸ GÃ¼ncellenenler <span class="status-badge updated" id="updatedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="updatedList"></ul>
            </details>
            <details>
              <summary>ğŸ—‘ï¸ Silinenler <span class="status-badge normal" id="removedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="removedList"></ul>
            </details>
          </div>
        </section>

        <section class="panel">
          <div class="panel-title">
            <span>ğŸ” Filtreleme</span>
            <button class="btn btn-secondary btn-sm" id="clearFiltersBtn" type="button">Temizle</button>
          </div>
          
          <div class="filters-stack">
            <div class="field-group">
              <div class="field-label">Genel Arama</div>
              <input type="text" id="searchInput" placeholder="Ä°sim, No, Veli ara..." />
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div class="field-group">
                <div class="field-label">Cinsiyet</div>
                <select id="genderFilter">
                  <option value="">TÃ¼mÃ¼</option>
                  <option value="KIZ">KÄ±z</option>
                  <option value="ERKEK">Erkek</option>
                </select>
              </div>
              <div class="field-group">
                <div class="field-label">Burs Durumu</div>
                <select id="scholarFilter">
                  <option value="">TÃ¼mÃ¼</option>
                  <option value="nonempty">Burslu</option>
                  <option value="empty">Burssuz</option>
                </select>
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">KayÄ±t Durumu</div>
              <select id="statusFilter">
                <option value="">TÃ¼m Durumlar</option>
                <option value="new">Sadece Yeni</option>
                <option value="updated">GÃ¼ncellenenler</option>
                <option value="normal">DeÄŸiÅŸiklik Yok</option>
              </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div class="field-group">
                <div class="field-label">BaÅŸlangÄ±Ã§ Tarihi</div>
                <input type="date" id="dateFrom" />
              </div>
              <div class="field-group">
                <div class="field-label">BitiÅŸ Tarihi</div>
                <input type="date" id="dateTo" />
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">SÄ±ralama SeÃ§enekleri</div>
              <select id="generalSortOrder">
                <option value="">Otomatik (Durum Ã–ncelikli)</option>
                <option value="name_asc">Ä°sim (A â†’ Z)</option>
                <option value="name_desc">Ä°sim (Z â†’ A)</option>
                <option value="num_asc">Numara (KÃ¼Ã§Ã¼k â†’ BÃ¼yÃ¼k)</option>
                <option value="num_desc">Numara (BÃ¼yÃ¼k â†’ KÃ¼Ã§Ã¼k)</option>
                <option value="date_desc">Tarih (Yeniden â†’ Eskiye)</option>
                <option value="date_asc">Tarih (Eskiden â†’ Yeniye)</option>
              </select>
            </div>

            <div class="field-group">
              <div class="field-label">SÄ±nÄ±flar</div>
              <div id="classFilterContainer" class="class-chips"></div>
            </div>

            <div class="field-group">
              <label style="display:flex; gap:10px; align-items:center; font-size:13px; cursor:pointer; background: #f1f5f9; padding: 10px; border-radius: 8px;">
                <input type="checkbox" id="recentOnly" style="width:16px; height:16px; accent-color: var(--primary);" />
                <span style="font-weight:500;">Sadece son 30 kayÄ±t</span>
              </label>
            </div>

            <hr style="border:0; border-top:1px solid var(--border); width:100%; margin: 8px 0;">

            <div style="display:flex; flex-direction:column; gap:8px;">
              <button class="btn btn-secondary" id="reloadBtn" type="button"> ğŸ”„ Verileri Yenile </button>
            </div>
          </div>
        </section>
      </div>

      <div class="table-tools-container">
        <div class="toolbar-header">
          <div class="table-toolbar-left" style="display:flex; flex-direction:column; gap:8px;">
            <div class="sheet-tabs" id="sheetTabs"></div>
            <div class="view-toggles">
              <button type="button" data-view="all" class="active" id="viewAllBtn">TÃ¼m Liste</button>
              <button type="button" data-view="new-updated" id="viewNewUpdatedBtn">âœ¨ DeÄŸiÅŸiklikler</button>
            </div>
          </div>
          <div class="table-toolbar-right" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary btn-sm no-print" id="saveSnapshotBtn"> ğŸ’¾ Kaydet </button>
            <button class="btn btn-secondary btn-sm no-print" id="downloadTxtBtn"> ğŸ“¥ Ä°ndir (TXT) </button>
            <button class="btn btn-secondary btn-sm no-print" id="uploadTxtBtn"> ğŸ“¤ KarÅŸÄ±laÅŸtÄ±r </button>
            <button class="btn btn-secondary btn-sm no-print" id="printBtn"> ğŸ–¨ï¸ YazdÄ±r </button>
          </div>
        </div>

        <div style="padding: 10px 24px; background: rgba(248, 250, 252, 0.8); border-bottom: 1px solid var(--border); font-size:12px; color:var(--text-muted); display:flex; align-items:center; gap:6px;" id="listStatusBar">
          <span style="display:inline-block; width:8px; height:8px; background:var(--text-muted); border-radius:50%;"></span>
          YÃ¼kleniyor...
        </div>

        <input type="file" id="uploadTxtInput" accept=".txt,.json" style="display:none;" />

        <div class="no-print" style="padding: 10px 24px; background: #fff; border-bottom: 1px solid var(--border);">
          <details>
            <summary style="font-size:12px; color:var(--text-muted); cursor:pointer; font-weight:600;">ğŸ–¨ï¸ YazdÄ±rma SÃ¼tunlarÄ±nÄ± SeÃ§</summary>
            <div class="cols" id="printColsContainer" style="display:flex; flex-wrap:wrap; gap:12px; padding-top:8px; font-size:13px;"></div>
          </details>
        </div>

        <div class="table-scroll-area">
          <table id="studentsTable">
            <thead>
              <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="tableBody">
              <tr class="loading-row">
                <td colspan="12" style="text-align:center; padding: 60px; color: var(--text-muted);">
                    <div style="font-size: 16px; font-weight: 500;">Veriler yÃ¼kleniyor...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="padding: 16px 24px; background: #f8fafc; border-top: 1px solid var(--border); font-size:12px; color:var(--text-muted); text-align:center;">
          <span id="lastSavedInfo">Son kayÄ±t: Yok</span> â€¢ Detay iÃ§in satÄ±ra tÄ±klayÄ±n.
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">
    <span style="font-size: 20px;">âœ…</span>
    <span id="toastMessage">Ä°ÅŸlem baÅŸarÄ±lÄ±.</span>
  </div>

  <div class="modal-overlay" id="studentDetailModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Ã–ÄŸrenci DetayÄ±</div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" id="modalContent">
        </div>
    </div>
  </div>

  <script type="module">
    // =======================
    // KONFÄ°GÃœRASYON
    // =======================
    const SHEET_ID = "16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi";
    const SHEET_TABS = [
      { name: "2025-2026", label: "2025-2026 DÃ¶nemi" }
    ];
    let currentSheetName = SHEET_TABS[0].name;

    const STORAGE_KEY_BASE = "ogrenci_listesi_snapshot_v3_";

    // Tablo SÃ¼tun TanÄ±mlarÄ±
    const COLUMNS = [
      { key: "status", label: "DURUM" },
      { key: "isim", label: "Ä°SÄ°M" },
      { key: "soyisim", label: "SOYÄ°SÄ°M" },
      { key: "cinsiyet", label: "CÄ°NSÄ°YET" },
      { key: "sinif", label: "SINIF" },
      { key: "okulNo", label: "OKUL NO" },
      { key: "veliAdi", label: "VELÄ° ADI" },
      { key: "veliSoyadi", label: "VELÄ° SOYADI" },
      { key: "veliTelefon", label: "VELÄ° TELEFON" },
      { key: "yil", label: "YIL" },
      { key: "tarih", label: "TARÄ°H" },
      { key: "burslu", label: "BURSLU MU?" }
    ];

    let students = [];       
    let snapshot = null;     
    let snapshotSource = "none"; // 'local', 'uploaded', 'none'
    let activeViewMode = "all";  // 'all', 'new-updated'

    // =======================
    // FIREBASE
    // =======================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-954109786"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // =======================
    // BAÅLATMA
    // =======================
    document.addEventListener("DOMContentLoaded", async () => {
      initTabs();
      initEventListeners();
      
      // Ä°lk yÃ¼kleme (Firebase -> yoksa Google Sheets)
      await loadDataSmart();
    });

    function initTabs() {
      const container = document.getElementById("sheetTabs");
      container.innerHTML = "";
      SHEET_TABS.forEach(tab => {
        const btn = document.createElement("button");
        btn.className = "sheet-tab" + (tab.name === currentSheetName ? " active" : "");
        btn.textContent = tab.label;
        btn.onclick = () => {
          if (currentSheetName === tab.name) return;
          currentSheetName = tab.name;
          document.querySelectorAll(".sheet-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          loadDataSmart();
        };
        container.appendChild(btn);
      });
    }

    function initEventListeners() {
      // Filtreler
      document.getElementById("searchInput").addEventListener("input", renderTable);
      document.getElementById("genderFilter").addEventListener("change", renderTable);
      document.getElementById("scholarFilter").addEventListener("change", renderTable);
      document.getElementById("statusFilter").addEventListener("change", renderTable);
      document.getElementById("dateFrom").addEventListener("change", renderTable);
      document.getElementById("dateTo").addEventListener("change", renderTable);
      document.getElementById("generalSortOrder").addEventListener("change", renderTable);
      document.getElementById("recentOnly").addEventListener("change", renderTable);
      
      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        document.getElementById("genderFilter").value = "";
        document.getElementById("scholarFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        document.getElementById("generalSortOrder").value = "";
        document.getElementById("recentOnly").checked = false;
        
        // SÄ±nÄ±f checkboxlarÄ±nÄ± temizle
        document.querySelectorAll(".class-chips input").forEach(ch => ch.checked = false);
        
        renderTable();
      });

      // GÃ¶rÃ¼nÃ¼m ModlarÄ±
      document.getElementById("viewAllBtn").addEventListener("click", () => {
        setActiveView("all");
      });
      document.getElementById("viewNewUpdatedBtn").addEventListener("click", () => {
        setActiveView("new-updated");
      });

      // Butonlar
      document.getElementById("reloadBtn").addEventListener("click", () => {
        fetchFromGoogleSheets();
      });

      document.getElementById("saveSnapshotBtn").addEventListener("click", saveSnapshotToFirebase);
      
      document.getElementById("downloadTxtBtn").addEventListener("click", downloadSnapshotAsTxt);
      
      document.getElementById("uploadTxtBtn").addEventListener("click", () => {
        document.getElementById("uploadTxtInput").click();
      });
      document.getElementById("uploadTxtInput").addEventListener("change", handleFileUpload);

      document.getElementById("printBtn").addEventListener("click", () => {
        window.print();
      });
    }

    function setActiveView(mode) {
      activeViewMode = mode;
      // Buton stilleri
      if(mode === 'all') {
        document.getElementById("viewAllBtn").classList.add("active");
        document.getElementById("viewNewUpdatedBtn").classList.remove("active");
      } else {
        document.getElementById("viewAllBtn").classList.remove("active");
        document.getElementById("viewNewUpdatedBtn").classList.add("active");
      }
      renderTable();
    }

    // =======================
    // VERÄ° YÃ–NETÄ°MÄ° (SMART LOAD)
    // =======================
    async function loadDataSmart() {
      showStatus("Veriler kontrol ediliyor...");
      
      // 1. Ã–nce Firebase'den kayÄ±tlÄ± Snapshot var mÄ± bak
      const fbData = await fetchSnapshotFromFirebase();
      
      if (fbData) {
        // Firebase'de veri var. Bunu "Snapshot" (Referans) olarak al.
        snapshot = fbData.data; 
        snapshotSource = "firebase"; 
        updateSnapshotInfo(fbData.timestamp, "Firebase");
        
        // Åimdi gÃ¼ncel veriyi Google Sheets'ten Ã§ekip karÅŸÄ±laÅŸtÄ±ralÄ±m
        await fetchFromGoogleSheets();
        
      } else {
        // Firebase boÅŸsa, direkt Sheets'ten Ã§ek, snapshot yok.
        snapshot = null;
        snapshotSource = "none";
        updateSnapshotInfo(null, "Yok");
        await fetchFromGoogleSheets();
      }
    }

    // =======================
    // GOOGLE SHEETS FETCH
    // =======================
    async function fetchFromGoogleSheets() {
      showStatus("Google Sheets'ten gÃ¼ncel liste Ã§ekiliyor...");
      
      const query = "SELECT A,B,C,D,E,F,G,H,I,J,K,L";
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${currentSheetName}&tq=${encodeURIComponent(query)}`;

      try {
        const res = await fetch(url);
        const text = await res.text();
        const jsonText = text.substr(47).slice(0, -2);
        const json = JSON.parse(jsonText);

        const rows = json.table.rows;
        
        // Ham veriyi iÅŸle
        students = rows.map(r => {
          const c = r.c;
          return {
            isim: c[0] ? c[0].v : "",
            soyisim: c[1] ? c[1].v : "",
            cinsiyet: c[2] ? c[2].v : "",
            sinif: c[3] ? (c[3].v ? c[3].v.toString() : "") : "",
            okulNo: c[4] ? (c[4].v ? c[4].v.toString() : "") : "",
            veliAdi: c[5] ? c[5].v : "",
            veliSoyadi: c[6] ? c[6].v : "",
            veliTelefon: c[7] ? (c[7].v ? c[7].v.toString() : "") : "",
            yil: c[8] ? (c[8].v ? c[8].v.toString() : "") : "",
            tarih: c[9] ? (c[9].f || c[9].v) : "", // Tarih formatlÄ± gelebilir
            burslu: c[10] ? c[10].v : null,
            // ID oluÅŸtur (OkulNo varsa onu kullan, yoksa Ä°sim+Soyisim)
            uniqueId: (c[4] && c[4].v) 
                      ? c[4].v.toString().trim() 
                      : (c[0]?.v + "_" + c[1]?.v).replace(/\s+/g,'')
          };
        });

        // Veri Ã§ekildi, ÅŸimdi analiz et
        analyzeDataAgainstSnapshot();
        
        // UI GÃ¼ncelle
        populateClassFilter();
        renderTable();
        showStatus(`YÃ¼klendi: ${students.length} Ã¶ÄŸrenci`);
        updateTimeInfo();

      } catch (err) {
        console.error(err);
        showStatus("Hata: Veri Ã§ekilemedi.");
        alert("Google Sheets verisi alÄ±namadÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
      }
    }

    // =======================
    // ANALÄ°Z & KARÅILAÅTIRMA
    // =======================
    function analyzeDataAgainstSnapshot() {
      // EÄŸer snapshot yoksa herkes "normal"
      if (!snapshot) {
        students.forEach(s => {
          s.status = "normal";
          s.changes = [];
        });
        updateStats(students.length, 0, 0, 0);
        return;
      }

      // Snapshot'Ä± bir Map'e Ã§evir (HÄ±zlÄ± arama iÃ§in)
      const snapMap = new Map();
      snapshot.forEach(s => snapMap.set(s.uniqueId, s));

      let newCount = 0;
      let updatedCount = 0;
      let removedList = [];

      // 1. Mevcut listedekileri kontrol et (YENÄ° veya GÃœNCELLENMÄ°Å mi?)
      students.forEach(s => {
        const oldRec = snapMap.get(s.uniqueId);
        
        if (!oldRec) {
          // Eskide yoktu -> YENÄ°
          s.status = "new";
          s.changes = ["Yeni kayÄ±t"];
          newCount++;
        } else {
          // Eskide vardÄ± -> DeÄŸiÅŸiklik var mÄ±?
          const diffs = getDifferences(oldRec, s);
          if (diffs.length > 0) {
            s.status = "updated";
            s.changes = diffs;
            updatedCount++;
          } else {
            s.status = "normal";
            s.changes = [];
          }
          // Kontrol edildiÄŸi iÃ§in map'ten silelim (geriye silinenler kalsÄ±n diyeceÄŸim ama map'i bozmayalÄ±m)
          snapMap.set(s.uniqueId, { ...oldRec, _checked: true });
        }
      });

      // 2. Silinenleri bul (Snapshot'ta olup checked olmayanlar)
      snapMap.forEach((val, key) => {
        if (!val._checked) {
          removedList.push(val);
        }
      });

      // Ä°statistikleri gÃ¼ncelle
      updateStats(students.length, newCount, updatedCount, removedList.length);
      
      // DeÄŸiÅŸiklik listelerini doldur (Sidebar)
      fillChangeLists(students.filter(s=>s.status==='new'), students.filter(s=>s.status==='updated'), removedList);
    }

    function getDifferences(oldS, newS) {
      const diffs = [];
      // Hangi alanlarÄ± kÄ±yaslayalÄ±m?
      const fieldsToCheck = [
        {k:'isim', l:'Ä°sim'}, {k:'soyisim', l:'Soyisim'}, 
        {k:'sinif', l:'SÄ±nÄ±f'}, {k:'veliAdi', l:'Veli AdÄ±'},
        {k:'veliTelefon', l:'Telefon'}, {k:'burslu', l:'Burs'}
      ];

      fieldsToCheck.forEach(f => {
        const valOld = (oldS[f.k] || "").toString().trim();
        const valNew = (newS[f.k] || "").toString().trim();
        if (valOld !== valNew) {
          diffs.push(`${f.l}: ${valOld} â” ${valNew}`);
        }
      });
      return diffs;
    }

    // =======================
    // UI GÃœNCELLEME
    // =======================
    function updateStats(total, newVal, updatedVal, removedVal) {
      animateValue("totalCount", parseInt(document.getElementById("totalCount").innerText)||0, total, 1000);
      document.getElementById("newCount").innerText = newVal;
      document.getElementById("updatedCount").innerText = updatedVal;
      document.getElementById("removedCount").innerText = removedVal;

      document.getElementById("newTagCount").innerText = newVal;
      document.getElementById("updatedTagCount").innerText = updatedVal;
      document.getElementById("removedTagCount").innerText = removedVal;
    }
    
    // SayÄ± artÄ±ÅŸ animasyonu
    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const range = end - start;
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        const obj = document.getElementById(id);
        const timer = setInterval(function() {
            current += increment;
            obj.innerHTML = current;
            if (current == end) {
                clearInterval(timer);
            }
        }, stepTime > 0 ? stepTime : 10);
    }

    function fillChangeLists(newList, updatedList, removedList) {
      const createLi = (s, extra="") => `<li><strong>${s.isim} ${s.soyisim}</strong> (${s.sinif}) ${extra}</li>`;
      
      document.getElementById("newList").innerHTML = newList.length 
        ? newList.map(s => createLi(s)).join("") 
        : "<li style='text-align:center; padding:10px;'>KayÄ±t yok</li>";

      document.getElementById("updatedList").innerHTML = updatedList.length 
        ? updatedList.map(s => createLi(s, `<br><span style="font-size:11px; color:#d97706">${s.changes.join(", ")}</span>`)).join("") 
        : "<li style='text-align:center; padding:10px;'>KayÄ±t yok</li>";
        
      document.getElementById("removedList").innerHTML = removedList.length 
        ? removedList.map(s => createLi(s)).join("") 
        : "<li style='text-align:center; padding:10px;'>KayÄ±t yok</li>";
    }

    function populateClassFilter() {
      // Mevcut sÄ±nÄ±flarÄ± bul
      const classes = [...new Set(students.map(s => s.sinif).filter(c => c))].sort();
      const container = document.getElementById("classFilterContainer");
      
      // EÄŸer zaten doluysa ve sÄ±nÄ±flar deÄŸiÅŸmediyse dokunma (basit kontrol)
      if (container.children.length > 0) return; 

      container.innerHTML = "";
      classes.forEach(c => {
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" value="${c}" />
          <span>${c}</span>
        `;
        // Checkbox deÄŸiÅŸince tabloyu yenile
        label.querySelector("input").addEventListener("change", renderTable);
        container.appendChild(label);
      });
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      const theadRow = document.getElementById("tableHeaderRow");
      
      // 1. Filtre DeÄŸerlerini Al
      const search = document.getElementById("searchInput").value.toLocaleLowerCase("tr");
      const gender = document.getElementById("genderFilter").value;
      const scholar = document.getElementById("scholarFilter").value;
      const statusFilter = document.getElementById("statusFilter").value;
      
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;
      const dateFrom = dateFromVal ? new Date(dateFromVal) : null;
      const dateTo = dateToVal ? new Date(dateToVal) : null;
      
      const sortOrder = document.getElementById("generalSortOrder").value;
      const recentOnly = document.getElementById("recentOnly").checked;

      // SÄ±nÄ±f filtreleri
      const selectedClasses = Array.from(document.querySelectorAll("#classFilterContainer input:checked")).map(cb => cb.value);

      // 2. Filtreleme
      let filtered = students.filter(s => {
        // View Mode (TÃ¼m liste vs DeÄŸiÅŸiklikler)
        if (activeViewMode === 'new-updated') {
            if (s.status === 'normal') return false;
        }

        // Metin Arama
        const textMatch = (s.isim + " " + s.soyisim + " " + s.okulNo + " " + s.veliAdi).toLocaleLowerCase("tr").includes(search);
        if (!textMatch) return false;

        // Cinsiyet
        if (gender && s.cinsiyet !== gender) return false;

        // Burs
        if (scholar === "nonempty" && !s.burslu) return false;
        if (scholar === "empty" && s.burslu) return false;

        // Durum
        if (statusFilter === "new" && s.status !== "new") return false;
        if (statusFilter === "updated" && s.status !== "updated") return false;
        if (statusFilter === "normal" && s.status !== "normal") return false;

        // Tarih
        if (dateFrom || dateTo) {
             // Tarih formatÄ± "DD.MM.YYYY" varsayÄ±lÄ±yor, parse etmeye Ã§alÄ±ÅŸalÄ±m
             // Sheets'ten string geliyor olabilir. Basit bir parsing:
             const parts = s.tarih ? s.tarih.split(".") : [];
             if (parts.length === 3) {
                 const sDate = new Date(parts[2], parts[1]-1, parts[0]); // YÄ±l, Ay(0-index), GÃ¼n
                 if (dateFrom && sDate < dateFrom) return false;
                 if (dateTo && sDate > dateTo) return false;
             }
        }

        // SÄ±nÄ±f
        if (selectedClasses.length > 0 && !selectedClasses.includes(s.sinif)) return false;

        return true;
      });

      // 3. SÄ±ralama
      if (sortOrder) {
          filtered.sort((a, b) => {
              if (sortOrder === "name_asc") return a.isim.localeCompare(b.isim, "tr");
              if (sortOrder === "name_desc") return b.isim.localeCompare(a.isim, "tr");
              if (sortOrder === "num_asc") return parseInt(a.okulNo||0) - parseInt(b.okulNo||0);
              if (sortOrder === "num_desc") return parseInt(b.okulNo||0) - parseInt(a.okulNo||0);
              // Tarih sÄ±ralamasÄ± (Basit string karÅŸÄ±laÅŸtÄ±rma yetmeyebilir, parse lazÄ±m ama idareten)
              if (sortOrder === "date_desc" || sortOrder === "date_asc") {
                  // Tarih parse helper
                  const tp = (d) => {
                      if(!d) return 0;
                      const p = d.split(".");
                      return p.length===3 ? new Date(p[2], p[1]-1, p[0]).getTime() : 0;
                  };
                  const tA = tp(a.tarih);
                  const tB = tp(b.tarih);
                  return sortOrder === "date_desc" ? tB - tA : tA - tB;
              }
              return 0;
          });
      } else {
          // VarsayÄ±lan: Duruma gÃ¶re (Yeni -> GÃ¼ncel -> Normal)
          // Sonra da Ä°sme gÃ¶re
          filtered.sort((a, b) => {
              const score = (status) => status === 'new' ? 3 : (status === 'updated' ? 2 : 1);
              const scoreDiff = score(b.status) - score(a.status);
              if (scoreDiff !== 0) return scoreDiff;
              return a.isim.localeCompare(b.isim, "tr");
          });
      }

      // Son 30 KayÄ±t
      if (recentOnly) {
          filtered = filtered.slice(0, 30);
      }

      // 4. Tablo BaÅŸlÄ±klarÄ±nÄ± OluÅŸtur
      // YazdÄ±rma modunda gizlenecek sÃ¼tunlarÄ± yÃ¶netmek iÃ§in class ekliyoruz
      // Basitlik iÃ§in tÃ¼m sÃ¼tunlarÄ± koyalÄ±m, yazdÄ±rmada CSS ile gizlemek yerine
      // JS ile dinamik yazdÄ±rma sÃ¼tunu seÃ§imi daha karmaÅŸÄ±k, ÅŸimdilik hepsini render et.
      
      // SÃ¼tun BaÅŸlÄ±klarÄ± HTML
      let thHtml = "";
      COLUMNS.forEach((col, index) => {
        thHtml += `<th class="col-${index}">${col.label}</th>`;
      });
      theadRow.innerHTML = thHtml;
      
      // YazdÄ±rma SÃ¼tun SeÃ§imi MenÃ¼sÃ¼nÃ¼ GÃ¼ncelle (Sadece bir kere veya her renderda)
      updatePrintColSelection();

      // 5. SatÄ±rlarÄ± OluÅŸtur
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${COLUMNS.length}" style="text-align:center; padding:30px; color:var(--text-muted);">EÅŸleÅŸen kayÄ±t bulunamadÄ±.</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(s => {
        let rowClass = "";
        if (s.status === "new") rowClass = "new-row";
        if (s.status === "updated") rowClass = "updated-row";

        // Durum hÃ¼cresi
        let statusHtml = `<span class="status-badge ${s.status}">
            ${s.status==='new' ? 'YENÄ°' : (s.status==='updated' ? 'GÃœNCEL' : 'NORMAL')}
        </span>`;

        // HÃ¼creler
        // COLUMNS dizisine gÃ¶re map ediyoruz
        const tds = COLUMNS.map((col, idx) => {
            let val = "";
            if (col.key === "status") val = statusHtml;
            else if (col.key === "burslu") val = s.burslu ? "âœ…" : "";
            else val = s[col.key] || "";
            
            return `<td class="col-${idx}">${val}</td>`;
        }).join("");

        // SatÄ±ra tÄ±klandÄ±ÄŸÄ±nda detay aÃ§Ä±lmasÄ± iÃ§in onclick
        // JSON.stringify ile veriyi gÃ¶mmek yerine ID Ã¼zerinden bulacaÄŸÄ±z
        return `<tr class="${rowClass}" onclick="openDetail('${s.uniqueId}')">${tds}</tr>`;
      }).join("");
    }

    // =======================
    // DETAY MODALI
    // =======================
    window.openDetail = (uniqueId) => {
      const s = students.find(x => x.uniqueId === uniqueId);
      if (!s) return;

      const modal = document.getElementById("studentDetailModal");
      const content = document.getElementById("modalContent");
      
      modal.classList.add("active");
      
      let statusHtml = `<span class="status-badge ${s.status}">${s.status.toUpperCase()}</span>`;
      
      let changesHtml = "";
      if (s.changes && s.changes.length > 0) {
          changesHtml = `
            <div class="change-log-box">
                <strong>DeÄŸiÅŸiklikler:</strong>
                <ul style="margin:4px 0 0 16px; padding:0;">
                    ${s.changes.map(c => `<li>${c}</li>`).join('')}
                </ul>
            </div>
          `;
      }

      content.innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:24px; font-weight:700;">${s.isim} ${s.soyisim}</div>
            <div style="font-size:14px; color:var(--text-muted);">${s.okulNo}</div>
            <div style="margin-top:10px;">${statusHtml}</div>
        </div>

        <div class="detail-row"><span class="detail-label">SÄ±nÄ±f:</span> <span class="detail-val">${s.sinif}</span></div>
        <div class="detail-row"><span class="detail-label">Cinsiyet:</span> <span class="detail-val">${s.cinsiyet}</span></div>
        <div class="detail-row"><span class="detail-label">Veli AdÄ±:</span> <span class="detail-val">${s.veliAdi} ${s.veliSoyadi}</span></div>
        <div class="detail-row"><span class="detail-label">Veli Telefon:</span> <span class="detail-val">${s.veliTelefon || "-"}</span></div>
        <div class="detail-row"><span class="detail-label">KayÄ±t Tarihi:</span> <span class="detail-val">${s.tarih || "-"}</span></div>
        <div class="detail-row"><span class="detail-label">Burs Durumu:</span> <span class="detail-val">${s.burslu ? "Burslu" : "Normal"}</span></div>
        
        ${changesHtml}
      `;
    };

    window.closeModal = () => {
      document.getElementById("studentDetailModal").classList.remove("active");
    };

    // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapatma
    document.getElementById("studentDetailModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("studentDetailModal")) closeModal();
    });

    // =======================
    // YAZDIRMA AYARLARI
    // =======================
    function updatePrintColSelection() {
        const container = document.getElementById("printColsContainer");
        // Sadece boÅŸsa doldur
        if(container.children.length > 0) return;

        COLUMNS.forEach((col, idx) => {
            const lbl = document.createElement("label");
            lbl.style.display = "flex";
            lbl.style.alignItems = "center";
            lbl.style.gap = "4px";
            lbl.style.cursor = "pointer";
            
            lbl.innerHTML = `
                <input type="checkbox" checked data-col-idx="${idx}" class="print-col-toggle">
                ${col.label}
            `;
            container.appendChild(lbl);
        });

        // Event listener ekle
        document.querySelectorAll(".print-col-toggle").forEach(cb => {
            cb.addEventListener("change", (e) => {
                const idx = e.target.dataset.colIdx;
                const visible = e.target.checked;
                // Tablodaki ilgili sÃ¼tunlarÄ± gizle/gÃ¶ster (CSS ile deÄŸil JS ile class ekleyip style basarak)
                // En temizi: <style> bloÄŸu ekleyip .col-X { display: none } basmak.
                toggleColumnVisibility(idx, visible);
            });
        });
    }

    function toggleColumnVisibility(colIdx, visible) {
        // Bu iÅŸlem iÃ§in dinamik bir style elementi kullanalÄ±m
        let styleEl = document.getElementById("dynamicPrintStyle");
        if (!styleEl) {
            styleEl = document.createElement("style");
            styleEl.id = "dynamicPrintStyle";
            document.head.appendChild(styleEl);
        }
        
        // Mevcut kurallarÄ± oku veya yÃ¶net. BasitÃ§e: "hide-col-X" class'Ä± ekle.
        // AslÄ±nda daha kolayÄ±: Tablo hÃ¼crelerine class vermiÅŸtik (.col-0, .col-1...)
        // Sadece print media query iÃ§inde display:none verelim.
        
        // Ama JS tarafÄ±nda yapmak anlÄ±k Ã¶nizleme iÃ§in daha iyi.
        const cells = document.querySelectorAll(`.col-${colIdx}`);
        cells.forEach(c => {
            c.style.display = visible ? "" : "none";
        });
    }

    // =======================
    // FIREBASE KAYDETME & YÃœKLEME
    // =======================
    async function saveSnapshotToFirebase() {
      if (students.length === 0) {
        showToast("Kaydedilecek veri yok!", "error");
        return;
      }
      
      const dbRef = ref(db, 'snapshots/' + currentSheetName);
      
      // Gereksiz alanlarÄ± temizle
      const cleanData = students.map(s => {
          const { status, changes, ...rest } = s; // Status ve changes'i kaydetmeye gerek yok, onlar dinamik hesaplanÄ±r
          return rest;
      });

      const payload = {
          timestamp: new Date().toISOString(),
          data: cleanData
      };

      try {
        await set(dbRef, payload);
        showToast("Snapshot Firebase'e baÅŸarÄ±yla kaydedildi!");
        
        // Kaydettikten sonra mevcut snapshot'Ä± gÃ¼ncelle
        snapshot = cleanData;
        snapshotSource = "firebase";
        updateSnapshotInfo(payload.timestamp, "Firebase (Åimdi)");
        analyzeDataAgainstSnapshot(); // DurumlarÄ± sÄ±fÄ±rlar (hepsi normal olur Ã§Ã¼nkÃ¼ aynÄ±sÄ±)
        renderTable();

      } catch (err) {
        console.error(err);
        showToast("Firebase KayÄ±t HatasÄ±!", "error");
      }
    }

    async function fetchSnapshotFromFirebase() {
       const dbRef = ref(db, 'snapshots/' + currentSheetName);
       try {
           const snap = await get(dbRef);
           if (snap.exists()) {
               return snap.val();
           } else {
               return null;
           }
       } catch (err) {
           console.error("Firebase Read Error:", err);
           return null;
       }
    }

    // =======================
    // DOSYA Ä°NDÄ°R / YÃœKLE
    // =======================
    function downloadSnapshotAsTxt() {
      if (students.length === 0) return;
      
      const cleanData = students.map(s => {
          const { status, changes, ...rest } = s;
          return rest;
      });
      
      const dataStr = JSON.stringify(cleanData, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement("a");
      a.href = url;
      a.download = `ogrenci_listesi_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const json = JSON.parse(evt.target.result);
          if (Array.isArray(json)) {
             snapshot = json;
             snapshotSource = "uploaded";
             updateSnapshotInfo(new Date().toISOString(), "YÃ¼klenen Dosya");
             analyzeDataAgainstSnapshot();
             renderTable();
             showToast("KarÅŸÄ±laÅŸtÄ±rma dosyasÄ± yÃ¼klendi.");
          } else {
             alert("GeÃ§ersiz dosya formatÄ±.");
          }
        } catch (err) {
          alert("Dosya okuma hatasÄ±: " + err.message);
        }
      };
      reader.readAsText(file);
      // Reset input
      e.target.value = "";
    }

    // =======================
    // YARDIMCILAR
    // =======================
    function showStatus(msg) {
      document.getElementById("lastLoadedInfo").innerText = msg;
    }

    function updateTimeInfo() {
      const now = new Date();
      document.getElementById("printDateInfo").innerText = "Rapor Tarihi: " + now.toLocaleString("tr-TR");
    }

    function updateSnapshotInfo(timestamp, source) {
      const lbl = document.getElementById("compareSourceLabel");
      const savedInfo = document.getElementById("lastSavedInfo");
      
      if (source === "none") {
          lbl.innerText = "KarÅŸÄ±laÅŸtÄ±rma: Yok";
          savedInfo.innerText = "Son kayÄ±t: Yok (TÃ¼m liste normal gÃ¶rÃ¼nÃ¼yor)";
      } else {
          let timeStr = timestamp ? new Date(timestamp).toLocaleString("tr-TR") : "-";
          lbl.innerText = `KarÅŸÄ±laÅŸtÄ±rma: ${source}`;
          savedInfo.innerText = `Baz alÄ±nan kayÄ±t: ${source} (${timeStr})`;
      }
    }

    function showToast(msg, type="success") {
      const t = document.getElementById("toast");
      const tm = document.getElementById("toastMessage");
      tm.innerText = msg;
      t.style.background = type === "error" ? "#ef4444" : "#1e293b";
      t.classList.add("visible");
      setTimeout(() => t.classList.remove("visible"), 3000);
    }

  </script>
</body>
</html>

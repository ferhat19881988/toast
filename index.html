<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Öğrenci Listesi Yöneticisi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      /* Modern Gradient Renk Paleti */
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
      --primary-light: #eef2ff;
      
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      
      --text-main: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      
      /* Durum Renkleri */
      --success: #10b981;
      --success-bg: #d1fae5;
      --success-light: #ecfdf5;
      --warning: #f59e0b;
      --warning-bg: #fef3c7;
      --warning-light: #fffbeb;
      --danger: #ef4444;
      --danger-bg: #fee2e2;
      --danger-light: #fef2f2;
      --info: #0ea5e9;
      --info-bg: #e0f2fe;

      /* Gölgeler */
      --shadow-xs: 0 1px 3px rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 2px 6px rgba(0, 0, 0, 0.07);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
      
      /* Köşe Yuvarlaklıkları */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-full: 999px;
      
      /* Geçişler */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Dark Mode Varsayılan Değerler */
    @media (prefers-color-scheme: dark) {
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        --primary-light: rgba(99, 102, 241, 0.1);
        
        --bg-body: #0f172a;
        --bg-card: #1e293b;
        
        --text-main: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --text-light: #64748b;
        
        --border: #334155;
        --border-light: #1e293b;
        
        --success: #34d399;
        --success-bg: rgba(52, 211, 153, 0.15);
        --warning: #fbbf24;
        --warning-bg: rgba(251, 191, 36, 0.15);
        --danger: #f87171;
        --danger-bg: rgba(248, 113, 113, 0.15);
        --info: #38bdf8;
        --info-bg: rgba(56, 189, 248, 0.15);
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
      font-weight: 400;
      min-height: 100vh;
    }

    /* Layout & Shell */
    .app-shell {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Header */
    header.app-header {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 28px 32px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--primary-gradient);
    }

    .app-title-block h1 {
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 16px;
      letter-spacing: -0.5px;
    }

    .app-title-block h1 span.icon {
      background: var(--primary-gradient);
      color: white;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-lg);
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .app-title-block p {
      margin: 8px 0 0 0;
      font-size: 15px;
      color: var(--text-muted);
      font-weight: 400;
      max-width: 600px;
    }

    .header-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .chip {
      background: var(--primary-light);
      border: 1px solid rgba(67, 97, 238, 0.2);
      padding: 10px 18px;
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 500;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition-fast);
    }

    .chip:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .chip i {
      font-size: 14px;
    }

    /* Print Header (Varsayılan Gizli) */
    .print-title-block { display: none; }

    /* Main Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* Panels */
    .panel {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 28px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      height: 100%;
      transition: var(--transition-normal);
    }

    .panel:hover {
      box-shadow: var(--shadow-lg);
    }

    .panel-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-main);
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
    }

    .panel-title span {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 20px;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      transition: var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
    }

    .stat-card.total::before { background: var(--primary-gradient); }
    .stat-card.new::before { background: var(--success); }
    .stat-card.updated::before { background: var(--warning); }
    .stat-card.removed::before { background: var(--danger); }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card.total { 
      grid-column: 1 / -1;
      background: var(--primary-light);
      border-color: rgba(67, 97, 238, 0.2);
    }

    .stat-card.new { 
      background: var(--success-light);
      border-color: rgba(16, 185, 129, 0.2);
    }

    .stat-card.updated { 
      background: var(--warning-light);
      border-color: rgba(245, 158, 11, 0.2);
    }

    .stat-card.removed { 
      background: var(--danger-light);
      border-color: rgba(239, 68, 68, 0.2);
    }

    .stat-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      margin: 4px 0;
      line-height: 1;
      color: var(--text-main);
    }

    .stat-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* Filter Inputs */
    .filters-stack {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .field-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field-label span {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 12px;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-card);
      color: var(--text-main);
      transition: var(--transition-fast);
      font-weight: 400;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    /* Class Chips */
    .class-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 4px 0;
    }

    .class-chips label {
      cursor: pointer;
      user-select: none;
      transition: var(--transition-fast);
    }
    
    .class-chips input[type="checkbox"] { display: none; }
    
    .class-chips span {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      transition: var(--transition-fast);
    }

    .class-chips span:hover {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
    }

    .class-chips input:checked + span {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: var(--transition-normal);
      font-family: 'Inter', sans-serif;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }

    .btn:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }

    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(40, 40);
        opacity: 0;
      }
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }

    .btn-secondary {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-main);
      box-shadow: var(--shadow-xs);
    }

    .btn-secondary:hover {
      background: var(--bg-body);
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: var(--shadow-sm);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: var(--radius-sm);
    }

    /* Changes Accordion */
    .change-lists details {
      background: var(--bg-body);
      border-radius: var(--radius-md);
      margin-bottom: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: var(--transition-fast);
    }
    
    .change-lists details:hover {
      border-color: var(--primary);
    }
    
    .change-lists summary {
      padding: 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-main);
      transition: var(--transition-fast);
    }
    
    .change-lists summary:hover {
      background: rgba(67, 97, 238, 0.05);
    }
    
    .change-lists summary::after {
      content: '›';
      font-size: 18px;
      transform: rotate(90deg);
      transition: var(--transition-fast);
      color: var(--text-muted);
    }
    
    .change-lists details[open] summary::after {
      transform: rotate(-90deg);
    }
    
    .change-lists ul {
      margin: 0;
      padding: 0 16px 16px;
      background: var(--bg-card);
      list-style-type: none;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .change-lists li {
      font-size: 13px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
    }
    
    .change-lists li:hover {
      background: var(--bg-body);
      color: var(--text-main);
    }

    /* Table Toolbar */
    .table-tools-container {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .toolbar-header {
      padding: 20px 28px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-body);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .sheet-tabs {
      display: flex;
      gap: 8px;
      background: var(--bg-body);
      padding: 4px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }
    
    .sheet-tab {
      background: transparent;
      border: none;
      padding: 8px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .sheet-tab:hover {
      background: var(--primary-light);
      color: var(--primary);
    }
    
    .sheet-tab.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .view-toggles {
      display: flex;
      background: var(--bg-body);
      padding: 4px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }
    
    .view-toggles button {
      background: transparent;
      border: none;
      padding: 8px 18px;
      font-size: 13px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 500;
      transition: var(--transition-fast);
    }
    
    .view-toggles button:hover:not(.active) {
      background: var(--primary-light);
      color: var(--primary);
    }
    
    .view-toggles button.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    /* Table */
    .table-scroll-area {
      max-height: 700px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-light) transparent;
    }

    .table-scroll-area::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll-area::-webkit-scrollbar-track {
      background: var(--bg-body);
      border-radius: var(--radius-full);
    }

    .table-scroll-area::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: var(--radius-full);
    }

    .table-scroll-area::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
    }

    thead th {
      background: var(--bg-body);
      position: sticky;
      top: 0;
      text-align: left;
      padding: 16px 12px;
      font-weight: 700;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
      z-index: 10;
    }

    tbody tr {
      transition: var(--transition-fast);
      cursor: pointer;
      border-top: 1px solid transparent;
      border-bottom: 1px solid transparent;
    }
    
    tbody tr:hover {
      background-color: var(--primary-light);
      border-top: 1px solid var(--primary);
      border-bottom: 1px solid var(--primary);
    }
    
    tbody td {
      padding: 16px 12px;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-secondary);
      white-space: nowrap;
      font-size: 14px;
      font-weight: 400;
    }

    /* Status Pills in Table */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-badge.normal {
      background: var(--bg-body);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    
    .status-badge.new {
      background: var(--success-bg);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .status-badge.updated {
      background: var(--warning-bg);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    /* New/Updated Row Highlights */
    tr.new-row td {
      background-color: var(--success-light);
      border-color: rgba(16, 185, 129, 0.2);
    }
    
    tr.updated-row td {
      background-color: var(--warning-light);
      border-color: rgba(245, 158, 11, 0.2);
    }
    
    tr.new-row:hover td {
      background-color: rgba(16, 185, 129, 0.1);
    }
    
    tr.updated-row:hover td {
      background-color: rgba(245, 158, 11, 0.1);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--text-main);
      color: white;
      padding: 16px 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(20px);
      transition: var(--transition-normal);
      pointer-events: none;
      z-index: 100;
      max-width: 400px;
      border-left: 4px solid var(--primary);
    }
    
    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* --- MODAL STİLLERİ --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(6px);
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-card {
      background: var(--bg-card);
      width: 100%;
      max-width: 500px;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      animation: modalSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border: 1px solid var(--border);
    }
    
    @keyframes modalSlide {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      padding: 20px 28px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-body);
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
    }

    .modal-close {
      background: var(--danger-bg);
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--danger);
      line-height: 1;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      transition: var(--transition-fast);
    }
    
    .modal-close:hover {
      background: var(--danger);
      color: white;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 28px;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      font-size: 14px;
      padding-bottom: 16px;
      border-bottom: 1px dashed var(--border);
    }
    
    .detail-label {
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .detail-val {
      font-weight: 600;
      color: var(--text-main);
      text-align: right;
    }
    
    .change-log-box {
      margin-top: 24px;
      padding: 20px;
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: var(--radius-lg);
      font-size: 14px;
      color: var(--warning);
    }

    /* --- YAZDIRMA STİLLERİ (YENİLENMİŞ) --- */
    @media print {
      body {
        background: white;
        padding: 0;
        font-size: 12px;
      }
      
      .app-shell {
        max-width: none;
        padding: 0;
      }
      
      /* Gizlenecek Alanlar */
      header.app-header,
      .dashboard-grid > div:first-child, /* Sol panel */
      .table-tools-container .toolbar-header,
      .table-tools-container #listStatusBar,
      .table-tools-container input,
      .no-print,
      .toast,
      .modal-overlay {
        display: none !important;
      }

      /* Düzen */
      .dashboard-grid {
        display: block;
        grid-template-columns: 1fr;
      }
      
      .table-tools-container {
        border: none;
        box-shadow: none;
        overflow: visible;
      }
      
      .table-scroll-area {
        max-height: none;
        overflow: visible;
      }
      
      .panel {
        padding: 0;
        border: none;
        box-shadow: none;
      }

      /* Liste Modernizasyonu */
      table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Inter', sans-serif;
      }
      
      thead th {
        background-color: #f1f5f9 !important;
        color: #0f172a !important;
        border: 2px solid #000;
        font-weight: 800;
        font-size: 12px;
      }
      
      tbody td {
        border: 1px solid #cbd5e1;
        font-size: 11px;
        padding: 8px 10px;
        color: #000;
      }
      
      tr:nth-child(even) {
        background-color: #f8fafc !important;
      }

      /* Özel Yazdırma Başlığı */
      .print-title-block {
        display: block !important;
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #000;
        padding-bottom: 15px;
      }
      
      .print-title-block h1 {
        font-size: 36px;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 800;
      }
      
      .print-title-block p {
        font-size: 14px;
        margin: 8px 0 0 0;
        color: #666;
      }
    }

    .muted-text {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Utility Classes */
    .text-gradient {
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @media (max-width: 768px) {
      .app-shell {
        padding: 16px;
        gap: 16px;
      }
      
      header.app-header {
        padding: 20px;
      }
      
      .app-title-block h1 {
        font-size: 24px;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .toolbar-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .table-toolbar-right {
        width: 100%;
        justify-content: flex-start;
      }
    }

    /* Loading Animation */
    .loading-shimmer {
      background: linear-gradient(
        90deg,
        var(--bg-body) 0%,
        var(--primary-light) 50%,
        var(--bg-body) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-md);
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>
<body>

  <div class="app-shell">
    
    <div class="print-title-block">
        <h1>ÖĞRENCİ LİSTESİ</h1>
        <p id="printDateInfo">Rapor Tarihi: -</p>
    </div>

    <header class="app-header">
      <div class="app-title-block">
        <h1><span class="icon"><i class="fas fa-graduation-cap"></i></span> Öğrenci Listesi Yöneticisi</h1>
        <p>Google E‑Tablo Entegrasyonu + Firebase Takip Sistemi</p>
      </div>
      <div class="header-meta">
        <div class="chip">
          <i class="fas fa-sync-alt"></i>
          <span id="lastLoadedInfo">Veriler yükleniyor...</span>
        </div>
        <div class="chip">
          <i class="fas fa-exchange-alt"></i>
          <span id="compareSourceLabel">Karşılaştırma: Yok</span>
        </div>
      </div>
    </header>

    <div class="dashboard-grid">
      
      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <section>
          <div class="stats-container">
            <div class="stat-card total">
              <div class="stat-label"><i class="fas fa-users"></i> Toplam Öğrenci</div>
              <div class="stat-value" id="totalCount">–</div>
              <div class="stat-desc">Aktif listedeki kayıt sayısı</div>
            </div>
            <div class="stat-card new">
              <div class="stat-label"><i class="fas fa-user-plus"></i> Yeni</div>
              <div class="stat-value" id="newCount">–</div>
              <div class="stat-desc">Önceki listeye göre</div>
            </div>
            <div class="stat-card updated">
              <div class="stat-label"><i class="fas fa-user-edit"></i> Güncel</div>
              <div class="stat-value" id="updatedCount">–</div>
              <div class="stat-desc">Bilgisi değişenler</div>
            </div>
            <div class="stat-card removed">
              <div class="stat-label"><i class="fas fa-user-minus"></i> Silinen</div>
              <div class="stat-value" id="removedCount">–</div>
              <div class="stat-desc">Listeden düşenler</div>
            </div>
          </div>
          
          <div class="change-lists">
            <details>
              <summary><i class="fas fa-user-plus"></i> Yeni Kayıtlar <span class="status-badge new" id="newTagCount" style="margin-left:auto">0</span></summary>
              <ul id="newList"></ul>
            </details>
            <details>
              <summary><i class="fas fa-user-edit"></i> Güncellenenler <span class="status-badge updated" id="updatedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="updatedList"></ul>
            </details>
            <details>
              <summary><i class="fas fa-user-minus"></i> Silinenler <span class="status-badge normal" id="removedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="removedList"></ul>
            </details>
          </div>
        </section>

        <section class="panel">
          <div class="panel-title">
            <span><i class="fas fa-filter"></i> Filtreleme</span>
            <button class="btn btn-secondary btn-sm" id="clearFiltersBtn" type="button"><i class="fas fa-eraser"></i> Temizle</button>
          </div>
          
          <div class="filters-stack">
            <div class="field-group">
              <div class="field-label">Genel Arama <span>Aranacak tüm alanlar</span></div>
              <input type="text" id="searchInput" placeholder="İsim, No, Veli, Sınıf..." />
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div class="field-group">
                <div class="field-label">Cinsiyet</div>
                <select id="genderFilter">
                  <option value="">Tümü</option>
                  <option value="KIZ">Kız</option>
                  <option value="ERKEK">Erkek</option>
                </select>
              </div>
              <div class="field-group">
                <div class="field-label">Burs Durumu</div>
                <select id="scholarFilter">
                  <option value="">Tümü</option>
                  <option value="nonempty">Burslu</option>
                  <option value="empty">Burssuz</option>
                </select>
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">Kayıt Durumu</div>
              <select id="statusFilter">
                <option value="">Tüm Durumlar</option>
                <option value="new">Sadece Yeni</option>
                <option value="updated">Güncellenenler</option>
                <option value="normal">Değişiklik Yok</option>
              </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div class="field-group">
                <div class="field-label">Başlangıç Tarihi</div>
                <input type="date" id="dateFrom" />
              </div>
              <div class="field-group">
                <div class="field-label">Bitiş Tarihi</div>
                <input type="date" id="dateTo" />
              </div>
            </div>

            <div class="field-group">
                <div class="field-label">Sıralama Seçenekleri</div>
                <select id="generalSortOrder">
                    <option value="">Otomatik (Durum Öncelikli)</option>
                    <option value="name_asc">İsim (A → Z)</option>
                    <option value="name_desc">İsim (Z → A)</option>
                    <option value="num_asc">Numara (Küçük → Büyük)</option>
                    <option value="num_desc">Numara (Büyük → Küçük)</option>
                    <option value="date_desc">Tarih (Yeniden → Eskiye)</option>
                    <option value="date_asc">Tarih (Eskiden → Yeniye)</option>
                </select>
            </div>

            <div class="field-group">
              <div class="field-label">Sınıflar</div>
              <div id="classFilterContainer" class="class-chips"></div>
            </div>

            <div class="field-group">
              <label style="display:flex; gap:10px; align-items:center; font-size:14px; cursor:pointer; color: var(--text-secondary);">
                <input type="checkbox" id="recentOnly" style="width:18px; height:18px; accent-color: var(--primary);" />
                <span>Sadece son 30 kayıt</span>
              </label>
            </div>
            
            <hr style="border:0; border-top:1px solid var(--border); width:100%;">
            
            <div style="display:flex; flex-direction:column; gap:12px;">
               <button class="btn btn-primary" id="reloadBtn" type="button">
                 <i class="fas fa-sync-alt"></i> Verileri Yenile
               </button>
            </div>
          </div>
        </section>

      </div>

      <div class="table-tools-container">
        
        <div class="toolbar-header">
          <div class="table-toolbar-left" style="display:flex; flex-direction:column; gap:12px;">
            <div class="sheet-tabs" id="sheetTabs"></div>
            <div class="view-toggles">
              <button type="button" data-view="all" class="active" id="viewAllBtn"><i class="fas fa-list"></i> Tüm Liste</button>
              <button type="button" data-view="new-updated" id="viewNewUpdatedBtn"><i class="fas fa-star"></i> Değişiklikler</button>
            </div>
          </div>
          
          <div class="table-toolbar-right" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary btn-sm no-print" id="saveSnapshotBtn">
              <i class="fas fa-save"></i> Kaydet
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="downloadTxtBtn">
              <i class="fas fa-download"></i> İndir (TXT)
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="uploadTxtBtn">
              <i class="fas fa-upload"></i> Karşılaştır
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="printBtn">
              <i class="fas fa-print"></i> Yazdır
            </button>
          </div>
        </div>

        <div style="padding: 12px 28px; background: var(--info-bg); border-bottom: 1px solid var(--border); font-size:13px; color:var(--info); display: flex; align-items: center; gap: 8px;" id="listStatusBar">
          <i class="fas fa-info-circle"></i>
          <span>Yükleniyor...</span>
        </div>

        <input type="file" id="uploadTxtInput" accept=".txt,.json" style="display:none;" />
        
        <div class="no-print" style="padding: 16px 28px; background: var(--bg-body); border-bottom: 1px solid var(--border);">
            <details>
                <summary style="font-size:13px; color:var(--text-muted); cursor:pointer; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-print"></i> Yazdırma Sütunlarını Seç
                </summary>
                <div class="cols" id="printColsContainer" style="display:flex; flex-wrap:wrap; gap:16px; padding-top:16px; font-size:14px;"></div>
            </details>
        </div>

        <div class="table-scroll-area">
          <table id="studentsTable">
            <thead>
              <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="tableBody">
              <tr class="loading-row">
                <td colspan="12" style="text-align:center; padding: 60px;">
                  <div style="display:flex; flex-direction:column; align-items:center; gap:16px;">
                    <div class="loading-shimmer" style="width:40px; height:40px; border-radius:var(--radius-full);"></div>
                    <div style="color:var(--text-muted); font-size:14px;">Veriler yükleniyor...</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div style="padding: 16px 28px; background: var(--bg-body); border-top: 1px solid var(--border); font-size:13px; color:var(--text-muted); display: flex; justify-content: space-between; align-items: center;">
          <span id="lastSavedInfo">Detay için satıra tıklayın.</span>
          <span>Çift tıklama ile hücre kopyalanır</span>
        </div>

      </div>

    </div>
  </div>

  <div class="toast" id="toast">
    <span style="font-size: 18px;"><i class="fas fa-check-circle"></i></span>
    <span id="toastMessage">İşlem başarılı.</span>
  </div>

  <div class="modal-overlay" id="studentDetailModal">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">Öğrenci Detayı</div>
            <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modalContent">
            <!-- Modal içeriği buraya gelecek -->
        </div>
    </div>
  </div>

  <script type="module">
    // =======================
    // KONFİGÜRASYON
    // =======================
    const SHEET_ID = "16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi";

    const SHEET_TABS = [
      { name: "2025-2026", label: "2025-2026 Dönemi" }
    ];

    let currentSheetName = SHEET_TABS[0].name;
    const STORAGE_KEY_BASE = "ogrenci_listesi_snapshot_v3_";

    const COLUMNS = [
      { key: "status",   label: "DURUM" },
      { key: "isim",     label: "İSİM" },
      { key: "soyisim",  label: "SOYİSİM" },
      { key: "cinsiyet", label: "CİNSİYET" },
      { key: "sinif",    label: "SINIF" },
      { key: "okulNo",   label: "OKUL NO" },
      { key: "veliAdi",  label: "VELİ ADI" },
      { key: "veliSoyadi", label: "VELİ SOYADI" },
      { key: "veliTelefon", label: "VELİ TELEFON" },
      { key: "yil",      label: "YIL" },
      { key: "tarih",    label: "TARİH" },
      { key: "burslu",   label: "BURSLU MU?" }
    ];

    let students = [];
    let snapshot = null;
    let snapshotSource = "none"; 
    let activeViewMode = "all";  

    // =======================
    // FIREBASE
    // =======================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const firebaseAnalytics = getAnalytics(firebaseApp);
    const firebaseDb = getDatabase(firebaseApp);
    const FIREBASE_BASE_PATH = 'snapshots';

    // =======================
    // ARAÇLAR
    // =======================
    function getSheetCsvUrl(sheetName) {
      return "https://docs.google.com/spreadsheets/d/" +
        SHEET_ID +
        "/gviz/tq?tqx=out:csv&sheet=" +
        encodeURIComponent(sheetName);
    }

    function getSnapshotRef() {
      const name = currentSheetName || 'default';
      const safeName = encodeURIComponent(name);
      return ref(firebaseDb, `${FIREBASE_BASE_PATH}/${safeName}`);
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      document.getElementById("toastMessage").textContent = message;
      toast.classList.add("visible");
      setTimeout(() => toast.classList.remove("visible"), 3000);
    }

    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];
        if (c === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
        } else if (c === '"') {
          inQuotes = !inQuotes;
        } else if (c === "," && !inQuotes) {
          currentRow.push(current);
          current = "";
        } else if ((c === "\n" || c === "\r") && !inQuotes) {
          if (current !== "" || currentRow.length > 0) {
            currentRow.push(current);
            rows.push(currentRow);
            currentRow = [];
            current = "";
          }
        } else {
          current += c;
        }
      }
      if (current !== "" || currentRow.length > 0) {
        currentRow.push(current);
        rows.push(currentRow);
      }
      return rows.filter(r => r.length > 0);
    }

    function parseDateTR(str) {
      if (!str) return null;
      const parts = str.trim().split(".");
      if (parts.length !== 3) return null;
      const [g, a, y] = parts.map(p => parseInt(p, 10));
      if (isNaN(g) || isNaN(a) || isNaN(y)) return null;
      return new Date(y, a - 1, g);
    }

    function formatDateTimeForBadge(isoString) {
      if (!isoString) return "–";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "–";
      return d.toLocaleDateString("tr-TR", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    function createStudentId(row) {
      const num = (row.okulNo || "").trim();
      const name = (row.isim || "").trim().toUpperCase();
      const surname = (row.soyisim || "").trim().toUpperCase();
      if (num) return `${num}__${name}__${surname}`;
      return `${name}__${surname}`;
    }

    function normalizePhone(str) {
      return String(str || "").replace(/\D+/g, "");
    }

    function findPrevMatchForStudent(student, prevMap) {
      if (!prevMap) return null;

      const phone = normalizePhone(student.veliTelefon);
      if (!phone || phone.length < 8) return null;

      const candidates = [];
      for (const prevId in prevMap) {
        const d = (prevMap[prevId] && prevMap[prevId].data) ? prevMap[prevId].data : null;
        if (!d) continue;
        const p = normalizePhone(d.veliTelefon);
        if (p && p === phone) candidates.push(prevId);
      }
      if (!candidates.length) return null;

      const cls = String(student.sinif || "").trim();
      let filtered = candidates;
      if (cls) {
        const byClass = candidates.filter(pid => String(prevMap[pid].data.sinif || "").trim() === cls);
        if (byClass.length) filtered = byClass;
      }

      const n = String(student.isim || "").trim().toUpperCase();
      const s = String(student.soyisim || "").trim().toUpperCase();
      const score = (pid) => {
        const d = prevMap[pid].data || {};
        const pn = String(d.isim || "").trim().toUpperCase();
        const ps = String(d.soyisim || "").trim().toUpperCase();
        let sc = 0;
        if (pn === n) sc += 5;
        else if (pn && n && (pn.includes(n) || n.includes(pn))) sc += 2;
        if (ps === s) sc += 5;
        else if (ps && s && (ps.includes(s) || s.includes(ps))) sc += 2;
        const on = String(student.okulNo || "").trim();
        const pon = String(d.okulNo || "").trim();
        if (on && pon && on === pon) sc += 1;
        return sc;
      };

      filtered.sort((a, b) => {
        const sa = score(a);
        const sb = score(b);
        if (sb !== sa) return sb - sa;
        return String(a).localeCompare(String(b));
      });

      return filtered[0] || null;
    }

    function deepEqual(a, b) {
      if (a === null || b === null || typeof a !== 'object' || typeof b !== 'object') {
        return a === b;
      }
      const keysA = Object.keys(a).sort();
      const keysB = Object.keys(b).sort();
      if (keysA.length !== keysB.length) return false;
      for (let i = 0; i < keysA.length; i++) {
        const keyA = keysA[i];
        const keyB = keysB[i];
        if (keyA !== keyB) return false;
        const valA = a[keyA];
        const valB = b[keyB];
        if (valA === null || valB === null || typeof valA !== 'object' || typeof valB !== 'object') {
          if (valA !== valB) return false;
        } else {
          if (!deepEqual(valA, valB)) return false;
        }
      }
      return true;
    }

    // =======================
    // SNAPSHOT LOGIC
    // =======================
    function buildSnapshotObject(currentStudents) {
      const records = {};
      currentStudents.forEach(s => {
        records[s.id] = {
          id: s.id,
          data: {
            isim: s.isim, soyisim: s.soyisim, cinsiyet: s.cinsiyet,
            sinif: s.sinif, okulNo: s.okulNo, veliAdi: s.veliAdi,
            veliSoyadi: s.veliSoyadi, veliTelefon: s.veliTelefon,
            yil: s.yil, tarih: s.tarih, burslu: s.burslu
          }
        };
      });
      return {
        savedAt: new Date().toISOString(),
        sheetName: currentSheetName,
        records
      };
    }

    function updateSnapshotLabels() {
      const compareLabel = document.getElementById("compareSourceLabel");

      if (!snapshot) {
        compareLabel.textContent = "Karşılaştırma: Yok";
        return;
      }

      if (snapshotSource === "firebase") {
        compareLabel.textContent = "Karşılaştırma: Firebase DB";
      } else if (snapshotSource === "file") {
        compareLabel.textContent = "Karşılaştırma: TXT Dosyası";
      } else {
        compareLabel.textContent = "Karşılaştırma: Yok";
      }
    }

    async function loadSnapshot() {
      try {
        const snapRef = getSnapshotRef();
        const snapData = await get(snapRef);
        if (!snapData.exists()) {
          snapshot = null;
          snapshotSource = "none";
          updateSnapshotLabels();
          return;
        }
        snapshot = snapData.val();
        snapshotSource = "firebase";
        updateSnapshotLabels();
      } catch (e) {
        console.error("Snapshot yüklenemedi", e);
        snapshot = null;
        snapshotSource = "none";
        updateSnapshotLabels();
      }
    }

    async function saveSnapshot(currentStudents) {
      const snap = buildSnapshotObject(currentStudents);
      try {
        const snapRef = getSnapshotRef();
        await set(snapRef, snap);
        snapshot = snap;
        snapshotSource = "firebase";
        updateSnapshotLabels();
        showToast("Liste Firebase'e başarıyla kaydedildi.");
      } catch (e) {
        console.error("Snapshot kaydedilemedi", e);
        showToast("Hata: Kayıt yapılamadı.");
      }
    }

    function applySnapshotFromFile(obj) {
      if (!obj || !obj.records) {
        showToast("Hatalı dosya formatı.");
        return;
      }
      snapshot = obj;
      snapshotSource = "file";
      updateSnapshotLabels();
      showToast("TXT yüklendi, karşılaştırma yapılıyor.");
      loadData();
    }

    // =======================
    // VERİ YÜKLEME
    // =======================
    async function loadData() {
      const body = document.getElementById("tableBody");
      body.innerHTML = '<tr class="loading-row"><td colspan="12" style="text-align:center; padding:60px;"><div style="display:flex; flex-direction:column; align-items:center; gap:16px;"><div class="loading-shimmer" style="width:40px; height:40px; border-radius:var(--radius-full);"></div><div style="color:var(--text-muted); font-size:14px;">Google Tablo\'dan veriler alınıyor...</div></div></td></tr>';
      document.getElementById("lastLoadedInfo").textContent = "Yükleniyor...";

      try {
        const url = getSheetCsvUrl(currentSheetName);
        const res = await fetch(url);
        if (!res.ok) throw new Error("Ağ hatası: " + res.status);
        const text = await res.text();

        if (text.startsWith("<")) throw new Error("CSV yerine HTML geldi. Tablo yayın ayarlarını kontrol edin.");

        const rows = parseCSV(text);
        if (!rows.length) {
          body.innerHTML = '<tr class="loading-row"><td colspan="12">Tablo boş.</td></tr>';
          updateListStatus([]);
          return;
        }

        const header = rows[0].map(h => h.trim());
        const dataRows = rows.slice(1).filter(r => r.some(cell => cell.trim() !== ""));

        const headerIndex = name => header.indexOf(name);
        const idxIsim = headerIndex("İsim") === -1 ? 0 : headerIndex("İsim");
        const idxSoy = headerIndex("Soyisim*");
        const idxCins = headerIndex("Cinsiyet*");
        const idxSinif = headerIndex("Sınıf");
        const idxOkulNo = headerIndex("Okul Numarası");
        const idxVeliAd = headerIndex("Veli Adı");
        const idxVeliSoy = headerIndex("Veli Soyadı");
        const idxVeliTel = headerIndex("Veli Telefon");
        const idxYil = headerIndex("YIL");
        const idxTarih = headerIndex("Tarih");
        const idxBurs = headerIndex("Burslu mu?");

        const parsed = dataRows.map(row => {
          const s = {
            isim: (row[idxIsim] || "").trim(),
            soyisim: (row[idxSoy] || "").trim(),
            cinsiyet: (row[idxCins] || "").trim().toUpperCase(),
            sinif: (row[idxSinif] || "").trim(),
            okulNo: (row[idxOkulNo] || "").trim(),
            veliAdi: (row[idxVeliAd] || "").trim(),
            veliSoyadi: (row[idxVeliSoy] || "").trim(),
            veliTelefon: (row[idxVeliTel] || "").trim(),
            yil: (row[idxYil] || "").trim(),
            tarih: (row[idxTarih] || "").trim(),
            burslu: (row[idxBurs] || "").trim()
          };
          s.id = createStudentId(s);
          s.dateObj = parseDateTR(s.tarih);
          s.status = "normal";
          return s;
        });

        let removed = [];
        if (snapshot && snapshot.records) {
          const prevMap = snapshot.records;
          const currentIds = new Set(parsed.map(s => s.id));
          const matchedPrevIds = new Set();

          parsed.forEach(s => {
            const prev = prevMap[s.id];
            let comparePrevId = null;

            if (!prev) {
              comparePrevId = findPrevMatchForStudent(s, prevMap);
              if (comparePrevId) {
                matchedPrevIds.add(comparePrevId);
                s.status = "updated";
                s._comparePrevId = comparePrevId;
              } else {
                s.status = "new";
                return;
              }
            } else {
              comparePrevId = s.id;
            }

            const prevData = prevMap[comparePrevId].data;
            const currentSlim = {
              isim: s.isim, soyisim: s.soyisim, cinsiyet: s.cinsiyet,
              sinif: s.sinif, okulNo: s.okulNo, veliAdi: s.veliAdi,
              veliSoyadi: s.veliSoyadi, veliTelefon: s.veliTelefon,
              yil: s.yil, tarih: s.tarih, burslu: s.burslu
            };

            if (!deepEqual(prevData, currentSlim)) {
              s.status = "updated";
              s._comparePrevId = comparePrevId;
            } else {
              if (!s._comparePrevId) s.status = "normal";
            }
          });

          for (const prevId in prevMap) {
            if (!currentIds.has(prevId) && !matchedPrevIds.has(prevId)) {
              removed.push(prevMap[prevId]);
            }
          }
        }

        students = parsed;
        renderHeader();
        populateFilters();
        updateSummary(removed);
        applyFilters(removed);
        document.getElementById("lastLoadedInfo").textContent = `${currentSheetName} | ${formatDateTimeForBadge(new Date().toISOString())}`;
        
      } catch (err) {
        console.error(err);
        body.innerHTML = `<tr class="loading-row"><td colspan="12" style="color:var(--danger); text-align:center; padding:40px;"><i class="fas fa-exclamation-triangle"></i> Hata: ${err.message}</td></tr>`;
        document.getElementById("lastLoadedInfo").textContent = "Hata oluştu.";
        updateListStatus([]);
      }
    }

    // =======================
    // UI RENDER
    // =======================
    function renderSheetTabs() {
      const container = document.getElementById("sheetTabs");
      container.innerHTML = "";
      SHEET_TABS.forEach(tab => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sheet-tab";
        if (tab.name === currentSheetName) btn.classList.add("active");
        btn.textContent = tab.label;
        btn.addEventListener("click", async () => {
          if (currentSheetName === tab.name) return;
          currentSheetName = tab.name;
          await loadSnapshot();
          renderSheetTabs();
          await loadData();
        });
        container.appendChild(btn);
      });
    }

    function renderHeader() {
      const headerRow = document.getElementById("tableHeaderRow");
      headerRow.innerHTML = "";
      COLUMNS.forEach((col, index) => {
        const th = document.createElement("th");
        th.textContent = col.label;
        th.dataset.field = col.key;
        headerRow.appendChild(th);
      });

      const printContainer = document.getElementById("printColsContainer");
      printContainer.innerHTML = "";
      COLUMNS.forEach(col => {
        const id = "print-col-" + col.key;
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "8px";
        label.style.cursor = "pointer";
        label.style.color = "var(--text-secondary)";
        label.innerHTML = `
          <input type="checkbox" id="${id}" data-field="${col.key}" checked />
          <span>${col.label}</span>
        `;
        printContainer.appendChild(label);
      });
    }

    function populateFilters() {
      const container = document.getElementById("classFilterContainer");
      const classes = Array.from(new Set(students.map(s => s.sinif).filter(Boolean))).sort();
      container.innerHTML = "";
      classes.forEach(cls => {
        const id = "class-filter-" + cls.replace(/\s+/g, "_");
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" value="${cls}">
          <span>${cls}</span>
        `;
        container.appendChild(label);
      });
    }

    function getSelectedClasses() {
      const boxes = document.querySelectorAll("#classFilterContainer input[type='checkbox']");
      const selected = [];
      boxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
      return selected;
    }

    function updateSummary(removedRecords = []) {
      const total = students.length;
      const newCount = students.filter(s => s.status === "new").length;
      const updatedCount = students.filter(s => s.status === "updated").length;
      const removedCount = removedRecords.length;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("newCount").textContent = newCount;
      document.getElementById("updatedCount").textContent = updatedCount;
      document.getElementById("removedCount").textContent = removedCount;

      document.getElementById("newTagCount").textContent = newCount;
      document.getElementById("updatedTagCount").textContent = updatedCount;
      document.getElementById("removedTagCount").textContent = removedCount;

      const fillList = (listId, items, isRemoved = false) => {
        const el = document.getElementById(listId);
        el.innerHTML = "";
        items.forEach(s => {
          const d = isRemoved ? (s.data || {}) : s;
          const li = document.createElement("li");
          li.innerHTML = `<b>${d.okulNo || "?"}</b> ${d.isim} ${d.soyisim} <small>(${d.sinif})</small>`;
          el.appendChild(li);
        });
      };

      fillList("newList", students.filter(s => s.status === "new"));
      fillList("updatedList", students.filter(s => s.status === "updated"));
      fillList("removedList", removedRecords, true);
    }

    function updateListStatus(filteredRows) {
      const bar = document.getElementById("listStatusBar");
      if (!bar) return;
      const visible = filteredRows ? filteredRows.length : 0;
      const total = students.length;
      const recentOnly = document.getElementById("recentOnly").checked;
      
      let msg = `Toplam <strong>${total}</strong> kayıt içinden <strong>${visible}</strong> tanesi görüntüleniyor.`;
      if (recentOnly && visible >= 30) msg += " (Son 30 kayıt filtresi aktif)";
      
      const barText = bar.querySelector("span");
      if (barText) barText.innerHTML = msg;
    }

    function applyFilters(removedRecords = []) {
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
      const genderVal = document.getElementById("genderFilter").value;
      const scholarVal = document.getElementById("scholarFilter").value;
      const statusVal = document.getElementById("statusFilter").value;
      const recentOnly = document.getElementById("recentOnly").checked;
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;
      const selectedClasses = getSelectedClasses();
      const sortOrder = document.getElementById("generalSortOrder") ? document.getElementById("generalSortOrder").value : "";

      let fromDate = null;
      let toDate = null;
      if (dateFromVal) fromDate = new Date(dateFromVal + "T00:00:00");
      if (dateToVal)    toDate    = new Date(dateToVal    + "T23:59:59");

      let filtered = students.slice();

      filtered = filtered.filter(s => {
        if (activeViewMode === "new-updated" && !(s.status === "new" || s.status === "updated")) return false;
        if (statusVal) {
          if (statusVal === "normal" && s.status !== "normal") return false;
          if (statusVal === "new" && s.status !== "new") return false;
          if (statusVal === "updated" && s.status !== "updated") return false;
        }
        if (selectedClasses.length && !selectedClasses.includes(s.sinif)) return false;
        if (genderVal && s.cinsiyet !== genderVal) return false;
        if (scholarVal === "nonempty" && !s.burslu) return false;
        if (scholarVal === "empty" && s.burslu) return false;
        if (fromDate && s.dateObj && s.dateObj < fromDate) return false;
        if (toDate && s.dateObj && s.dateObj > toDate) return false;
        
        if (searchText) {
          const combined = Object.values(s).join(" ").toLowerCase();
          if (!combined.includes(searchText)) return false;
        }
        return true;
      });

      const statusOrder = { new: 0, updated: 1, normal: 2 };
      
      filtered.sort((a, b) => {
        if (sortOrder === "name_asc") return a.isim.localeCompare(b.isim, 'tr');
        if (sortOrder === "name_desc") return b.isim.localeCompare(a.isim, 'tr');

        if (sortOrder === "num_asc") return parseInt(a.okulNo || "0") - parseInt(b.okulNo || "0");
        if (sortOrder === "num_desc") return parseInt(b.okulNo || "0") - parseInt(a.okulNo || "0");

        if (sortOrder === "date_asc" || sortOrder === "date_desc") {
            const da = a.dateObj ? a.dateObj.getTime() : 0;
            const db = b.dateObj ? b.dateObj.getTime() : 0;
            return sortOrder === "date_desc" ? db - da : da - db;
        }

        const sa = statusOrder[a.status] ?? 2;
        const sb = statusOrder[b.status] ?? 2;
        if (sa !== sb) return sa - sb;
        return parseInt(b.okulNo || "0") - parseInt(a.okulNo || "0");
      });

      if (recentOnly && filtered.length > 30) filtered = filtered.slice(0, 30);

      renderTable(filtered);
      updateSummary(removedRecords);
      updateListStatus(filtered);
    }

    function renderTable(rows) {
      const body = document.getElementById("tableBody");
      body.innerHTML = "";

      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:40px; color:var(--text-muted)"><i class="fas fa-search" style="margin-right:8px;"></i>Eşleşen kayıt bulunamadı.</td></tr>';
        return;
      }

      rows.forEach(s => {
        const tr = document.createElement("tr");
        if (s.status === "new") tr.classList.add("new-row");
        if (s.status === "updated") tr.classList.add("updated-row");

        COLUMNS.forEach((col, index) => {
          const td = document.createElement("td");
          td.dataset.field = col.key;
          
          if (col.key === "status") {
            const span = document.createElement("span");
            if (s.status === "new") {
              span.className = "status-badge new";
              span.innerHTML = `<i class="fas fa-star"></i> YENİ`;
            } else if (s.status === "updated") {
              span.className = "status-badge updated";
              span.innerHTML = `<i class="fas fa-edit"></i> GÜNCEL`;
            } else {
              span.className = "status-badge normal";
              span.innerHTML = `<i class="fas fa-check"></i> NORMAL`;
            }
            td.appendChild(span);
          } else {
              if (col.key === "veliTelefon" && s[col.key]) {
                td.innerHTML = `<span style="opacity:0.8">${s[col.key]}</span>`;
              } else {
                td.textContent = s[col.key] || "";
              }
          }
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
      syncPrintColumnVisibility();
    }

    function syncPrintColumnVisibility() {
      const rows = document.querySelectorAll("#studentsTable tr");
      const checkboxes = document.querySelectorAll("#printColsContainer input[type='checkbox']");
      const hiddenFields = new Set();
      checkboxes.forEach(cb => {
        if (!cb.checked) hiddenFields.add(cb.dataset.field);
      });

      rows.forEach(tr => {
        Array.from(tr.children).forEach(cell => {
          const field = cell.dataset.field;
          if (!field) return;
          cell.style.display = hiddenFields.has(field) ? "none" : "";
        });
      });
    }

    // =======================
    // INIT & EVENTS
    // =======================
    function setupEventListeners() {
      const ids = ["searchInput", "genderFilter", "scholarFilter", "statusFilter", "dateFrom", "dateTo", "recentOnly", "generalSortOrder"];
      ids.forEach(id => {
          const el = document.getElementById(id);
          if(el) el.addEventListener("input", () => applyFilters());
      });
      
      document.getElementById("classFilterContainer").addEventListener("change", () => applyFilters());

      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                if(el.type==='checkbox') el.checked=false; else el.value="";
            }
        });
        document.querySelectorAll("#classFilterContainer input").forEach(cb => cb.checked=false);
        applyFilters();
      });

      document.getElementById("reloadBtn").addEventListener("click", () => loadData());
      document.getElementById("saveSnapshotBtn").addEventListener("click", () => saveSnapshot(students));
      document.getElementById("printBtn").addEventListener("click", () => {
        const d = new Date();
        document.getElementById("printDateInfo").textContent = "Rapor Tarihi: " + d.toLocaleDateString("tr-TR") + " " + d.toLocaleTimeString("tr-TR");
        
        syncPrintColumnVisibility();
        window.print();
      });
      document.getElementById("printColsContainer").addEventListener("change", syncPrintColumnVisibility);

      document.getElementById("viewAllBtn").addEventListener("click", (e) => {
        activeViewMode = "all";
        document.querySelectorAll(".view-toggles button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        applyFilters();
      });

      document.getElementById("viewNewUpdatedBtn").addEventListener("click", (e) => {
        activeViewMode = "new-updated";
        document.querySelectorAll(".view-toggles button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        applyFilters();
      });

      // Tek Tıklama (DURUM sütununda Modal açar)
      document.getElementById("tableBody").addEventListener("click", e => {
        const tr = e.target.closest("tr");
        const td = e.target.closest("td");
        
        if (!tr || tr.classList.contains("loading-row") || !td) return;

        if (td.dataset.field !== "status") return;
        
        const noCell = tr.querySelector('[data-field="okulNo"]');
        if(!noCell) return;
        const rowOkulNo = noCell.textContent.trim();
        const nameCell = tr.querySelector('[data-field="isim"]');
        const rowName = nameCell ? nameCell.textContent.trim() : "";

        const student = students.find(s => s.okulNo == rowOkulNo && s.isim == rowName);
        if(student) openStudentModal(student);
      });

      // Çift Tıklama (hücre kopyalama)
      document.getElementById("tableBody").addEventListener("dblclick", async e => {
        const td = e.target.closest("td");
        if (!td) return;

        if (td.dataset.field === "status") return;

        const text = td.textContent.trim();
        if (!text) return;

        try {
          await navigator.clipboard.writeText(text);
          showToast(`Kopyalandı: ${text}`);
        } catch (err) {
          console.error("Kopyalama hatası:", err);
        }
      });
      
      // Modal dışına tıklayınca kapat
      document.getElementById("studentDetailModal").addEventListener("click", (e) => {
        if(e.target === document.getElementById("studentDetailModal")) closeModal();
      });

      // TXT İndir
      document.getElementById("downloadTxtBtn").addEventListener("click", () => {
        if (!students.length) return showToast("Liste boş.");
        const snap = buildSnapshotObject(students);
        const blob = new Blob([JSON.stringify(snap, null, 2)], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `liste_${currentSheetName}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("TXT İndirildi.");
      });

      // TXT Yükle
      const uploadInput = document.getElementById("uploadTxtInput");
      document.getElementById("uploadTxtBtn").addEventListener("click", () => {
        uploadInput.value = "";
        uploadInput.click();
      });
      uploadInput.addEventListener("change", e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            applySnapshotFromFile(JSON.parse(reader.result));
          } catch(err) { showToast("Dosya okunamadı."); }
        };
        reader.readAsText(file);
      });
    }

    // Modal Fonksiyonları
    window.closeModal = function() {
      document.getElementById("studentDetailModal").classList.remove("active");
    };

    function openStudentModal(s) {
      const modal = document.getElementById("studentDetailModal");
      const content = document.getElementById("modalContent");
      
      let statusHtml = "";
      let diffHtml = "";

      if (s.status === "new") {
        statusHtml = `<span class="status-badge new" style="font-size:14px; padding:8px 16px;"><i class="fas fa-user-plus"></i> Yeni Kayıt</span>`;
        diffHtml = `<div class="change-log-box" style="background:var(--success-light); border-color:var(--success); color:var(--success);"><i class="fas fa-info-circle"></i> Bu öğrenci listeye yeni eklendi.</div>`;
      } else if (s.status === "updated") {
        statusHtml = `<span class="status-badge updated" style="font-size:14px; padding:8px 16px;"><i class="fas fa-user-edit"></i> Bilgileri Güncellendi</span>`;
        
        if (snapshot && snapshot.records && snapshot.records[(s._comparePrevId || s.id)]) {
            const oldData = snapshot.records[(s._comparePrevId || s.id)].data;
            const changes = [];
            const fields = {
                isim: "İsim",
                soyisim: "Soyisim",
                sinif: "Sınıf",
                okulNo: "Okul No",
                cinsiyet: "Cinsiyet",
                veliAdi: "Veli Adı",
                veliSoyadi: "Veli Soyadı",
                veliTelefon: "Veli Tel",
                yil: "Yıl",
                tarih: "Kayıt Tarihi",
                burslu: "Burs Durumu"
            };
            
            for(let key in fields) {
                const oldVal = String(oldData[key] || "").trim();
                const newVal = String(s[key] || "").trim();
                
                if(oldVal !== newVal) {
                    changes.push(`<b>${fields[key]}:</b> <br/> <span style="color:var(--danger); text-decoration:line-through; font-size:12px;">${oldVal || '(Boş)'}</span> <span style="margin:0 4px">→</span> <span style="color:var(--success); font-weight:600;">${newVal}</span>`);
                }
            }
            if(changes.length > 0) {
                diffHtml = `<div class="change-log-box">
                    <div style="font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:8px;"><i class="fas fa-exchange-alt"></i> Tespit Edilen Değişiklikler:</div>
                    <ul style="margin:0; padding-left:20px; display:flex; flex-direction:column; gap:8px;">${changes.map(c => `<li>${c}</li>`).join('')}</ul>
                </div>`;
            } else {
                diffHtml = `<div class="change-log-box"><i class="fas fa-exclamation-circle"></i> Görünürde değişiklik algılandı ancak biçimsel olabilir.</div>`;
            }
        }
      } else {
        statusHtml = `<span class="status-badge normal" style="font-size:14px; padding:8px 16px;"><i class="fas fa-user-check"></i> Kayıtlı Öğrenci</span>`;
      }

      content.innerHTML = `
        <div style="text-align:center; margin-bottom:24px;">
            <div style="font-size:28px; font-weight:800; color:var(--text-main); margin-bottom:4px;">${s.isim} ${s.soyisim}</div>
            <div style="font-size:15px; color:var(--text-muted);">${s.okulNo} | ${s.sinif}</div>
            <div style="margin-top:16px;">${statusHtml}</div>
        </div>

        <div class="detail-row"><span class="detail-label">Sınıf:</span> <span class="detail-val">${s.sinif}</span></div>
        <div class="detail-row"><span class="detail-label">Cinsiyet:</span> <span class="detail-val">${s.cinsiyet}</span></div>
        <div class="detail-row"><span class="detail-label">Veli Adı:</span> <span class="detail-val">${s.veliAdi} ${s.veliSoyadi}</span></div>
        <div class="detail-row"><span class="detail-label">Veli Telefon:</span> <span class="detail-val">${s.veliTelefon || "-"}</span></div>
        <div class="detail-row"><span class="detail-label">Kayıt Tarihi:</span> <span class="detail-val">${s.tarih || "-"}</span></div>
        <div class="detail-row"><span class="detail-label">Burs Durumu:</span> <span class="detail-val">${s.burslu ? "<span style='color:var(--success);'><i class='fas fa-award'></i> Burslu</span>" : "Normal"}</span></div>
        
        ${diffHtml}
      `;
      
      modal.classList.add("active");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      renderSheetTabs();
      setupEventListeners();
      await loadSnapshot();
      await loadData();
    });
  </script>
</body>
</html>

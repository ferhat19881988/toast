<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ã–ÄŸrenci Listesi YÃ¶neticisi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Modern Renk Paleti */
      --primary: #4f46e5;        /* Indigo 600 */
      --primary-dark: #4338ca; /* Indigo 700 */
      --primary-light: #e0e7ff;/* Indigo 100 */
      
      --bg-body: #f1f5f9;       /* Slate 100 */
      --bg-card: #ffffff;
      
      --text-main: #0f172a;     /* Slate 900 */
      --text-muted: #64748b;    /* Slate 500 */
      
      --border: #e2e8f0;        /* Slate 200 */
      
      /* Durum Renkleri */
      --success-bg: #dcfce7;
      --success-text: #166534;
      --warning-bg: #fef9c3;
      --warning-text: #854d0e;
      --danger-bg: #fee2e2;
      --danger-text: #991b1b;

      /* GÃ¶lgeler */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }

    /* Layout & Shell */
    .app-shell {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Header */
    header.app-header {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px 32px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .app-title-block h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-title-block h1 span.icon { 
      background: var(--primary-light);
      color: var(--primary);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      font-size: 24px;
    }

    .app-title-block p {
      margin: 4px 0 0 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .header-meta {
      display: flex;
      gap: 12px;
    }

    .chip {
      background: var(--bg-body);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Print Header (VarsayÄ±lan Gizli) */
    .print-title-block { display: none; }

    /* Main Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* Panels */
    .panel {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      height: 100%;
    }

    .panel-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-body);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .stat-card:hover { transform: translateY(-2px); }

    .stat-card.total { background: #f8fafc; border-color: #cbd5e1; grid-column: 1 / -1; }
    .stat-card.new { background: var(--success-bg); color: var(--success-text); }
    .stat-card.updated { background: var(--warning-bg); color: var(--warning-text); }
    .stat-card.removed { background: var(--danger-bg); color: var(--danger-text); }

    .stat-label { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }
    .stat-value { font-size: 32px; font-weight: 700; margin: 4px 0; line-height: 1; }
    .stat-desc { font-size: 12px; opacity: 0.7; }

    /* Filter Inputs */
    .filters-stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .field-group { display: flex; flex-direction: column; gap: 6px; }
    
    .field-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      background: #fff;
      transition: all 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Class Chips */
    .class-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 4px 0;
    }

    .class-chips label {
      cursor: pointer;
      user-select: none;
    }
    
    .class-chips input[type="checkbox"] { display: none; }
    
    .class-chips span {
      display: inline-block;
      padding: 6px 12px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .class-chips input:checked + span {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* --- GÃœNCELLEME 1: HOVER EFEKTLERÄ° --- */
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

    .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

    .btn-sm { padding: 6px 12px; font-size: 13px; }

    /* Changes Accordion */
    .change-lists details {
      background: var(--bg-body);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .change-lists summary {
      padding: 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .change-lists ul {
      margin: 0;
      padding: 12px;
      background: #fff;
      border-top: 1px solid var(--border);
      list-style-type: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .change-lists li {
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text-muted);
    }

    /* Table Toolbar */
    .table-tools-container {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .toolbar-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: #f8fafc;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .sheet-tabs { display: flex; gap: 8px; }
    .sheet-tab {
      background: transparent;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .sheet-tab:hover {
        transform: translateY(-2px);
        background: #e2e8f0;
    }
    .sheet-tab.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); transform: none; }

    .view-toggles {
      display: flex;
      background: #e2e8f0;
      padding: 3px;
      border-radius: 8px;
    }
    .view-toggles button {
      background: transparent;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 500;
      transition: all 0.2s;
    }
    .view-toggles button:hover:not(.active) {
        background: rgba(255,255,255,0.5);
        color: var(--text-main);
    }
    .view-toggles button.active {
      background: white;
      color: var(--text-main);
      box-shadow: var(--shadow-sm);
    }

    /* Table */
    .table-scroll-area {
      max-height: 700px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    /* --- GÃœNCELLENEN TABLO STÄ°LLERÄ° (DAHA SIKI) --- */
    thead th {
      background: #f8fafc;
      position: sticky;
      top: 0;
      text-align: left;
      padding: 8px 10px; /* YaklaÅŸtÄ±rÄ±ldÄ± */
      font-weight: 600;
      color: var(--text-muted);
      font-size: 11px; /* Font kÃ¼Ã§Ã¼ldÃ¼ */
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      z-index: 10;
    }

    tbody tr { transition: background 0.1s; cursor: pointer; }
    tbody tr:hover { background-color: #f1f5f9; }
    
    tbody td {
      padding: 8px 10px; /* YaklaÅŸtÄ±rÄ±ldÄ± */
      border-bottom: 1px solid var(--border);
      color: var(--text-main);
      white-space: nowrap;
      font-size: 13px;
    }

    /* Status Pills in Table */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-badge.normal { background: #f1f5f9; color: var(--text-muted); border: 1px solid #e2e8f0; }
    .status-badge.new { background: var(--success-bg); color: var(--success-text); }
    .status-badge.updated { background: var(--warning-bg); color: var(--warning-text); }
    .status-badge.danger { background: var(--danger-bg); color: var(--danger-text); }

    /* New/Updated Row Highlights */
    tr.new-row td { background-color: #f0fdf4; }
    tr.updated-row td { background-color: #fefce8; }
    tr.new-row:hover td { background-color: #dcfce7; }
    tr.updated-row:hover td { background-color: #fef08a; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--text-main);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: none;
      z-index: 100;
    }
    .toast.visible { opacity: 1; transform: translateY(0); }

    /* --- MODAL STÄ°LLERÄ° --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 2000;
      display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; }
    .modal-card {
      background: white; width: 100%; max-width: 500px;
      border-radius: 16px; box-shadow: var(--shadow-lg);
      overflow: hidden; animation: modalSlide 0.3s ease;
    }
    @keyframes modalSlide { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    .modal-header {
      padding: 16px 24px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      background: #f8fafc;
    }
    .modal-title { font-size: 18px; font-weight: 700; color: var(--text-main); }
    
    /* MODAL KAPATMA BUTONU HOVER */
    .modal-close {
      background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);
      line-height: 1; padding: 4px 8px; border-radius: 8px;
      transition: all 0.2s ease;
    }
    .modal-close:hover {
        background-color: #fee2e2;
        color: #991b1b;
        transform: rotate(90deg);
    }

    .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
    .detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 4px; }
    .detail-label { color: var(--text-muted); font-weight: 500; }
    .detail-val { font-weight: 600; color: var(--text-main); text-align: right; }
    .change-log-box {
      margin-top: 16px; padding: 12px; background: #fffbeb; border: 1px solid #fcd34d;
      border-radius: 8px; font-size: 13px; color: #92400e;
    }

    /* --- YAZDIRMA STÄ°LLERÄ° (YENÄ°LENMÄ°Å) --- */
    @media print {
      body { background: white; padding: 0; }
      .app-shell { max-width: none; padding: 0; }
      
      /* Gizlenecek Alanlar */
      header.app-header, 
      .dashboard-grid > div:first-child, /* Sol panel */
      .table-tools-container .toolbar-header, 
      .table-tools-container #listStatusBar,
      .table-tools-container input,
      .no-print, 
      .toast,
      .modal-overlay { 
        display: none !important; 
      }

      /* DÃ¼zen */
      .dashboard-grid { display: block; grid-template-columns: 1fr; }
      .table-tools-container { 
        border: none; box-shadow: none; overflow: visible; 
      }
      .table-scroll-area { max-height: none; overflow: visible; }
      .panel { padding: 0; border: none; box-shadow: none; }

      /* Liste Modernizasyonu */
      table { width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif; }
      thead th { 
        background-color: #f1f5f9 !important; 
        color: #0f172a !important; 
        border: 2px solid #000; /* Belirgin baÅŸlÄ±k */
        font-weight: 800;
        font-size: 12px;
      }
      tbody td { 
        border: 1px solid #cbd5e1; 
        font-size: 11px;
        padding: 6px 8px;
        color: #000;
      }
      tr:nth-child(even) { background-color: #f8fafc !important; }

      /* Ã–zel YazdÄ±rma BaÅŸlÄ±ÄŸÄ± */
      .print-title-block {
        display: block !important;
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
      }
      .print-title-block h1 { font-size: 32px; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
      .print-title-block p { font-size: 14px; margin: 5px 0 0 0; color: #666; }
    }

    .muted-text { color: var(--text-muted); font-size: 12px; }
  </style>
</head>
<body>

  <div class="app-shell">
    
    <div class="print-title-block">
        <h1>Ã–ÄRENCÄ° LÄ°STESÄ°</h1>
        <p id="printDateInfo">Rapor Tarihi: -</p>
    </div>

    <header class="app-header">
      <div class="app-title-block">
        <h1><span class="icon">ğŸ“</span> Ã–ÄŸrenci Listesi YÃ¶neticisi</h1>
        <p>Google Eâ€‘Tablo Entegrasyonu + Firebase Takip Sistemi</p>
      </div>
      <div class="header-meta">
        <div class="chip">
          <span id="lastLoadedInfo">Veri bekleniyor...</span>
        </div>
        <div class="chip">
           <span id="compareSourceLabel">KarÅŸÄ±laÅŸtÄ±rma: Yok</span>
        </div>
      </div>
    </header>

    <div class="dashboard-grid">
      
      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <section>
          <div class="stats-container">
            <div class="stat-card total">
              <div class="stat-label">Toplam Ã–ÄŸrenci</div>
              <div class="stat-value" id="totalCount">â€“</div>
              <div class="stat-desc">Aktif listedeki kayÄ±t sayÄ±sÄ±</div>
            </div>
            <div class="stat-card new">
              <div class="stat-label">Yeni</div>
              <div class="stat-value" id="newCount">â€“</div>
              <div class="stat-desc">Ã–nceki listeye gÃ¶re</div>
            </div>
            <div class="stat-card updated">
              <div class="stat-label">GÃ¼ncel</div>
              <div class="stat-value" id="updatedCount">â€“</div>
              <div class="stat-desc">Bilgisi deÄŸiÅŸenler</div>
            </div>
            <div class="stat-card removed">
              <div class="stat-label">Silinen</div>
              <div class="stat-value" id="removedCount">â€“</div>
              <div class="stat-desc">Listeden dÃ¼ÅŸenler</div>
            </div>
          </div>
          
          <div class="change-lists">
            <details>
              <summary>ğŸ†• Yeni KayÄ±tlar <span class="status-badge new" id="newTagCount" style="margin-left:auto">0</span></summary>
              <ul id="newList"></ul>
            </details>
            <details>
              <summary>âœï¸ GÃ¼ncellenenler <span class="status-badge updated" id="updatedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="updatedList"></ul>
            </details>
            <details>
              <summary>ğŸ—‘ï¸ Silinenler <span class="status-badge normal" id="removedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="removedList"></ul>
            </details>
            <details>
              <summary>âš ï¸ Okul No Ã‡akÄ±ÅŸmalarÄ± <span class="status-badge danger" id="dupTagCount" style="margin-left:auto">0</span></summary>
              <ul id="dupList"></ul>
            </details>
          </div>
        </section>

        <section class="panel">
          <div class="panel-title">
            <span>ğŸ” Filtreleme</span>
            <button class="btn btn-secondary btn-sm" id="clearFiltersBtn" type="button">Temizle</button>
          </div>
          
          <div class="filters-stack">
            <div class="field-group">
              <div class="field-label">Genel Arama</div>
              <input type="text" id="searchInput" placeholder="Ä°sim, No, Veli..." />
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="field-group">
                <div class="field-label">Cinsiyet</div>
                <select id="genderFilter">
                  <option value="">TÃ¼mÃ¼</option>
                  <option value="KIZ">KÄ±z</option>
                  <option value="ERKEK">Erkek</option>
                </select>
              </div>
              <div class="field-group">
                <div class="field-label">Burs</div>
                <select id="scholarFilter">
                  <option value="">TÃ¼mÃ¼</option>
                  <option value="nonempty">Burslu</option>
                  <option value="empty">Burssuz</option>
                </select>
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">KayÄ±t Durumu</div>
              <select id="statusFilter">
                <option value="">TÃ¼m Durumlar</option>
                <option value="new">Sadece Yeni</option>
                <option value="updated">GÃ¼ncellenenler</option>
                <option value="normal">DeÄŸiÅŸiklik Yok</option>
              </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="field-group">
                <div class="field-label">BaÅŸlangÄ±Ã§ Tarihi</div>
                <input type="date" id="dateFrom" />
              </div>
              <div class="field-group">
                <div class="field-label">BitiÅŸ Tarihi</div>
                <input type="date" id="dateTo" />
              </div>
            </div>

            <div class="field-group">
                <div class="field-label">SÄ±ralama SeÃ§enekleri</div>
                <select id="generalSortOrder">
                    <option value="">Otomatik (Durum Ã–ncelikli)</option>
                    <option value="name_asc">Ä°sim (A â†’ Z)</option>
                    <option value="name_desc">Ä°sim (Z â†’ A)</option>
                    <option value="num_asc">Numara (KÃ¼Ã§Ã¼k â†’ BÃ¼yÃ¼k)</option>
                    <option value="num_desc">Numara (BÃ¼yÃ¼k â†’ KÃ¼Ã§Ã¼k)</option>
                    <option value="date_desc">Tarih (Yeniden â†’ Eskiye)</option>
                    <option value="date_asc">Tarih (Eskiden â†’ Yeniye)</option>
                </select>
            </div>

            <div class="field-group">
              <div class="field-label">SÄ±nÄ±flar</div>
              <div id="classFilterContainer" class="class-chips"></div>
            </div>

            <div class="field-group">
              <label style="display:flex; gap:8px; align-items:center; font-size:13px; cursor:pointer;">
                <input type="checkbox" id="recentOnly" style="width:16px; height:16px;" />
                <span>Sadece son 30 kayÄ±t</span>
              </label>
            </div>
            
            <hr style="border:0; border-top:1px solid var(--border); width:100%;">
            
            <div style="display:flex; flex-direction:column; gap:8px;">
               <button class="btn btn-secondary" id="reloadBtn" type="button">
                 ğŸ”„ Verileri Yenile
               </button>
            </div>
          </div>
        </section>

      </div>

      <div class="table-tools-container">
        
        <div class="toolbar-header">
          <div class="table-toolbar-left" style="display:flex; flex-direction:column; gap:8px;">
            <div class="sheet-tabs" id="sheetTabs"></div>
            <div class="view-toggles">
              <button type="button" data-view="all" class="active" id="viewAllBtn">TÃ¼m Liste</button>
              <button type="button" data-view="new-updated" id="viewNewUpdatedBtn">âœ¨ DeÄŸiÅŸiklikler</button>
            </div>
          </div>
          
          <div class="table-toolbar-right" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-primary btn-sm no-print" id="saveSnapshotBtn">
              ğŸ’¾ Kaydet
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="downloadTxtBtn">
              ğŸ“¥ Ä°ndir (TXT)
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="uploadTxtBtn">
              ğŸ“¤ KarÅŸÄ±laÅŸtÄ±r
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="printBtn">
              ğŸ–¨ï¸ YazdÄ±r
            </button>
          </div>
        </div>

        <div style="padding: 8px 24px; background: #fff; border-bottom: 1px solid var(--border); font-size:12px; color:var(--text-muted);" id="listStatusBar">
          YÃ¼kleniyor...
        </div>

        <input type="file" id="uploadTxtInput" accept=".txt,.json" style="display:none;" />
        
        <div class="no-print" style="padding: 10px 24px; background: #f8fafc; border-bottom: 1px solid var(--border);">
            <details>
                <summary style="font-size:12px; color:var(--text-muted); cursor:pointer;">ğŸ–¨ï¸ YazdÄ±rma SÃ¼tunlarÄ±nÄ± SeÃ§</summary>
                <div class="cols" id="printColsContainer" style="display:flex; flex-wrap:wrap; gap:12px; padding-top:8px; font-size:13px;"></div>
            </details>
        </div>

        <div class="table-scroll-area">
          <table id="studentsTable">
            <thead>
              <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="tableBody">
              <tr class="loading-row">
                <td colspan="12" style="text-align:center; padding: 40px;">Veriler yÃ¼kleniyor...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div style="padding: 12px 24px; background: #f8fafc; border-top: 1px solid var(--border); font-size:12px; color:var(--text-muted); text-align:center;">
          <span id="lastSavedInfo">Son kayÄ±t: Yok</span> â€¢ Detay iÃ§in satÄ±ra tÄ±klayÄ±n.
        </div>

      </div>

    </div>
  </div>

  <div class="toast" id="toast">
    <span style="font-size: 18px;">âœ…</span>
    <span id="toastMessage">Ä°ÅŸlem baÅŸarÄ±lÄ±.</span>
  </div>

  <div class="modal-overlay" id="studentDetailModal">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title">Ã–ÄŸrenci DetayÄ±</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body" id="modalContent">
            </div>
    </div>
  </div>

  <script type="module">
    // =======================
    // KONFÄ°GÃœRASYON
    // =======================
    const SHEET_ID = "16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi";

    const SHEET_TABS = [
      { name: "2025-2026", label: "2025-2026 DÃ¶nemi" }
    ];

    let currentSheetName = SHEET_TABS[0].name;
    const STORAGE_KEY_BASE = "ogrenci_listesi_snapshot_v3_";

    const COLUMNS = [
      { key: "status",   label: "DURUM" },
      { key: "isim",     label: "Ä°SÄ°M" },
      { key: "soyisim",  label: "SOYÄ°SÄ°M" },
      { key: "cinsiyet", label: "CÄ°NSÄ°YET" },
      { key: "sinif",    label: "SINIF" },
      { key: "okulNo",   label: "OKUL NO" },
      { key: "veliAdi",  label: "VELÄ° ADI" },
      { key: "veliSoyadi", label: "VELÄ° SOYADI" },
      { key: "veliTelefon", label: "VELÄ° TELEFON" },
      { key: "yil",      label: "YIL" },
      { key: "tarih",    label: "TARÄ°H" },
      { key: "burslu",   label: "BURSLU MU?" }
    ];

    let students = [];
    let snapshot = null;
    let snapshotSource = "none"; 
    let activeViewMode = "all";  

        let duplicateOkulNoMap = {}; // { okulNo: [student, ...] }

// =======================
    // FIREBASE
    // =======================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const firebaseAnalytics = getAnalytics(firebaseApp);
    const firebaseDb = getDatabase(firebaseApp);
    const FIREBASE_BASE_PATH = 'snapshots';

    // =======================
    // ARAÃ‡LAR
    // =======================
    function getSheetCsvUrl(sheetName) {
      return "https://docs.google.com/spreadsheets/d/" +
        SHEET_ID +
        "/gviz/tq?tqx=out:csv&sheet=" +
        encodeURIComponent(sheetName);
    }

    function getSnapshotRef() {
      const name = currentSheetName || 'default';
      const safeName = encodeURIComponent(name);
      return ref(firebaseDb, `${FIREBASE_BASE_PATH}/${safeName}`);
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      document.getElementById("toastMessage").textContent = message;
      toast.classList.add("visible");
      setTimeout(() => toast.classList.remove("visible"), 3000);
    }

    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];
        if (c === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
        } else if (c === '"') {
          inQuotes = !inQuotes;
        } else if (c === "," && !inQuotes) {
          currentRow.push(current);
          current = "";
        } else if ((c === "\n" || c === "\r") && !inQuotes) {
          if (current !== "" || currentRow.length > 0) {
            currentRow.push(current);
            rows.push(currentRow);
            currentRow = [];
            current = "";
          }
        } else {
          current += c;
        }
      }
      if (current !== "" || currentRow.length > 0) {
        currentRow.push(current);
        rows.push(currentRow);
      }
      return rows.filter(r => r.length > 0);
    }

    function parseDateTR(str) {
      if (!str) return null;
      const parts = str.trim().split(".");
      if (parts.length !== 3) return null;
      const [g, a, y] = parts.map(p => parseInt(p, 10));
      if (isNaN(g) || isNaN(a) || isNaN(y)) return null;
      return new Date(y, a - 1, g);
    }

    function formatDateTimeForBadge(isoString) {
      if (!isoString) return "â€“";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "â€“";
      return d.toLocaleDateString("tr-TR", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    function createStudentId(row) {
      const num = (row.okulNo || "").trim();
      const name = (row.isim || "").trim().toUpperCase();
      const surname = (row.soyisim || "").trim().toUpperCase();
      if (num) return `${num}__${name}__${surname}`;
      return `${name}__${surname}`;
    }



    function normalizeOkulNo(no) {
      return String(no || "").trim();
    }

    function detectDuplicateOkulNos(list) {
      const buckets = {};
      (list || []).forEach(st => {
        const no = normalizeOkulNo(st.okulNo);
        if (!no) return;
        if (!buckets[no]) buckets[no] = [];
        buckets[no].push(st);
      });
      const dup = {};
      Object.keys(buckets).forEach(no => {
        if (buckets[no].length >= 2) dup[no] = buckets[no];
      });
      return dup;
    }

// ID deÄŸiÅŸtiÄŸinde (Ã¶r. isim/soyisim/okulNo dÃ¼zeltmesi) aynÄ± kiÅŸiyi "yeni" gibi gÃ¶stermemek iÃ§in
// ikincil eÅŸleÅŸtirme (hemen iyileÅŸtirme): Veli Telefon (+ mÃ¼mkÃ¼nse SÄ±nÄ±f) Ã¼zerinden eski kaydÄ± bulup "updated" olarak iÅŸaretler.
function normalizePhone(str) {
  return String(str || "").replace(/\D+/g, "");
}

function findPrevMatchForStudent(student, prevMap) {
  if (!prevMap) return null;

  const phone = normalizePhone(student.veliTelefon);
  if (!phone || phone.length < 8) return null; // Ã§ok kÄ±sa/boÅŸ telefonlar eÅŸleÅŸtirmede gÃ¼venilmez

  // Adaylar: aynÄ± veli telefonu olan tÃ¼m eski kayÄ±tlar
  const candidates = [];
  for (const prevId in prevMap) {
    const d = (prevMap[prevId] && prevMap[prevId].data) ? prevMap[prevId].data : null;
    if (!d) continue;
    const p = normalizePhone(d.veliTelefon);
    if (p && p === phone) candidates.push(prevId);
  }
  if (!candidates.length) return null;

  // 1) SÄ±nÄ±f eÅŸleÅŸmesi (varsa) Ã¶ncelik
  const cls = String(student.sinif || "").trim();
  let filtered = candidates;
  if (cls) {
    const byClass = candidates.filter(pid => String(prevMap[pid].data.sinif || "").trim() === cls);
    if (byClass.length) filtered = byClass;
  }

  // 2) Ä°sim/Soyisim benzerliÄŸi ile deterministik seÃ§im (basit puanlama)
  const n = String(student.isim || "").trim().toUpperCase();
  const s = String(student.soyisim || "").trim().toUpperCase();
  const score = (pid) => {
    const d = prevMap[pid].data || {};
    const pn = String(d.isim || "").trim().toUpperCase();
    const ps = String(d.soyisim || "").trim().toUpperCase();
    let sc = 0;
    if (pn === n) sc += 5;
    else if (pn && n && (pn.includes(n) || n.includes(pn))) sc += 2;
    if (ps === s) sc += 5;
    else if (ps && s && (ps.includes(s) || s.includes(ps))) sc += 2;
    // Okul no eÅŸleÅŸmesi (varsa) kÃ¼Ã§Ã¼k bir bonus (ama okul no yanlÄ±ÅŸ atanmÄ±ÅŸ olabilir)
    const on = String(student.okulNo || "").trim();
    const pon = String(d.okulNo || "").trim();
    if (on && pon && on === pon) sc += 1;
    return sc;
  };

  filtered.sort((a, b) => {
    const sa = score(a);
    const sb = score(b);
    if (sb !== sa) return sb - sa;
    return String(a).localeCompare(String(b));
  });

  return filtered[0] || null;
}

    function deepEqual(a, b) {
      if (a === null || b === null || typeof a !== 'object' || typeof b !== 'object') {
        return a === b;
      }
      const keysA = Object.keys(a).sort();
      const keysB = Object.keys(b).sort();
      if (keysA.length !== keysB.length) return false;
      for (let i = 0; i < keysA.length; i++) {
        const keyA = keysA[i];
        const keyB = keysB[i];
        if (keyA !== keyB) return false;
        const valA = a[keyA];
        const valB = b[keyB];
        if (valA === null || valB === null || typeof valA !== 'object' || typeof valB !== 'object') {
          if (valA !== valB) return false;
        } else {
          if (!deepEqual(valA, valB)) return false;
        }
      }
      return true;
    }

    // =======================
    // SNAPSHOT LOGIC
    // =======================
    function buildSnapshotObject(currentStudents) {
      const records = {};
      currentStudents.forEach(s => {
        records[s.id] = {
          id: s.id,
          data: {
            isim: s.isim, soyisim: s.soyisim, cinsiyet: s.cinsiyet,
            sinif: s.sinif, okulNo: s.okulNo, veliAdi: s.veliAdi,
            veliSoyadi: s.veliSoyadi, veliTelefon: s.veliTelefon,
            yil: s.yil, tarih: s.tarih, burslu: s.burslu
          }
        };
      });
      return {
        savedAt: new Date().toISOString(),
        sheetName: currentSheetName,
        records
      };
    }

    function updateSnapshotLabels() {
      // Not: ArtÄ±k "Son kayÄ±t:..." metnini updateListStatus fonksiyonu yÃ¶netiyor.
      // Sadece "KarÅŸÄ±laÅŸtÄ±rma" etiketini burada gÃ¼ncelliyoruz.
      const compareLabel = document.getElementById("compareSourceLabel");

      if (!snapshot) {
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma: Yok";
        return;
      }

      if (snapshotSource === "firebase") {
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma: Firebase DB";
      } else if (snapshotSource === "file") {
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma: TXT DosyasÄ±";
      } else {
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma: Yok";
      }
    }

    async function loadSnapshot() {
      try {
        const snapRef = getSnapshotRef();
        const snapData = await get(snapRef);
        if (!snapData.exists()) {
          snapshot = null;
          snapshotSource = "none";
          updateSnapshotLabels();
          return;
        }
        snapshot = snapData.val();
        snapshotSource = "firebase";
        updateSnapshotLabels();
      } catch (e) {
        console.error("Snapshot yÃ¼klenemedi", e);
        snapshot = null;
        snapshotSource = "none";
        updateSnapshotLabels();
      }
    }

    async function saveSnapshot(currentStudents) {
      const snap = buildSnapshotObject(currentStudents);
      try {
        const snapRef = getSnapshotRef();
        await set(snapRef, snap);
        snapshot = snap;
        snapshotSource = "firebase";
        updateSnapshotLabels();
        showToast("Liste Firebase'e baÅŸarÄ±yla kaydedildi.");
      } catch (e) {
        console.error("Snapshot kaydedilemedi", e);
        showToast("Hata: KayÄ±t yapÄ±lamadÄ±.");
      }
    }

    function applySnapshotFromFile(obj) {
      if (!obj || !obj.records) {
        showToast("HatalÄ± dosya formatÄ±.");
        return;
      }
      snapshot = obj;
      snapshotSource = "file";
      updateSnapshotLabels();
      showToast("TXT yÃ¼klendi, karÅŸÄ±laÅŸtÄ±rma yapÄ±lÄ±yor.");
      loadData();
    }

    // =======================
    // VERÄ° YÃœKLEME
    // =======================
    async function loadData() {
      const body = document.getElementById("tableBody");
      body.innerHTML = '<tr class="loading-row"><td colspan="12" style="text-align:center; padding:40px;">Google Tablo\'dan veriler alÄ±nÄ±yor...</td></tr>';
      document.getElementById("lastLoadedInfo").textContent = "YÃ¼kleniyor...";

      try {
        const url = getSheetCsvUrl(currentSheetName);
        const res = await fetch(url);
        if (!res.ok) throw new Error("AÄŸ hatasÄ±: " + res.status);
        const text = await res.text();

        if (text.startsWith("<")) throw new Error("CSV yerine HTML geldi. Tablo yayÄ±n ayarlarÄ±nÄ± kontrol edin.");

        const rows = parseCSV(text);
        if (!rows.length) {
          body.innerHTML = '<tr class="loading-row"><td colspan="12">Tablo boÅŸ.</td></tr>';
          updateListStatus([]);
          return;
        }

        const header = rows[0].map(h => h.trim());
        const dataRows = rows.slice(1).filter(r => r.some(cell => cell.trim() !== ""));

        const headerIndex = name => header.indexOf(name);
        const idxIsim = headerIndex("Ä°sim") === -1 ? 0 : headerIndex("Ä°sim");
        const idxSoy = headerIndex("Soyisim*");
        const idxCins = headerIndex("Cinsiyet*");
        const idxSinif = headerIndex("SÄ±nÄ±f");
        const idxOkulNo = headerIndex("Okul NumarasÄ±");
        const idxVeliAd = headerIndex("Veli AdÄ±");
        const idxVeliSoy = headerIndex("Veli SoyadÄ±");
        const idxVeliTel = headerIndex("Veli Telefon");
        const idxYil = headerIndex("YIL");
        const idxTarih = headerIndex("Tarih");
        const idxBurs = headerIndex("Burslu mu?");

        const parsed = dataRows.map(row => {
          const s = {
            isim: (row[idxIsim] || "").trim(),
            soyisim: (row[idxSoy] || "").trim(),
            cinsiyet: (row[idxCins] || "").trim().toUpperCase(),
            sinif: (row[idxSinif] || "").trim(),
            okulNo: (row[idxOkulNo] || "").trim(),
            veliAdi: (row[idxVeliAd] || "").trim(),
            veliSoyadi: (row[idxVeliSoy] || "").trim(),
            veliTelefon: (row[idxVeliTel] || "").trim(),
            yil: (row[idxYil] || "").trim(),
            tarih: (row[idxTarih] || "").trim(),
            burslu: (row[idxBurs] || "").trim()
          };
          s.id = createStudentId(s);
          s.dateObj = parseDateTR(s.tarih);
          s.status = "normal";
          return s;
        });
let removed = [];
if (snapshot && snapshot.records) {
  const prevMap = snapshot.records;
  const currentIds = new Set(parsed.map(s => s.id));
  const matchedPrevIds = new Set();

  parsed.forEach(s => {
    const prev = prevMap[s.id];

    // Ä°nce eÅŸleÅŸtirme: ID deÄŸiÅŸmiÅŸse (isim/soyisim/okulNo dÃ¼zeltmesi vb.)
    // aynÄ± kiÅŸiyi "new" yerine "updated" olarak ele al.
    let comparePrevId = null;

    if (!prev) {
      comparePrevId = findPrevMatchForStudent(s, prevMap);
      if (comparePrevId) {
        matchedPrevIds.add(comparePrevId);
        s.status = "updated";
        s._comparePrevId = comparePrevId; // modal ve deÄŸiÅŸiklik listesi iÃ§in
      } else {
        s.status = "new";
        return;
      }
    } else {
      comparePrevId = s.id;
    }

    const prevData = prevMap[comparePrevId].data;
    const currentSlim = {
      isim: s.isim, soyisim: s.soyisim, cinsiyet: s.cinsiyet,
      sinif: s.sinif, okulNo: s.okulNo, veliAdi: s.veliAdi,
      veliSoyadi: s.veliSoyadi, veliTelefon: s.veliTelefon,
      yil: s.yil, tarih: s.tarih, burslu: s.burslu
    };

    if (!deepEqual(prevData, currentSlim)) {
      s.status = "updated";
      s._comparePrevId = comparePrevId;
    } else {
      // ID birebir eÅŸleÅŸtiyse ve veri aynÄ±ysa normal; (ince eÅŸleÅŸmede "updated" zaten set edilmiÅŸ olur)
      if (!s._comparePrevId) s.status = "normal";
    }
  });

  // Removed: snapshot'ta olup gÃ¼ncel listede olmayanlar,
  // fakat ince eÅŸleÅŸtirme ile "updated"e baÄŸlananlar removed sayÄ±lmasÄ±n.
  for (const prevId in prevMap) {
    if (!currentIds.has(prevId) && !matchedPrevIds.has(prevId)) {
      removed.push(prevMap[prevId]);
    }
  }
}
        students = parsed;
        duplicateOkulNoMap = detectDuplicateOkulNos(parsed);
        renderHeader();
        populateFilters();
        updateSummary(removed);
        applyFilters(removed);
        document.getElementById("lastLoadedInfo").textContent = `${currentSheetName} | ${formatDateTimeForBadge(new Date().toISOString())}`;
        const _dupKeys = duplicateOkulNoMap ? Object.keys(duplicateOkulNoMap) : [];
        if (_dupKeys.length) showToast(`UyarÄ±: ${_dupKeys.length} okul numarasÄ± Ã§akÄ±ÅŸmasÄ± bulundu. (âš ï¸ Okul No Ã‡akÄ±ÅŸmalarÄ± bÃ¶lÃ¼mÃ¼ne bakÄ±n)`);
        
      } catch (err) {
        console.error(err);
        body.innerHTML = `<tr class="loading-row"><td colspan="12" style="color:red">Hata: ${err.message}</td></tr>`;
        document.getElementById("lastLoadedInfo").textContent = "Hata oluÅŸtu.";
        updateListStatus([]);
      }
    }

    // =======================
    // UI RENDER
    // =======================
    function renderSheetTabs() {
      const container = document.getElementById("sheetTabs");
      container.innerHTML = "";
      SHEET_TABS.forEach(tab => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sheet-tab";
        if (tab.name === currentSheetName) btn.classList.add("active");
        btn.textContent = tab.label;
        btn.addEventListener("click", async () => {
          if (currentSheetName === tab.name) return;
          currentSheetName = tab.name;
          await loadSnapshot();
          renderSheetTabs();
          await loadData();
        });
        container.appendChild(btn);
      });
    }

    function renderHeader() {
      const headerRow = document.getElementById("tableHeaderRow");
      headerRow.innerHTML = "";
      COLUMNS.forEach((col, index) => {
        const th = document.createElement("th");
        th.textContent = col.label;
        th.dataset.field = col.key;
        headerRow.appendChild(th);
      });

      const printContainer = document.getElementById("printColsContainer");
      printContainer.innerHTML = "";
      COLUMNS.forEach(col => {
        const id = "print-col-" + col.key;
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "6px";
        label.innerHTML = `
          <input type="checkbox" id="${id}" data-field="${col.key}" checked />
          <span>${col.label}</span>
        `;
        printContainer.appendChild(label);
      });
    }

    function populateFilters() {
      const container = document.getElementById("classFilterContainer");
      const classes = Array.from(new Set(students.map(s => s.sinif).filter(Boolean))).sort();
      container.innerHTML = "";
      classes.forEach(cls => {
        const id = "class-filter-" + cls.replace(/\s+/g, "_");
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" value="${cls}">
          <span>${cls}</span>
        `;
        container.appendChild(label);
      });
    }

    function getSelectedClasses() {
      const boxes = document.querySelectorAll("#classFilterContainer input[type='checkbox']");
      const selected = [];
      boxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
      return selected;
    }

    function updateSummary(removedRecords = []) {
      const total = students.length;
      const newCount = students.filter(s => s.status === "new").length;
      const updatedCount = students.filter(s => s.status === "updated").length;
      const removedCount = removedRecords.length;

      const dupGroups = duplicateOkulNoMap ? Object.keys(duplicateOkulNoMap) : [];
      const dupCount = dupGroups.length;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("newCount").textContent = newCount;
      document.getElementById("updatedCount").textContent = updatedCount;
      document.getElementById("removedCount").textContent = removedCount;

      document.getElementById("newTagCount").textContent = newCount;
      document.getElementById("updatedTagCount").textContent = updatedCount;
      document.getElementById("removedTagCount").textContent = removedCount;


      const dupTag = document.getElementById("dupTagCount");
      if (dupTag) dupTag.textContent = dupCount;

      const fillList = (listId, items, isRemoved = false) => {
        const el = document.getElementById(listId);
        el.innerHTML = "";
        items.forEach(s => {
          const d = isRemoved ? (s.data || {}) : s;
          const li = document.createElement("li");
          li.innerHTML = `<b>${d.okulNo || "?"}</b> ${d.isim} ${d.soyisim} <small>(${d.sinif})</small>`;
          el.appendChild(li);
        });
      };

      fillList("newList", students.filter(s => s.status === "new"));
      fillList("updatedList", students.filter(s => s.status === "updated"));
      fillList("removedList", removedRecords, true);


      // Okul No Ã‡akÄ±ÅŸmalarÄ±
      const dupEl = document.getElementById("dupList");
      if (dupEl) {
        dupEl.innerHTML = "";
        dupGroups.sort((a,b) => parseInt(a||"0") - parseInt(b||"0"));
        dupGroups.forEach(no => {
          const arr = duplicateOkulNoMap[no] || [];
          const li = document.createElement("li");
          const details = arr.map(x => `${x.isim} ${x.soyisim} <small>(${x.sinif || '-'})</small>`).join(" â€¢ ");
          li.innerHTML = `<b>${no}</b> <span style="opacity:0.9">${details}</span>`;
          dupEl.appendChild(li);
        });
      }
    }

    function updateListStatus(filteredRows) {
      const bar = document.getElementById("listStatusBar");
      if (!bar) return;
      const visible = filteredRows ? filteredRows.length : 0;
      const total = students.length;
      const recentOnly = document.getElementById("recentOnly").checked;
      
      let msg = `Toplam <strong>${total}</strong> kayÄ±t iÃ§inden <strong>${visible}</strong> tanesi gÃ¶rÃ¼ntÃ¼leniyor.`;
      if (recentOnly && visible >= 30) msg += " (Son 30 kayÄ±t filtresi aktif)";
      bar.innerHTML = msg;


      // Okul No Ã§akÄ±ÅŸmasÄ± uyarÄ±sÄ±
      const dupGroupsAll = duplicateOkulNoMap ? Object.keys(duplicateOkulNoMap) : [];
      if (dupGroupsAll.length) {
        bar.innerHTML += ` <span style="margin-left:10px; padding:3px 10px; border-radius:999px; background: var(--danger-bg); color: var(--danger-text); font-weight:700;">âš ï¸ ${dupGroupsAll.length} okul no Ã§akÄ±ÅŸmasÄ±</span>`;
      }

      // --- GÃœNCELLEME 2: ALT BÄ°LGÄ°YÄ° GÃœNCELLE ---
      const bottomFooter = document.getElementById("lastSavedInfo");
      if(bottomFooter) {
         bottomFooter.textContent = `Åu an listede ${visible} sayÄ±da Ã¶ÄŸrenci vardÄ±r.`;
      }
    }

    function applyFilters(removedRecords = []) {
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
      const genderVal = document.getElementById("genderFilter").value;
      const scholarVal = document.getElementById("scholarFilter").value;
      const statusVal = document.getElementById("statusFilter").value;
      const recentOnly = document.getElementById("recentOnly").checked;
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;
      const selectedClasses = getSelectedClasses();
      const sortOrder = document.getElementById("generalSortOrder") ? document.getElementById("generalSortOrder").value : "";

      let fromDate = null;
      let toDate = null;
      if (dateFromVal) fromDate = new Date(dateFromVal + "T00:00:00");
      if (dateToVal)    toDate    = new Date(dateToVal    + "T23:59:59");

      let filtered = students.slice();

      filtered = filtered.filter(s => {
        if (activeViewMode === "new-updated" && !(s.status === "new" || s.status === "updated")) return false;
        if (statusVal) {
          if (statusVal === "normal" && s.status !== "normal") return false;
          if (statusVal === "new" && s.status !== "new") return false;
          if (statusVal === "updated" && s.status !== "updated") return false;
        }
        if (selectedClasses.length && !selectedClasses.includes(s.sinif)) return false;
        if (genderVal && s.cinsiyet !== genderVal) return false;
        if (scholarVal === "nonempty" && !s.burslu) return false;
        if (scholarVal === "empty" && s.burslu) return false;
        if (fromDate && s.dateObj && s.dateObj < fromDate) return false;
        if (toDate && s.dateObj && s.dateObj > toDate) return false;
        
        if (searchText) {
          const combined = Object.values(s).join(" ").toLowerCase();
          if (!combined.includes(searchText)) return false;
        }
        return true;
      });

      // --- SIRALAMA MANTIÄI ---
      const statusOrder = { new: 0, updated: 1, normal: 2 };
      
      filtered.sort((a, b) => {
        // 1. Ä°sim SÄ±ralama
        if (sortOrder === "name_asc") return a.isim.localeCompare(b.isim, 'tr');
        if (sortOrder === "name_desc") return b.isim.localeCompare(a.isim, 'tr');

        // 2. Numara SÄ±ralama (Okul No)
        if (sortOrder === "num_asc") return parseInt(a.okulNo || "0") - parseInt(b.okulNo || "0");
        if (sortOrder === "num_desc") return parseInt(b.okulNo || "0") - parseInt(a.okulNo || "0");

        // 3. Tarih SÄ±ralama
        if (sortOrder === "date_asc" || sortOrder === "date_desc") {
            const da = a.dateObj ? a.dateObj.getTime() : 0;
            const db = b.dateObj ? b.dateObj.getTime() : 0;
            return sortOrder === "date_desc" ? db - da : da - db;
        }

        // 4. VarsayÄ±lan (Otomatik: Durum -> Numara)
        const sa = statusOrder[a.status] ?? 2;
        const sb = statusOrder[b.status] ?? 2;
        if (sa !== sb) return sa - sb;
        return parseInt(b.okulNo || "0") - parseInt(a.okulNo || "0");
      });

      if (recentOnly && filtered.length > 30) filtered = filtered.slice(0, 30);

      renderTable(filtered);
      updateSummary(removedRecords);
      updateListStatus(filtered);
    }

    function renderTable(rows) {
      const body = document.getElementById("tableBody");
      body.innerHTML = "";

      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:30px; color:var(--text-muted)">EÅŸleÅŸen kayÄ±t bulunamadÄ±.</td></tr>';
        return;
      }

      rows.forEach(s => {
        const tr = document.createElement("tr");
        if (s.status === "new") tr.classList.add("new-row");
        if (s.status === "updated") tr.classList.add("updated-row");

        COLUMNS.forEach((col, index) => {
          const td = document.createElement("td");
          td.dataset.field = col.key;
          
          if (col.key === "status") {
            const span = document.createElement("span");
            if (s.status === "new") {
              span.className = "status-badge new";
              span.innerHTML = `âœ¨ YENÄ°`;
            } else if (s.status === "updated") {
              span.className = "status-badge updated";
              span.innerHTML = `ğŸ“ GÃœNCEL`;
            } else {
              span.className = "status-badge normal";
              span.innerHTML = `NORMAL`;
            }
            td.appendChild(span);
          } else {
              if (col.key === "veliTelefon" && s[col.key]) {
                td.innerHTML = `<span style="opacity:0.6">${s[col.key]}</span>`;
              } else {
                td.textContent = s[col.key] || "";
              }
          }
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
      syncPrintColumnVisibility();
    }

    function syncPrintColumnVisibility() {
      const rows = document.querySelectorAll("#studentsTable tr");
      const checkboxes = document.querySelectorAll("#printColsContainer input[type='checkbox']");
      const hiddenFields = new Set();
      checkboxes.forEach(cb => {
        if (!cb.checked) hiddenFields.add(cb.dataset.field);
      });

      rows.forEach(tr => {
        Array.from(tr.children).forEach(cell => {
          const field = cell.dataset.field;
          if (!field) return;
          cell.style.display = hiddenFields.has(field) ? "none" : "";
        });
      });
    }

    // =======================
    // INIT & EVENTS
    // =======================
    function setupEventListeners() {
      const ids = ["searchInput", "genderFilter", "scholarFilter", "statusFilter", "dateFrom", "dateTo", "recentOnly", "generalSortOrder"];
      ids.forEach(id => {
          const el = document.getElementById(id);
          if(el) el.addEventListener("input", () => applyFilters());
      });
      
      document.getElementById("classFilterContainer").addEventListener("change", () => applyFilters());

      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                if(el.type==='checkbox') el.checked=false; else el.value="";
            }
        });
        document.querySelectorAll("#classFilterContainer input").forEach(cb => cb.checked=false);
        applyFilters();
      });

      document.getElementById("reloadBtn").addEventListener("click", () => loadData());
      document.getElementById("saveSnapshotBtn").addEventListener("click", () => saveSnapshot(students));
      document.getElementById("printBtn").addEventListener("click", () => {
        // YazdÄ±rma tarihini gÃ¼ncelle
        const d = new Date();
        document.getElementById("printDateInfo").textContent = "Rapor Tarihi: " + d.toLocaleDateString("tr-TR") + " " + d.toLocaleTimeString("tr-TR");
        
        syncPrintColumnVisibility();
        window.print();
      });
      document.getElementById("printColsContainer").addEventListener("change", syncPrintColumnVisibility);

      document.getElementById("viewAllBtn").addEventListener("click", (e) => {
        activeViewMode = "all";
        document.querySelectorAll(".view-toggles button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        applyFilters();
      });

      document.getElementById("viewNewUpdatedBtn").addEventListener("click", (e) => {
        activeViewMode = "new-updated";
        document.querySelectorAll(".view-toggles button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        applyFilters();
      });

      // Tablo SatÄ±rÄ±na TÄ±klama (Modal AÃ§ma)
      // ============================================================
      // GÃœNCELLENEN ALAN: Tablo EtkileÅŸimleri (TÄ±klama ve Ã‡ift TÄ±klama)
      // ============================================================

      // 1. Tek TÄ±klama (Sadece DURUM sÃ¼tununda Modal aÃ§ar)
      document.getElementById("tableBody").addEventListener("click", e => {
        const tr = e.target.closest("tr");
        const td = e.target.closest("td");
        
        // SatÄ±r yoksa veya yÃ¼kleniyor satÄ±rÄ±ysa iÅŸlem yapma
        if (!tr || tr.classList.contains("loading-row") || !td) return;

        // EÄER tÄ±klanan sÃ¼tun "status" (Durum) deÄŸilse modal aÃ§ma (buradan Ã§Ä±k)
        if (td.dataset.field !== "status") return;
        
        // Hangi Ã¶ÄŸrenci olduÄŸunu bul
        const noCell = tr.querySelector('[data-field="okulNo"]');
        if(!noCell) return;
        const rowOkulNo = noCell.textContent.trim();
        const nameCell = tr.querySelector('[data-field="isim"]');
        const rowName = nameCell ? nameCell.textContent.trim() : "";

        const student = students.find(s => s.okulNo == rowOkulNo && s.isim == rowName);
        if(student) openStudentModal(student);
      });

      // 2. Ã‡ift TÄ±klama (Durum haricindeki hÃ¼creleri kopyalar)
      document.getElementById("tableBody").addEventListener("dblclick", async e => {
        const td = e.target.closest("td");
        if (!td) return;

        // Durum sÃ¼tununda kopyalama yapma (orasÄ± modal iÃ§in)
        if (td.dataset.field === "status") return;

        const text = td.textContent.trim();
        if (!text) return;

        try {
          await navigator.clipboard.writeText(text);
          showToast(`KopyalandÄ±: ${text}`);
        } catch (err) {
          console.error("Kopyalama hatasÄ±:", err);
        }
      });
      
      // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapat
      document.getElementById("studentDetailModal").addEventListener("click", (e) => {
        if(e.target === document.getElementById("studentDetailModal")) closeModal();
      });

      // TXT Ä°ndir
      document.getElementById("downloadTxtBtn").addEventListener("click", () => {
        if (!students.length) return showToast("Liste boÅŸ.");
        const snap = buildSnapshotObject(students);
        const blob = new Blob([JSON.stringify(snap, null, 2)], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `liste_${currentSheetName}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("TXT Ä°ndirildi.");
      });

      // TXT YÃ¼kle
      const uploadInput = document.getElementById("uploadTxtInput");
      document.getElementById("uploadTxtBtn").addEventListener("click", () => {
        uploadInput.value = "";
        uploadInput.click();
      });
      uploadInput.addEventListener("change", e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            applySnapshotFromFile(JSON.parse(reader.result));
          } catch(err) { showToast("Dosya okunamadÄ±."); }
        };
        reader.readAsText(file);
      });
    }

    // Modal FonksiyonlarÄ±
    window.closeModal = function() {
      document.getElementById("studentDetailModal").classList.remove("active");
    };

    function openStudentModal(s) {
      const modal = document.getElementById("studentDetailModal");
      const content = document.getElementById("modalContent");
      
      let statusHtml = "";
      let diffHtml = "";
      let dupHtml = "";

      // Durum Tespiti
      if (s.status === "new") {
        statusHtml = `<span class="status-badge new" style="font-size:14px; padding:6px 12px;">âœ¨ Yeni KayÄ±t</span>`;
        diffHtml = `<div class="change-log-box" style="background:#f0fdf4; border-color:#86efac; color:#166534;">Bu Ã¶ÄŸrenci listeye yeni eklendi.</div>`;
      } else if (s.status === "updated") {
        statusHtml = `<span class="status-badge updated" style="font-size:14px; padding:6px 12px;">âœï¸ Bilgileri GÃ¼ncellendi</span>`;
        
        // --- GÃœNCELLEME 3: AKILLI DEÄÄ°ÅÄ°KLÄ°K TARAMA ---
        if (snapshot && snapshot.records && snapshot.records[(s._comparePrevId || s.id)]) {
            const oldData = snapshot.records[(s._comparePrevId || s.id)].data;
            const changes = [];
            // TÃ¼m alanlarÄ± kapsayan geniÅŸletilmiÅŸ harita
            const fields = {
                isim: "Ä°sim",
                soyisim: "Soyisim",
                sinif: "SÄ±nÄ±f",
                okulNo: "Okul No",
                cinsiyet: "Cinsiyet",
                veliAdi: "Veli AdÄ±",
                veliSoyadi: "Veli SoyadÄ±",
                veliTelefon: "Veli Tel",
                yil: "YÄ±l",
                tarih: "KayÄ±t Tarihi",
                burslu: "Burs Durumu"
            };
            
            for(let key in fields) {
                // Stringe Ã§evirip trim yaparak karÅŸÄ±laÅŸtÄ±r (Hassas karÅŸÄ±laÅŸtÄ±rma)
                const oldVal = String(oldData[key] || "").trim();
                const newVal = String(s[key] || "").trim();
                
                if(oldVal !== newVal) {
                    changes.push(`<b>${fields[key]}:</b> <br/> <span style="color:#b91c1c; text-decoration:line-through; font-size:12px;">${oldVal || '(BoÅŸ)'}</span> <span style="margin:0 4px">â</span> <span style="color:#15803d; font-weight:600;">${newVal}</span>`);
                }
            }
            if(changes.length > 0) {
                diffHtml = `<div class="change-log-box">
                    <div style="font-weight:700; margin-bottom:8px;">Tespit Edilen DeÄŸiÅŸiklikler:</div>
                    <ul style="margin:0; padding-left:20px; display:flex; flex-direction:column; gap:6px;">${changes.map(c => `<li>${c}</li>`).join('')}</ul>
                </div>`;
            } else {
                // Veri farklÄ± gÃ¶rÃ¼nse de trim yapÄ±nca aynÄ± olabilir
                diffHtml = `<div class="change-log-box">GÃ¶rÃ¼nÃ¼rde deÄŸiÅŸiklik algÄ±landÄ± ancak biÃ§imsel olabilir.</div>`;
            }
        }
      } else {
        statusHtml = `<span class="status-badge normal" style="font-size:14px; padding:6px 12px;">KayÄ±tlÄ± Ã–ÄŸrenci</span>`;
      }

      // Okul No Ã§akÄ±ÅŸmasÄ± bilgisi (varsa)
      const myNo = String(s.okulNo || "").trim();
      if (myNo && duplicateOkulNoMap && duplicateOkulNoMap[myNo] && duplicateOkulNoMap[myNo].length >= 2) {
        const others = (duplicateOkulNoMap[myNo] || []).filter(x => !(x.id === s.id));
        const listHtml = others.map(x => `<li>${x.isim} ${x.soyisim} <small>(${x.sinif || '-'})</small></li>`).join("");
        dupHtml = `<div class="change-log-box" style="background: var(--danger-bg); border-color: #fca5a5; color: var(--danger-text);">
          <div style="font-weight:800; margin-bottom:6px;">âš ï¸ Okul No Ã‡akÄ±ÅŸmasÄ±</div>
          <div style="font-size:12px; opacity:0.9; margin-bottom:8px;">Bu okul numarasÄ± listede birden fazla Ã¶ÄŸrenciye atanmÄ±ÅŸ.</div>
          <ul style="margin:0; padding-left:20px; display:flex; flex-direction:column; gap:4px;">${listHtml}</ul>
        </div>`;
      }

      content.innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:24px; font-weight:700;">${s.isim} ${s.soyisim}</div>
            <div style="font-size:14px; color:var(--text-muted);">${s.okulNo}</div>
            <div style="margin-top:10px;">${statusHtml}</div>
        </div>

        <div class="detail-row"><span class="detail-label">SÄ±nÄ±f:</span> <span class="detail-val">${s.sinif}</span></div>
        <div class="detail-row"><span class="detail-label">Cinsiyet:</span> <span class="detail-val">${s.cinsiyet}</span></div>
        <div class="detail-row"><span class="detail-label">Veli AdÄ±:</span> <span class="detail-val">${s.veliAdi} ${s.veliSoyadi}</span></div>
        <div class="detail-row"><span class="detail-label">Veli Telefon:</span> <span class="detail-val">${s.veliTelefon || "-"}</span></div>
        <div class="detail-row"><span class="detail-label">KayÄ±t Tarihi:</span> <span class="detail-val">${s.tarih || "-"}</span></div>
        <div class="detail-row"><span class="detail-label">Burs Durumu:</span> <span class="detail-val">${s.burslu ? "Burslu" : "Normal"}</span></div>
        
        ${dupHtml}
        ${diffHtml}
      `;
      
      modal.classList.add("active");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      renderSheetTabs();
      setupEventListeners();
      await loadSnapshot();
      await loadData();
    });
  </script>
</body>
</html>


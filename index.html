<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ã–ÄŸrenci Listesi YÃ¶neticisi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-alt: #ffffff;
      --border: #d1d5db;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-soft: #4b5563;
      --accent: #1f2937;
      --danger: #b91c1c;
      --success: #047857;
      --warning: #b45309;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.1);
      --shadow-subtle: 0 6px 20px rgba(15, 23, 42, 0.06);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #f9fafb, #e5e7eb);
      color: var(--text-main);
    }

    body, html { height: 100%; width: 100%; }

    .app-shell {
      max-width: 1500px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    header.app-header {
      background: rgba(17, 24, 39, 0.96);
      color: #f9fafb;
      border-radius: 26px;
      padding: 22px 26px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      box-shadow: var(--shadow-soft);
    }

    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title-block h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title-block h1 span.icon { font-size: 24px; }

    .app-title-block p {
      margin: 0;
      font-size: 13px;
      color: #d1d5db;
    }

    .header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: #d1d5db;
      align-items: center;
      justify-content: flex-end;
    }

    .chip {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(209, 213, 219, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.82);
    }

    .chip strong { color: #f9fafb; }
    .chip span.icon { font-size: 14px; }

    main.layout-main { display: flex; flex-direction: column; gap: 18px; }

    .panel {
      background: var(--bg-alt);
      border-radius: 22px;
      padding: 18px;
      box-shadow: var(--shadow-subtle);
      border: 1px solid var(--border-soft);
    }

    .panel-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-title-row h2 {
      margin: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title-row h2 span.icon { font-size: 18px; }

    .top-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.5fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      .top-layout { grid-template-columns: 1fr; }
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px 12px;
    }

    @media (max-width: 900px) {
      .filters-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 600px) {
      .filters-grid { grid-template-columns: 1fr; }
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .field-label {
      font-weight: 500;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field-label span.badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="date"],
    select {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 7px 10px;
      font-size: 13px;
      background: #f9fafb;
      color: var(--text-main);
      min-height: 34px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.18);
      background-color: #ffffff;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .checkbox-row input[type="checkbox"] {
      width: 15px;
      height: 15px;
      border-radius: 4px;
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .class-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .class-chips label {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .class-chips input[type="checkbox"] {
      width: 12px;
      height: 12px;
    }

    .controls-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    button.btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #111827;
      color: #f9fafb;
      min-height: 36px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s, border-color 0.12s;
    }

    button.btn span.icon { font-size: 14px; }

    button.btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.38);
      background: #030712;
    }

    button.btn-subtle {
      background: #f3f4f6;
      color: var(--text-soft);
      border-color: var(--border-soft);
    }

    button.btn-subtle:hover {
      background: #e5e7eb;
      color: var(--text-main);
    }

    button.btn-ghost {
      background: #ffffff;
      color: #111827;
      border-color: var(--border-soft);
    }

    button.btn-ghost:hover {
      background: #111827;
      color: #f9fafb;
    }

    button.btn-sm { padding: 7px 12px; font-size: 12px; min-height: 30px; }

    button.btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .summary-card {
      border-radius: 16px;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
    }

    .summary-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-title span.icon { font-size: 14px; }

    .summary-value { font-size: 18px; font-weight: 600; }

    .summary-meta { font-size: 10px; color: var(--text-soft); }

    .summary-card.new { border-color: rgba(4, 120, 87, 0.7); }
    .summary-card.updated { border-color: rgba(180, 83, 9, 0.8); }
    .summary-card.removed { border-color: rgba(185, 28, 28, 0.8); }
    .summary-card.total { border-color: rgba(55, 65, 81, 0.8); }

    .change-lists { margin-top: 8px; font-size: 12px; color: var(--text-soft); }

    .change-lists details {
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: #f9fafb;
      padding: 6px 8px;
      margin-top: 4px;
    }

    .change-lists summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .change-lists summary::-webkit-details-marker { display: none; }

    .change-lists ul {
      margin: 6px 0 0 0;
      padding-left: 14px;
      max-height: 160px;
      overflow: auto;
    }

    .change-lists li { margin-bottom: 3px; }

    .change-lists .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      margin-left: 4px;
    }

    .muted-tip {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .badge-soft {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      color: var(--text-soft);
    }

    .sheet-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      background: #f3f4f6;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 8px;
    }

    .sheet-tab {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
    }

    .sheet-tab span.icon { font-size: 14px; }
    .sheet-tab.active { background: #111827; color: #f9fafb; }

    .table-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .table-toolbar-left,
    .table-toolbar-right {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .view-toggle {
      border-radius: 999px;
      background: #f3f4f6;
      padding: 3px;
      display: inline-flex;
      gap: 4px;
    }

    .view-toggle button {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: var(--text-soft);
    }

    .view-toggle button.active { background: #111827; color: #f9fafb; }

    /* Liste durum Ã§ubuÄŸu */
    .list-status-bar {
      margin: 4px 0 10px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid var(--border-soft);
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .list-status-bar .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
    }

    .list-status-bar strong {
      color: var(--text-main);
      font-weight: 600;
    }

    .list-status-bar .badge-soft {
      font-size: 10px;
    }

    .table-container {
      border-radius: 20px;
      background: #ffffff;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      box-shadow: var(--shadow-subtle);
    }

    .table-scroll {
      max-height: 650px;
      overflow: auto;
      scrollbar-width: thin;
    }

    .table-scroll::-webkit-scrollbar { width: 7px; height: 7px; }
    .table-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 999px; }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 960px;
      font-size: 13px;
    }

    thead { position: sticky; top: 0; z-index: 1; }

    thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      border-bottom: 1px solid var(--border);
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: #4b5563;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) { background: #f9fafb; }
    tbody tr:nth-child(odd) { background: #ffffff; }

    tbody td {
      padding: 7px 8px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      cursor: default;
    }

    tbody td span.muted {
      color: var(--text-soft);
      font-size: 12px;
    }

    tbody tr.new-row { background: #ecfdf5; }
    tbody tr.updated-row { background: #fffbeb; }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .status-pill.new {
      border-color: rgba(4, 120, 87, 0.7);
      color: var(--success);
      background: #f0fdf4;
    }

    .status-pill.updated {
      border-color: rgba(180, 83, 9, 0.7);
      color: var(--warning);
      background: #fffbeb;
    }

    .status-pill.normal {
      border-color: var(--border-soft);
      color: var(--text-soft);
      background: #f9fafb;
    }

    .status-pill span.icon { font-size: 14px; }
    .status-pill span.label { text-transform: uppercase; letter-spacing: 0.08em; }

    .print-options {
      margin-bottom: 6px;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 16px;
      border: 1px dashed var(--border);
      font-size: 11px;
      color: var(--text-soft);
    }

    .print-options .cols {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      margin-top: 4px;
    }

    .print-options label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .print-options input[type="checkbox"] {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .print-hint { font-size: 10px; margin-top: 3px; }

    .col-hidden { display: none; }

    .loading-row td {
      text-align: center;
      padding: 20px 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      border-radius: 999px;
      background: #111827;
      color: #f9fafb;
      padding: 9px 15px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
      z-index: 50;
    }

    .toast.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .toast span.icon { font-size: 14px; }

    @media print {
      body { background: #ffffff; padding: 0; }
      header.app-header,
      .top-layout,
      .table-toolbar,
      .print-options .print-hint,
      .no-print,
      .sheet-tabs,
      .list-status-bar { display: none !important; }
      .app-shell { max-width: none; margin: 0; }
      .panel { box-shadow: none; border-radius: 0; border: none; padding: 0; }
      .table-container { box-shadow: none; border-radius: 0; border: none; }
      .table-scroll { max-height: none; }
      thead th { background: #f3f4f6 !important; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-block">
        <h1><span class="icon">ğŸ“‹</span>Ã–ÄŸrenci Listesi YÃ¶neticisi</h1>
        <p>Google Eâ€‘Tablo verisi + TXT + Firebase ile deÄŸiÅŸiklik takibi.</p>
      </div>
      <div class="header-meta">
        <div class="chip">
          <span class="icon">â¬›</span><strong>Siyah / beyaz / gri tema</strong>
        </div>
        <div class="chip">
          <span class="icon">ğŸ§ </span><span>Firebase + TXT karÅŸÄ±laÅŸtÄ±rma</span>
        </div>
      </div>
    </header>

    <main class="layout-main">
      <section class="panel">
        <div class="panel-title-row">
          <h2><span class="icon">ğŸ›ï¸</span>Filtreler, Ã–zet ve Tablo</h2>
          <span class="badge-soft" id="lastLoadedInfo">Veri yÃ¼kleniyorâ€¦</span>
        </div>

        <!-- Ãœst satÄ±r: solda filtreler, saÄŸda Ã¶zet -->
        <div class="top-layout">
          <!-- FÄ°LTRELER -->
          <div>
            <div class="filters-grid">
              <div class="field-group" style="grid-column:1/-1;">
                <div class="field-label">
                  <span>Genel arama</span>
                  <span class="badge">isim, veli, numaraâ€¦</span>
                </div>
                <input type="text" id="searchInput" placeholder="Ã–rn: 8D, ZEHRA, 9220, KAYAâ€¦" />
              </div>

              <div class="field-group">
                <div class="field-label"><span>Cinsiyet</span></div>
                <select id="genderFilter">
                  <option value="">TÃ¼mÃ¼</option>
                  <option value="KIZ">KÄ±z</option>
                  <option value="ERKEK">Erkek</option>
                </select>
              </div>

              <div class="field-group">
                <div class="field-label"><span>Burs durumu</span></div>
                <select id="scholarFilter">
                  <option value="">TÃ¼mÃ¼</option>
                  <option value="nonempty">Burslu (dolu)</option>
                  <option value="empty">BoÅŸ</option>
                </select>
              </div>

              <div class="field-group">
                <div class="field-label"><span>Durum</span></div>
                <select id="statusFilter">
                  <option value="">Hepsi</option>
                  <option value="new">Sadece yeni</option>
                  <option value="updated">GÃ¼ncellenenler</option>
                  <option value="normal">Normal kayÄ±tlar</option>
                </select>
              </div>

              <div class="field-group">
                <div class="field-label"><span>Tarih &ge;</span></div>
                <input type="date" id="dateFrom" />
              </div>

              <div class="field-group">
                <div class="field-label"><span>Tarih &le;</span></div>
                <input type="date" id="dateTo" />
              </div>

              <!-- YENÄ°: Tarih sÄ±ralama -->
              <div class="field-group">
                <div class="field-label"><span>Tarih sÄ±ralama</span></div>
                <select id="dateSortOrder">
                  <option value="">Otomatik</option>
                  <option value="desc">Yeniden â†’ Eskiye</option>
                  <option value="asc">Eskiden â†’ Yeniye</option>
                </select>
              </div>

              <div class="field-group" style="grid-column:1/-1;">
                <div class="field-label"><span>SÄ±nÄ±f (Ã§oklu seÃ§im)</span></div>
                <div id="classFilterContainer" class="class-chips"></div>
              </div>

              <div class="field-group" style="grid-column:1/-1;">
                <label class="checkbox-row">
                  <input type="checkbox" id="recentOnly" />
                  <span>YalnÄ±zca en yeni kayÄ±tlarÄ± gÃ¶ster (ilk 30)</span>
                </label>
              </div>
            </div>

            <div class="controls-row">
              <button class="btn btn-subtle" id="clearFiltersBtn" type="button">
                <span class="icon">ğŸ§¹</span>Filtreleri temizle
              </button>
              <button class="btn btn-ghost" id="reloadBtn" type="button">
                <span class="icon">ğŸ”„</span>Bu sekmeyi yeniden yÃ¼kle
              </button>
            </div>

            <p class="muted-tip">Herhangi bir hÃ¼creye Ã§ift tÄ±klayarak metni panoya kopyalayabilirsin.</p>
          </div>

          <!-- Ã–ZET -->
          <div>
            <div class="summary-grid">
              <div class="summary-card total">
                <div class="summary-title"><span>Toplam</span><span class="icon">â¬œ</span></div>
                <div class="summary-value" id="totalCount">â€“</div>
                <div class="summary-meta">Tablodaki Ã¶ÄŸrenci sayÄ±sÄ±.</div>
              </div>
              <div class="summary-card new">
                <div class="summary-title"><span>Yeni</span><span class="icon">ğŸ†•</span></div>
                <div class="summary-value" id="newCount">â€“</div>
                <div class="summary-meta">Ã–nceki listeye gÃ¶re yeni.</div>
              </div>
              <div class="summary-card updated">
                <div class="summary-title"><span>GÃ¼ncellendi</span><span class="icon">âœï¸</span></div>
                <div class="summary-value" id="updatedCount">â€“</div>
                <div class="summary-meta">Bilgileri deÄŸiÅŸenler.</div>
              </div>
              <div class="summary-card removed">
                <div class="summary-title"><span>Silinen</span><span class="icon">ğŸ—‘ï¸</span></div>
                <div class="summary-value" id="removedCount">â€“</div>
                <div class="summary-meta">Eski listede olup ÅŸu an olmayanlar.</div>
              </div>
            </div>

            <div class="change-lists">
              <details>
                <summary><span>ğŸ†• Yeni Ã¶ÄŸrenciler</span><span class="tag" id="newTagCount">0</span></summary>
                <ul id="newList"></ul>
              </details>
              <details>
                <summary><span>âœï¸ GÃ¼ncellenen Ã¶ÄŸrenciler</span><span class="tag" id="updatedTagCount">0</span></summary>
                <ul id="updatedList"></ul>
              </details>
              <details>
                <summary><span>ğŸ—‘ï¸ Silinen Ã¶ÄŸrenciler</span><span class="tag" id="removedTagCount">0</span></summary>
                <ul id="removedList"></ul>
              </details>
              <p class="muted-tip">
                <span class="badge-soft" id="lastSavedInfo">Son kaydedilen liste: â€“</span>
                <span class="badge-soft" id="compareSourceLabel">KarÅŸÄ±laÅŸtÄ±rma kaynaÄŸÄ±: Yok</span>
              </p>
            </div>
          </div>
        </div>

        <!-- TABLO ARAÃ‡LARI + TABLONUN KENDÄ°SÄ° -->
        <div style="margin-top: 14px;">
          <div class="sheet-tabs no-print" id="sheetTabs"></div>

          <div class="table-toolbar">
            <div class="table-toolbar-left">
              <div class="view-toggle">
                <button type="button" data-view="all" class="active" id="viewAllBtn">
                  <span class="icon">â¬œ</span><span>TÃ¼m kayÄ±tlar</span>
                </button>
                <button type="button" data-view="new-updated" id="viewNewUpdatedBtn">
                  <span class="icon">âœ¨</span><span>Yeni + GÃ¼ncellenen</span>
                </button>
              </div>
            </div>
            <div class="table-toolbar-right">
              <button class="btn btn-subtle btn-sm no-print" id="saveSnapshotBtn" type="button">
                <span class="icon">ğŸ’¾</span>Bu listeyi Firebase'e kaydet
              </button>
              <button class="btn btn-subtle btn-sm no-print" id="downloadTxtBtn" type="button">
                <span class="icon">ğŸ“¥</span>TXT indir
              </button>
              <button class="btn btn-subtle btn-sm no-print" id="uploadTxtBtn" type="button">
                <span class="icon">ğŸ“¤</span>TXT yÃ¼kle & karÅŸÄ±laÅŸtÄ±r
              </button>
              <button class="btn btn-ghost btn-sm no-print" id="printBtn" type="button">
                <span class="icon">ğŸ–¨ï¸</span>YazdÄ±r
              </button>
            </div>
          </div>

          <!-- Filtreye gÃ¶re Ã¶ÄŸrenci sayÄ±sÄ± durum Ã§ubuÄŸu -->
          <div class="list-status-bar no-print" id="listStatusBar">
            <span class="dot"></span>
            <span>Liste durumu yÃ¼kleniyorâ€¦</span>
          </div>

          <input type="file" id="uploadTxtInput" accept=".txt,.json" style="display:none;" />

          <div class="print-options no-print">
            <div><strong>YazdÄ±rma seÃ§enekleri</strong> ğŸ–¨ï¸</div>
            <div class="print-hint">
              YazdÄ±r'a bastÄ±ÄŸÄ±nda sadece seÃ§ili kolonlar gÃ¶rÃ¼nÃ¼r. Filtreler ne gÃ¶rÃ¼yorsan ona gÃ¶re uygulanÄ±r.
            </div>
            <div class="cols" id="printColsContainer"></div>
          </div>

          <div class="table-container">
            <div class="table-scroll">
              <table id="studentsTable">
                <thead>
                  <tr id="tableHeaderRow"></tr>
                </thead>
                <tbody id="tableBody">
                  <tr class="loading-row">
                    <td>Veri yÃ¼kleniyorâ€¦</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span class="icon">ğŸ“</span>
    <span id="toastMessage">Metin kopyalandÄ±.</span>
  </div>

  <!--
    This script has been converted into an ES module so that we can
    import Firebase libraries and remove all usages of browser localStorage.
    Snapshot persistence is now handled via Firebase Realtime Database.
  -->
  <script type="module">
    // =======================
    // KONFÄ°GÃœRASYON
    // =======================
    const SHEET_ID = "16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi";

    // Sadece burayÄ± kendine gÃ¶re dÃ¼zenle:
    const SHEET_TABS = [
      { name: "2025-2026", label: "2025-2026" }
    ];

    let currentSheetName = SHEET_TABS[0].name;
    const STORAGE_KEY_BASE = "ogrenci_listesi_snapshot_v3_";

    const COLUMNS = [
      { key: "status",   label: "Durum" },
      { key: "isim",     label: "Ä°sim" },
      { key: "soyisim",  label: "Soyisim" },
      { key: "cinsiyet", label: "Cinsiyet" },
      { key: "sinif",    label: "SÄ±nÄ±f" },
      { key: "okulNo",   label: "Okul NumarasÄ±" },
      { key: "veliAdi",  label: "Veli AdÄ±" },
      { key: "veliSoyadi", label: "Veli SoyadÄ±" },
      { key: "veliTelefon", label: "Veli Telefon" },
      { key: "yil",      label: "YÄ±l" },
      { key: "tarih",    label: "Tarih" },
      { key: "burslu",   label: "Burslu mu?" }
    ];

    let students = [];
    let snapshot = null;
let snapshotSource = "none"; // none | firebase | file
    let activeViewMode = "all";  // all | new-updated

    // =======================
    // FIREBASE KURULUMU
    // =======================
    // Firebase modÃ¼llerini dÄ±ÅŸarÄ±dan import ediyoruz.  Versiyonlar
    // Firebase JS SDK 9.0+ ile uyumludur.  Proje yapÄ±landÄ±rmasÄ±
    // kullanÄ±cÄ± tarafÄ±ndan saÄŸlanmÄ±ÅŸtÄ±r.
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };

    // UygulamayÄ± baÅŸlat ve servisleri al.  Bu satÄ±rlar, uygulamanÄ±n
    // ilk yÃ¼klenme sÄ±rasÄ±nda yalnÄ±zca bir kez Ã§alÄ±ÅŸtÄ±rÄ±lacaktÄ±r.
    const firebaseApp = initializeApp(firebaseConfig);
    const firebaseAnalytics = getAnalytics(firebaseApp);
    const firebaseDb = getDatabase(firebaseApp);

    // Firebase iÃ§erisinde snapshot'larÄ±n tutulduÄŸu temel yol.  Her sekme
    // ismi bu yolun altÄ±na encode edilerek kaydedilecektir.
    const FIREBASE_BASE_PATH = 'snapshots';

    // =======================
    // ARAÃ‡ FONKSÄ°YONLAR
    // =======================
    function getSheetCsvUrl(sheetName) {
      return "https://docs.google.com/spreadsheets/d/" +
        SHEET_ID +
        "/gviz/tq?tqx=out:csv&sheet=" +
        encodeURIComponent(sheetName);
    }

    function getStorageKey() {
      return STORAGE_KEY_BASE + (currentSheetName || "default");
    }

    /**
     * Aktif sekme iÃ§in Firebase Realtime Database referansÄ±nÄ± dÃ¶ndÃ¼rÃ¼r.
     * Sekme isimlerini gÃ¼venli bir URL parÃ§asÄ± haline getirmek iÃ§in
     * encodeURIComponent kullanÄ±lÄ±r.  EÄŸer sekme adÄ± boÅŸ veya tanÄ±mlÄ±
     * deÄŸilse "default" kullanÄ±lÄ±r.
     */
    function getSnapshotRef() {
      const name = currentSheetName || 'default';
      // Firebase yol ayracÄ± olarak "/" kullandÄ±ÄŸÄ±ndan, encode edilmiÅŸ
      // bir isim kullanmak Ã¶nemlidir.  encodeURIComponent ayrÄ±ca boÅŸluk
      // ve Ã¶zel karakterleri de kaÃ§Ä±rÄ±r.
      const safeName = encodeURIComponent(name);
      return ref(firebaseDb, `${FIREBASE_BASE_PATH}/${safeName}`);
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      document.getElementById("toastMessage").textContent = message;
      toast.classList.add("visible");
      setTimeout(() => toast.classList.remove("visible"), 2000);
    }

    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
        } else if (c === '"') {
          inQuotes = !inQuotes;
        } else if (c === "," && !inQuotes) {
          currentRow.push(current);
          current = "";
        } else if ((c === "\n" || c === "\r") && !inQuotes) {
          if (current !== "" || currentRow.length > 0) {
            currentRow.push(current);
            rows.push(currentRow);
            currentRow = [];
            current = "";
          }
        } else {
          current += c;
        }
      }
      if (current !== "" || currentRow.length > 0) {
        currentRow.push(current);
        rows.push(currentRow);
      }
      return rows.filter(r => r.length > 0);
    }

    function parseDateTR(str) {
      if (!str) return null;
      const parts = str.trim().split(".");
      if (parts.length !== 3) return null;
      const [g, a, y] = parts.map(p => parseInt(p, 10));
      if (isNaN(g) || isNaN(a) || isNaN(y)) return null;
      return new Date(y, a - 1, g);
    }

    function formatDateTimeForBadge(isoString) {
      if (!isoString) return "â€“";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "â€“";
      const datePart = d.toLocaleDateString("tr-TR", {
        year: "numeric", month: "2-digit", day: "2-digit"
      });
      const timePart = d.toLocaleTimeString("tr-TR", {
        hour: "2-digit", minute: "2-digit"
      });
      return `${datePart} ${timePart}`;
    }

    function createStudentId(row) {
      const num = (row.okulNo || "").trim();
      const name = (row.isim || "").trim().toUpperCase();
      const surname = (row.soyisim || "").trim().toUpperCase();
      if (num) return `${num}__${name}__${surname}`;
      return `${name}__${surname}`;
    }

    /**
     * Derin eÅŸitlik kontrolÃ¼, JSON.stringify kullanmak yerine anahtar
     * sÄ±ralamasÄ±nÄ± ve deÄŸerleri tek tek karÅŸÄ±laÅŸtÄ±rÄ±r.  Firebase'den gelen
     * nesnelerde anahtarlarÄ±n sÄ±rasÄ± farklÄ± olabildiÄŸi iÃ§in eski yÃ¶ntem
     * tÃ¼m kayÄ±tlarÄ± "gÃ¼ncellendi" ÅŸeklinde iÅŸaretliyordu.  Bu fonksiyon
     * anahtarlarÄ± alfabetik olarak sÄ±ralayÄ±p her birinin deÄŸerini karÅŸÄ±laÅŸtÄ±rÄ±r.
     *
     * @param {Object} a Ä°lk nesne
     * @param {Object} b Ä°kinci nesne
     * @returns {boolean} Nesneler eÅŸitse true, deÄŸilse false
     */
    function deepEqual(a, b) {
      // Her iki nesne de tanÄ±mlÄ± olmalÄ±
      if (a === null || b === null || typeof a !== 'object' || typeof b !== 'object') {
        return a === b;
      }
      const keysA = Object.keys(a).sort();
      const keysB = Object.keys(b).sort();
      if (keysA.length !== keysB.length) return false;
      for (let i = 0; i < keysA.length; i++) {
        const keyA = keysA[i];
        const keyB = keysB[i];
        if (keyA !== keyB) return false;
        const valA = a[keyA];
        const valB = b[keyB];
        // Basit tipler veya null/undefined iÃ§in doÄŸrudan eÅŸitlik
        if (valA === null || valB === null || typeof valA !== 'object' || typeof valB !== 'object') {
          if (valA !== valB) return false;
        } else {
          // Ã–zyinelemeli karÅŸÄ±laÅŸtÄ±rma
          if (!deepEqual(valA, valB)) return false;
        }
      }
      return true;
    }

    // =======================
    // SNAPSHOT YAPISI
    // =======================
    function buildSnapshotObject(currentStudents) {
      const records = {};
      currentStudents.forEach(s => {
        records[s.id] = {
          id: s.id,
          data: {
            isim: s.isim,
            soyisim: s.soyisim,
            cinsiyet: s.cinsiyet,
            sinif: s.sinif,
            okulNo: s.okulNo,
            veliAdi: s.veliAdi,
            veliSoyadi: s.veliSoyadi,
            veliTelefon: s.veliTelefon,
            yil: s.yil,
            tarih: s.tarih,
            burslu: s.burslu
          }
        };
      });
      return {
        savedAt: new Date().toISOString(),
        sheetName: currentSheetName,
        records
      };
    }

    function updateSnapshotLabels() {
      const lastSavedInfo = document.getElementById("lastSavedInfo");
      const compareLabel = document.getElementById("compareSourceLabel");

      if (!snapshot) {
        lastSavedInfo.textContent = "Son kaydedilen liste: HenÃ¼z yok";
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma kaynaÄŸÄ±: Yok";
        return;
      }

      const count = Object.keys(snapshot.records || {}).length;
      lastSavedInfo.textContent =
        "Son kaydedilen liste: " +
        formatDateTimeForBadge(snapshot.savedAt) +
        ` (${count} Ã¶ÄŸrenci, sekme: ${snapshot.sheetName || "-"})`;

      if (snapshotSource === "firebase") {
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma kaynaÄŸÄ±: Firebase veritabanÄ±";
      } else if (snapshotSource === "local") {
        // localStorage sÃ¼rÃ¼mÃ¼ artÄ±k kullanÄ±lmÄ±yor ancak eski
        // kayÄ±tlarÄ± aÃ§Ä±klamak iÃ§in bu koÅŸul bÄ±rakÄ±lmÄ±ÅŸtÄ±r.
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma kaynaÄŸÄ±: TarayÄ±cÄ± hafÄ±zasÄ± (localStorage)";
      } else if (snapshotSource === "file") {
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma kaynaÄŸÄ±: YÃ¼klenen TXT dosyasÄ±";
      } else {
        compareLabel.textContent = "KarÅŸÄ±laÅŸtÄ±rma kaynaÄŸÄ±: Yok";
      }
    }

    /**
     * Firebase Ã¼zerinden mevcut sekmenin snapshot bilgisini okur.  EÄŸer
     * veritabanÄ±nda kayÄ±t yoksa snapshot ve snapshotSource "none" olarak
     * ayarlanÄ±r.  BaÅŸarÄ±lÄ± okuma sonrasÄ±nda snapshotSource "firebase"
     * olur.  Hata durumunda Ã¶nceki veriler silinir ve kullanÄ±cÄ±ya
     * bildirilecek ÅŸekilde etiketler gÃ¼ncellenir.
     */
    async function loadSnapshot() {
      try {
        const snapRef = getSnapshotRef();
        const snapData = await get(snapRef);
        if (!snapData.exists()) {
          snapshot = null;
          snapshotSource = "none";
          updateSnapshotLabels();
          return;
        }
        snapshot = snapData.val();
        snapshotSource = "firebase";
        updateSnapshotLabels();
      } catch (e) {
        console.error("Snapshot yÃ¼klenemedi", e);
        snapshot = null;
        snapshotSource = "none";
        updateSnapshotLabels();
      }
    }

    /**
     * Verilen Ã¶ÄŸrenci listesine gÃ¶re snapshot oluÅŸturur ve Firebase'e
     * kaydeder.  KayÄ±t tamamlandÄ±ktan sonra snapshot ve snapshotSource
     * gÃ¼ncellenir.  Hata durumunda kullanÄ±cÄ±ya bilgi verilir.
     */
    async function saveSnapshot(currentStudents) {
      const snap = buildSnapshotObject(currentStudents);
      try {
        const snapRef = getSnapshotRef();
        await set(snapRef, snap);
        snapshot = snap;
        snapshotSource = "firebase";
        updateSnapshotLabels();
        showToast("Bu sekmenin listesi Firebase'e kaydedildi.");
      } catch (e) {
        console.error("Snapshot kaydedilemedi", e);
        showToast("Liste kaydedilirken bir hata oluÅŸtu.");
      }
    }

    function applySnapshotFromFile(obj) {
      if (!obj || !obj.records) {
        showToast("TXT iÃ§eriÄŸi beklenen formatta deÄŸil.");
        return;
      }
      snapshot = obj;
      snapshotSource = "file";
      updateSnapshotLabels();
      showToast("TXT dosyasÄ± yÃ¼klendi, karÅŸÄ±laÅŸtÄ±rma bu dosyaya gÃ¶re yapÄ±lÄ±yor.");
      loadData(); // tekrar oku ve bu snapshot ile karÅŸÄ±laÅŸtÄ±r
    }

    // =======================
    // VERÄ° YÃœKLEME
    // =======================
    async function loadData() {
      const body = document.getElementById("tableBody");
      body.innerHTML =
        '<tr class="loading-row"><td>Google E-Tablo â†’ CSV verisi okunuyorâ€¦</td></tr>';
      document.getElementById("lastLoadedInfo").textContent = "Veri yÃ¼kleniyorâ€¦";

      try {
        const url = getSheetCsvUrl(currentSheetName);
        const res = await fetch(url);
        if (!res.ok) throw new Error("AÄŸ hatasÄ±: " + res.status);
        const text = await res.text();

        if (text.startsWith("<")) {
          throw new Error("CSV yerine HTML dÃ¶ndÃ¼. PaylaÅŸÄ±m ayarlarÄ±nÄ± kontrol et.");
        }

        const rows = parseCSV(text);
        if (!rows.length) {
          body.innerHTML =
            '<tr class="loading-row"><td>CSV iÃ§eriÄŸi boÅŸ gÃ¶rÃ¼nÃ¼yor.</td></tr>';
          updateListStatus([]); // boÅŸ liste
          return;
        }

        const header = rows[0].map(h => h.trim());
        const dataRows = rows.slice(1).filter(r =>
          r.some(cell => cell.trim() !== "")
        );

        const headerIndex = name => header.indexOf(name);

        const idxIsim    = headerIndex("Ä°sim") === -1 ? 0 : headerIndex("Ä°sim");
        const idxSoy     = headerIndex("Soyisim*");
        const idxCins    = headerIndex("Cinsiyet*");
        const idxSinif   = headerIndex("SÄ±nÄ±f");
        const idxOkulNo  = headerIndex("Okul NumarasÄ±");
        const idxVeliAd  = headerIndex("Veli AdÄ±");
        const idxVeliSoy = headerIndex("Veli SoyadÄ±");
        const idxVeliTel = headerIndex("Veli Telefon");
        const idxYil     = headerIndex("YIL");
        const idxTarih   = headerIndex("Tarih");
        const idxBurs    = headerIndex("Burslu mu?");

        const parsed = dataRows.map(row => {
          const s = {
            isim:        (row[idxIsim]    || "").trim(),
            soyisim:     (row[idxSoy]     || "").trim(),
            cinsiyet:    (row[idxCins]    || "").trim().toUpperCase(),
            sinif:       (row[idxSinif]   || "").trim(),
            okulNo:      (row[idxOkulNo]  || "").trim(),
            veliAdi:     (row[idxVeliAd]  || "").trim(),
            veliSoyadi:  (row[idxVeliSoy] || "").trim(),
            veliTelefon: (row[idxVeliTel] || "").trim(),
            yil:         (row[idxYil]     || "").trim(),
            tarih:       (row[idxTarih]   || "").trim(),
            burslu:      (row[idxBurs]    || "").trim()
          };
          s.id = createStudentId(s);
          s.dateObj = parseDateTR(s.tarih);
          s.status = "normal";
          return s;
        });

        let removed = [];
        if (snapshot && snapshot.records) {
          const prevMap = snapshot.records;
          const currentIds = new Set(parsed.map(s => s.id));

          parsed.forEach(s => {
            const prev = prevMap[s.id];
            if (!prev) {
              s.status = "new";
            } else {
              const prevData = prev.data;
              const currentSlim = {
                isim: s.isim,
                soyisim: s.soyisim,
                cinsiyet: s.cinsiyet,
                sinif: s.sinif,
                okulNo: s.okulNo,
                veliAdi: s.veliAdi,
                veliSoyadi: s.veliSoyadi,
                veliTelefon: s.veliTelefon,
                yil: s.yil,
                tarih: s.tarih,
                burslu: s.burslu
              };
              if (!deepEqual(prevData, currentSlim)) {
                s.status = "updated";
              }
            }
          });

          for (const prevId in prevMap) {
            if (!currentIds.has(prevId)) {
              removed.push(prevMap[prevId]);
            }
          }
        }

        students = parsed;

        renderHeader();
        populateFilters();
        updateSummary(removed);
        applyFilters(removed);

        document.getElementById("lastLoadedInfo").textContent =
          `Sekme: ${currentSheetName} | Son yÃ¼kleme: ${formatDateTimeForBadge(new Date().toISOString())}`;
      } catch (err) {
        console.error(err);
        body.innerHTML =
          '<tr class="loading-row"><td>Veri yÃ¼klenirken hata oluÅŸtu: ' +
          (err.message || err) +
          "</td></tr>";
        document.getElementById("lastLoadedInfo").textContent =
          "Veri yÃ¼klenirken hata oluÅŸtu.";
        updateListStatus([]);
      }
    }

    // =======================
    // ARAYÃœZ OLUÅTURMA
    // =======================
    function renderSheetTabs() {
      const container = document.getElementById("sheetTabs");
      container.innerHTML = "";
      SHEET_TABS.forEach(tab => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sheet-tab";
        if (tab.name === currentSheetName) btn.classList.add("active");
        btn.innerHTML = `<span class="icon">ğŸ“‘</span><span>${tab.label}</span>`;
        // Sekme butonuna tÄ±klandÄ±ÄŸÄ±nda Ã¶nce Firebase'den snapshot
        // yÃ¼klenir, ardÄ±ndan arayÃ¼z ve veri listesi yenilenir.  Bu
        // iÅŸlemler sÄ±rayla yapÄ±labilmesi iÃ§in handler async tanÄ±mlanÄ±r.
        btn.addEventListener("click", async () => {
          if (currentSheetName === tab.name) return;
          currentSheetName = tab.name;
          await loadSnapshot();
          renderSheetTabs();
          await loadData();
        });
        container.appendChild(btn);
      });
    }

    function renderHeader() {
      const headerRow = document.getElementById("tableHeaderRow");
      headerRow.innerHTML = "";
      COLUMNS.forEach((col, index) => {
        const th = document.createElement("th");
        th.textContent = col.label;
        th.dataset.field = col.key;
        th.dataset.colIndex = index;
        headerRow.appendChild(th);
      });

      const printContainer = document.getElementById("printColsContainer");
      printContainer.innerHTML = "";
      COLUMNS.forEach(col => {
        const id = "print-col-" + col.key;
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" data-field="${col.key}" checked />
          <span>${col.label}</span>
        `;
        printContainer.appendChild(label);
      });
    }

    function populateFilters() {
      const container = document.getElementById("classFilterContainer");
      const classes = Array.from(new Set(students.map(s => s.sinif).filter(Boolean))).sort();
      container.innerHTML = "";
      classes.forEach(cls => {
        const id = "class-filter-" + cls.replace(/\s+/g, "_");
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" value="${cls}">
          <span>${cls}</span>
        `;
        container.appendChild(label);
      });
    }

    function getSelectedClasses() {
      const boxes = document.querySelectorAll("#classFilterContainer input[type='checkbox']");
      const selected = [];
      boxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
      return selected;
    }

    function updateSummary(removedRecords = []) {
      const total = students.length;
      const newCount = students.filter(s => s.status === "new").length;
      const updatedCount = students.filter(s => s.status === "updated").length;
      const removedCount = removedRecords.length;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("newCount").textContent = newCount;
      document.getElementById("updatedCount").textContent = updatedCount;
      document.getElementById("removedCount").textContent = removedCount;

      document.getElementById("newTagCount").textContent = newCount;
      document.getElementById("updatedTagCount").textContent = updatedCount;
      document.getElementById("removedTagCount").textContent = removedCount;

      const newList = document.getElementById("newList");
      const updatedList = document.getElementById("updatedList");
      const removedList = document.getElementById("removedList");
      newList.innerHTML = "";
      updatedList.innerHTML = "";
      removedList.innerHTML = "";

      students.filter(s => s.status === "new").forEach(s => {
        const li = document.createElement("li");
        li.textContent = `${s.okulNo || "â€“"} â€¢ ${s.isim} ${s.soyisim} (${s.sinif})`;
        newList.appendChild(li);
      });

      students.filter(s => s.status === "updated").forEach(s => {
        const li = document.createElement("li");
        li.textContent = `${s.okulNo || "â€“"} â€¢ ${s.isim} ${s.soyisim} (${s.sinif})`;
        updatedList.appendChild(li);
      });

      removedRecords.forEach(r => {
        const d = r.data || {};
        const li = document.createElement("li");
        li.innerHTML = `${d.okulNo || "â€“"} â€¢ ${d.isim || ""} ${d.soyisim || ""} <span class="pill">${d.sinif || ""}</span>`;
        removedList.appendChild(li);
      });
    }

    // FiltrelenmiÅŸ liste iÃ§in durum Ã§ubuÄŸunu gÃ¼ncelle
    function updateListStatus(filteredRows) {
      const bar = document.getElementById("listStatusBar");
      if (!bar) return;

      const total = students.length;
      const visible = filteredRows ? filteredRows.length : 0;

      let newCountFiltered = 0;
      let updatedCountFiltered = 0;
      if (filteredRows && filteredRows.length) {
        filteredRows.forEach(s => {
          if (s.status === "new") newCountFiltered++;
          else if (s.status === "updated") updatedCountFiltered++;
        });
      }

      const recentOnly = document.getElementById("recentOnly").checked;

      const parts = [];
      parts.push(`<strong>${visible}</strong> Ã¶ÄŸrenci gÃ¶steriliyor`);
      parts.push(`(toplam listede <strong>${total}</strong> Ã¶ÄŸrenci var)`);

      if (newCountFiltered || updatedCountFiltered) {
        parts.push(`â€” filtreye gÃ¶re: yeni <strong>${newCountFiltered}</strong>, gÃ¼ncel <strong>${updatedCountFiltered}</strong>`);
      }

      if (recentOnly && visible >= 30) {
        parts.push(`â€” <span class="badge-soft">"YalnÄ±zca en yeni 30" aktif</span>`);
      }

      bar.innerHTML = `<span class="dot"></span><span>${parts.join(" ")}</span>`;
    }

    function applyFilters(removedRecords = []) {
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
      const genderVal = document.getElementById("genderFilter").value;
      const scholarVal = document.getElementById("scholarFilter").value;
      const statusVal = document.getElementById("statusFilter").value;
      const recentOnly = document.getElementById("recentOnly").checked;
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;
      const selectedClasses = getSelectedClasses();
      const dateSortOrder = document.getElementById("dateSortOrder").value; // YENÄ°

      let fromDate = null;
      let toDate = null;
      if (dateFromVal) fromDate = new Date(dateFromVal + "T00:00:00");
      if (dateToVal)   toDate   = new Date(dateToVal   + "T23:59:59");

      let filtered = students.slice();

      filtered = filtered.filter(s => {
        if (activeViewMode === "new-updated" && !(s.status === "new" || s.status === "updated")) {
          return false;
        }

        if (statusVal) {
          if (statusVal === "normal" && s.status !== "normal") return false;
          if (statusVal === "new" && s.status !== "new") return false;
          if (statusVal === "updated" && s.status !== "updated") return false;
        }

        if (selectedClasses.length && !selectedClasses.includes(s.sinif)) return false;
        if (genderVal && s.cinsiyet !== genderVal) return false;

        if (scholarVal === "nonempty" && !s.burslu) return false;
        if (scholarVal === "empty" && s.burslu) return false;

        if (fromDate && s.dateObj && s.dateObj < fromDate) return false;
        if (toDate && s.dateObj && s.dateObj > toDate) return false;

        if (searchText) {
          const combined = [
            s.isim, s.soyisim, s.cinsiyet, s.sinif,
            s.okulNo, s.veliAdi, s.veliSoyadi, s.veliTelefon,
            s.yil, s.tarih, s.burslu
          ].join(" ").toLowerCase();
          if (!combined.includes(searchText)) return false;
        }
        return true;
      });

      // SÄ±ralama
      const statusOrder = { new: 0, updated: 1, normal: 2 };

      if (dateSortOrder === "desc" || dateSortOrder === "asc") {
        // Tarihe gÃ¶re sÄ±ralama (yeniden eskiye / eskiden yeniye)
        filtered.sort((a, b) => {
          const da = a.dateObj;
          const db = b.dateObj;

          if (da && db && da.getTime() !== db.getTime()) {
            return dateSortOrder === "desc" ? db - da : da - db;
          } else if (da && !db) {
            return -1;
          } else if (!da && db) {
            return 1;
          }

          const sa = statusOrder[a.status] ?? 2;
          const sb = statusOrder[b.status] ?? 2;
          if (sa !== sb) return sa - sb;

          const ya = parseInt(a.yil || "0", 10);
          const yb = parseInt(b.yil || "0", 10);
          if (ya !== yb) return yb - ya;

          const na = parseInt(a.okulNo || "0", 10);
          const nb = parseInt(b.okulNo || "0", 10);
          return nb - na;
        });
      } else {
        // Eski davranÄ±ÅŸ: Yeni â†’ GÃ¼ncellenen â†’ Normal, sonra tarih/yÄ±l/okul no
        filtered.sort((a, b) => {
          const sa = statusOrder[a.status] ?? 2;
          const sb = statusOrder[b.status] ?? 2;
          if (sa !== sb) return sa - sb;

          const da = a.dateObj;
          const db = b.dateObj;
          if (da && db && da.getTime() !== db.getTime()) return db - da;

          const ya = parseInt(a.yil || "0", 10);
          const yb = parseInt(b.yil || "0", 10);
          if (ya !== yb) return yb - ya;

          const na = parseInt(a.okulNo || "0", 10);
          const nb = parseInt(b.okulNo || "0", 10);
          return nb - na;
        });
      }

      if (recentOnly && filtered.length > 30) {
        filtered = filtered.slice(0, 30);
      }

      renderTable(filtered);
      updateSummary(removedRecords);
      updateListStatus(filtered);
    }

    function renderTable(rows) {
      const body = document.getElementById("tableBody");
      body.innerHTML = "";

      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.className = "loading-row";
        const td = document.createElement("td");
        td.colSpan = COLUMNS.length;
        td.textContent = "Filtre sonuÃ§larÄ±na gÃ¶re gÃ¶sterilecek Ã¶ÄŸrenci yok.";
        tr.appendChild(td);
        body.appendChild(tr);
        return;
      }

      rows.forEach(s => {
        const tr = document.createElement("tr");
        if (s.status === "new") tr.classList.add("new-row");
        if (s.status === "updated") tr.classList.add("updated-row");

        COLUMNS.forEach((col, index) => {
          const td = document.createElement("td");
          td.dataset.field = col.key;
          td.dataset.colIndex = index;

          if (col.key === "status") {
            const pill = document.createElement("span");
            pill.className = "status-pill normal";
            let icon = "â¬œ";
            let text = "NORMAL";
            if (s.status === "new") {
              pill.className = "status-pill new";
              icon = "ğŸ†•";
              text = "YENÄ°";
            } else if (s.status === "updated") {
              pill.className = "status-pill updated";
              icon = "âœï¸";
              text = "GÃœNCEL";
            }
            pill.innerHTML = `<span class="icon">${icon}</span><span class="label">${text}</span>`;
            td.appendChild(pill);
          } else {
            let value = s[col.key] || "";
            if (col.key === "veliTelefon" && value) {
              const span = document.createElement("span");
              span.textContent = value;
              span.className = "muted";
              td.appendChild(span);
            } else {
              td.textContent = value;
            }
          }

          tr.appendChild(td);
        });

        body.appendChild(tr);
      });

      syncPrintColumnVisibility();
    }

    function syncPrintColumnVisibility() {
      const rows = document.querySelectorAll("#studentsTable tr");
      const checkboxes = document.querySelectorAll(
        "#printColsContainer input[type='checkbox']"
      );

      const hiddenFields = new Set();
      checkboxes.forEach(cb => {
        const field = cb.dataset.field;
        if (!cb.checked) hiddenFields.add(field);
      });

      rows.forEach(tr => {
        Array.from(tr.children).forEach(cell => {
          const field = cell.dataset.field;
          if (!field) return;
          if (hiddenFields.has(field)) {
            cell.classList.add("col-hidden");
          } else {
            cell.classList.remove("col-hidden");
          }
        });
      });
    }

    // =======================
    // ETKÄ°NLÄ°KLER
    // =======================
    function setupEventListeners() {
      document.getElementById("searchInput").addEventListener("input", () => applyFilters());
      document.getElementById("genderFilter").addEventListener("change", () => applyFilters());
      document.getElementById("scholarFilter").addEventListener("change", () => applyFilters());
      document.getElementById("statusFilter").addEventListener("change", () => applyFilters());
      document.getElementById("dateFrom").addEventListener("change", () => applyFilters());
      document.getElementById("dateTo").addEventListener("change", () => applyFilters());
      document.getElementById("recentOnly").addEventListener("change", () => applyFilters());
      document.getElementById("dateSortOrder").addEventListener("change", () => applyFilters()); // YENÄ°

      document.getElementById("classFilterContainer").addEventListener("change", () => applyFilters());

      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        document.getElementById("genderFilter").value = "";
        document.getElementById("scholarFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        document.getElementById("recentOnly").checked = false;
        document.getElementById("dateSortOrder").value = ""; // YENÄ°
        document.querySelectorAll("#classFilterContainer input[type='checkbox']").forEach(cb => cb.checked = false);
        applyFilters();
      });

      document.getElementById("reloadBtn").addEventListener("click", () => loadData());

      document.getElementById("saveSnapshotBtn").addEventListener("click", async () => {
        // Kaydetme iÅŸlemini bekleyerek kullanÄ±cÄ±ya doÄŸru geri bildirim ver.
        await saveSnapshot(students);
      });

      document.getElementById("printBtn").addEventListener("click", () => {
        syncPrintColumnVisibility();
        window.print();
      });

      document.getElementById("printColsContainer").addEventListener("change", () => {
        syncPrintColumnVisibility();
      });

      document.getElementById("viewAllBtn").addEventListener("click", () => {
        activeViewMode = "all";
        document.getElementById("viewAllBtn").classList.add("active");
        document.getElementById("viewNewUpdatedBtn").classList.remove("active");
        applyFilters();
      });

      document.getElementById("viewNewUpdatedBtn").addEventListener("click", () => {
        activeViewMode = "new-updated";
        document.getElementById("viewNewUpdatedBtn").classList.add("active");
        document.getElementById("viewAllBtn").classList.remove("active");
        applyFilters();
      });

      // Ã‡ift tÄ±klama ile hÃ¼cre kopyalama
      document.getElementById("tableBody").addEventListener("dblclick", async e => {
        const cell = e.target.closest("td");
        if (!cell) return;
        const text = cell.innerText.trim();
        if (!text) return;
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const tmp = document.createElement("textarea");
            tmp.value = text;
            document.body.appendChild(tmp);
            tmp.select();
            document.execCommand("copy");
            document.body.removeChild(tmp);
          }
          showToast("Metin panoya kopyalandÄ±.");
        } catch (err) {
          console.error(err);
          showToast("Kopyalama sÄ±rasÄ±nda hata oluÅŸtu.");
        }
      });

      // TXT indir
      document.getElementById("downloadTxtBtn").addEventListener("click", () => {
        if (!students.length) {
          showToast("Ä°ndirilecek liste yok.");
          return;
        }
        const snap = buildSnapshotObject(students);
        const blob = new Blob([JSON.stringify(snap, null, 2)], {
          type: "text/plain;charset=utf-8"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const safeName = (currentSheetName || "liste").replace(/[^0-9A-Za-z_-]/g, "_");
        a.href = url;
        a.download = `ogrenci_listesi_${safeName}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("TXT dosyasÄ± indirildi.");
      });

      // TXT yÃ¼kle
      const uploadInput = document.getElementById("uploadTxtInput");
      document.getElementById("uploadTxtBtn").addEventListener("click", () => {
        uploadInput.value = "";
        uploadInput.click();
      });
      uploadInput.addEventListener("change", e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(reader.result);
            applySnapshotFromFile(obj);
          } catch (err) {
            console.error(err);
            showToast("TXT iÃ§eriÄŸi okunamadÄ± (JSON parse hatasÄ±).");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    // =======================
    // BAÅLAT
    // =======================
    document.addEventListener("DOMContentLoaded", async () => {
      // Sayfa yÃ¼klendiÄŸinde sekmeleri ve olay dinleyicilerini hazÄ±rla.
      renderSheetTabs();
      setupEventListeners();
      // Snapshot'Ä± Firebase'den yÃ¼klemeden Ã¶nce bekleyerek ardÄ±ndan veriyi yÃ¼kle.
      await loadSnapshot();
      await loadData();
    });
  </script>
</body>
</html>

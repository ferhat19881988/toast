<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>√ñƒürenci Listesi Y√∂neticisi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Modern Renk Paleti */
      --primary: #4f46e5;      /* Indigo 600 */
      --primary-dark: #4338ca; /* Indigo 700 */
      --primary-light: #e0e7ff;/* Indigo 100 */
      
      --bg-body: #f1f5f9;      /* Slate 100 */
      --bg-card: #ffffff;
      
      --text-main: #0f172a;    /* Slate 900 */
      --text-muted: #64748b;   /* Slate 500 */
      
      --border: #e2e8f0;       /* Slate 200 */
      
      /* Durum Renkleri */
      --success-bg: #dcfce7;
      --success-text: #166534;
      --warning-bg: #fef9c3;
      --warning-text: #854d0e;
      --danger-bg: #fee2e2;
      --danger-text: #991b1b;

      /* G√∂lgeler */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }

    /* Layout & Shell */
    .app-shell {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Header */
    header.app-header {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px 32px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .app-title-block h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-title-block h1 span.icon { 
      background: var(--primary-light);
      color: var(--primary);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      font-size: 24px;
    }

    .app-title-block p {
      margin: 4px 0 0 0;
      font-size: 14px;
      color: var(--text-muted);
    }

    .header-meta {
      display: flex;
      gap: 12px;
    }

    .chip {
      background: var(--bg-body);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 99px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Main Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* Panels */
    .panel {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      height: 100%;
    }

    .panel-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Stats Cards (Big & Bold) */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-body);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .stat-card:hover { transform: translateY(-2px); }

    .stat-card.total { background: #f8fafc; border-color: #cbd5e1; grid-column: 1 / -1; }
    .stat-card.new { background: var(--success-bg); color: var(--success-text); }
    .stat-card.updated { background: var(--warning-bg); color: var(--warning-text); }
    .stat-card.removed { background: var(--danger-bg); color: var(--danger-text); }

    .stat-label { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }
    .stat-value { font-size: 32px; font-weight: 700; margin: 4px 0; line-height: 1; }
    .stat-desc { font-size: 12px; opacity: 0.7; }

    /* Filter Inputs */
    .filters-stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .field-group { display: flex; flex-direction: column; gap: 6px; }
    
    .field-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      background: #fff;
      transition: all 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Class Chips */
    .class-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 4px 0;
    }

    .class-chips label {
      cursor: pointer;
      user-select: none;
    }
    
    .class-chips input[type="checkbox"] { display: none; }
    
    .class-chips span {
      display: inline-block;
      padding: 6px 12px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .class-chips input:checked + span {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }

    .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

    .btn-sm { padding: 6px 12px; font-size: 13px; }

    /* Changes Accordion */
    .change-lists details {
      background: var(--bg-body);
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .change-lists summary {
      padding: 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .change-lists ul {
      margin: 0;
      padding: 12px;
      background: #fff;
      border-top: 1px solid var(--border);
      list-style-type: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .change-lists li {
      font-size: 13px;
      padding: 4px 0;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text-muted);
    }

    /* Table Toolbar */
    .table-tools-container {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .toolbar-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: #f8fafc;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .sheet-tabs { display: flex; gap: 8px; }
    .sheet-tab {
      background: transparent;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
    }
    .sheet-tab.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }

    .view-toggles {
      display: flex;
      background: #e2e8f0;
      padding: 3px;
      border-radius: 8px;
    }
    .view-toggles button {
      background: transparent;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 500;
    }
    .view-toggles button.active {
      background: white;
      color: var(--text-main);
      box-shadow: var(--shadow-sm);
    }

    /* Table */
    .table-scroll-area {
      max-height: 700px;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead th {
      background: #f8fafc;
      position: sticky;
      top: 0;
      text-align: left;
      padding: 14px 16px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      z-index: 10;
    }

    tbody tr { transition: background 0.1s; }
    tbody tr:hover { background-color: #f1f5f9; }
    
    tbody td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text-main);
      white-space: nowrap;
    }

    /* Status Pills in Table */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 99px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-badge.normal { background: #f1f5f9; color: var(--text-muted); border: 1px solid #e2e8f0; }
    .status-badge.new { background: var(--success-bg); color: var(--success-text); }
    .status-badge.updated { background: var(--warning-bg); color: var(--warning-text); }

    /* New/Updated Row Highlights */
    tr.new-row td { background-color: #f0fdf4; }
    tr.updated-row td { background-color: #fefce8; }
    tr.new-row:hover td { background-color: #dcfce7; }
    tr.updated-row:hover td { background-color: #fef08a; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--text-main);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: none;
      z-index: 100;
    }
    .toast.visible { opacity: 1; transform: translateY(0); }

    /* Print Logic */
    @media print {
      body { background: white; padding: 0; }
      .app-shell { max-width: none; padding: 0; }
      header, .panel:not(.table-container-wrap), .table-toolbar, .no-print { display: none !important; }
      .panel { box-shadow: none; border: none; padding: 0; }
      .table-tools-container { border: none; box-shadow: none; overflow: visible; }
      .toolbar-header { display: none; }
      .table-scroll-area { max-height: none; overflow: visible; }
    }

    .muted-text { color: var(--text-muted); font-size: 12px; }
  </style>
</head>
<body>

  <div class="app-shell">
    
    <header class="app-header">
      <div class="app-title-block">
        <h1><span class="icon">üéì</span> √ñƒürenci Listesi Y√∂neticisi</h1>
        <p>Google E‚ÄëTablo Entegrasyonu + Firebase Takip Sistemi</p>
      </div>
      <div class="header-meta">
        <div class="chip">
          <span id="lastLoadedInfo">Veri bekleniyor...</span>
        </div>
        <div class="chip">
           <span id="compareSourceLabel">Kar≈üƒ±la≈ütƒ±rma: Yok</span>
        </div>
      </div>
    </header>

    <div class="dashboard-grid">
      
      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <section>
          <div class="stats-container">
            <div class="stat-card total">
              <div class="stat-label">Toplam √ñƒürenci</div>
              <div class="stat-value" id="totalCount">‚Äì</div>
              <div class="stat-desc">Aktif listedeki kayƒ±t sayƒ±sƒ±</div>
            </div>
            <div class="stat-card new">
              <div class="stat-label">Yeni</div>
              <div class="stat-value" id="newCount">‚Äì</div>
              <div class="stat-desc">√ñnceki listeye g√∂re</div>
            </div>
            <div class="stat-card updated">
              <div class="stat-label">G√ºncel</div>
              <div class="stat-value" id="updatedCount">‚Äì</div>
              <div class="stat-desc">Bilgisi deƒüi≈üenler</div>
            </div>
            <div class="stat-card removed">
              <div class="stat-label">Silinen</div>
              <div class="stat-value" id="removedCount">‚Äì</div>
              <div class="stat-desc">Listeden d√º≈üenler</div>
            </div>
          </div>
          
          <div class="change-lists">
            <details>
              <summary>üÜï Yeni Kayƒ±tlar <span class="status-badge new" id="newTagCount" style="margin-left:auto">0</span></summary>
              <ul id="newList"></ul>
            </details>
            <details>
              <summary>‚úèÔ∏è G√ºncellenenler <span class="status-badge updated" id="updatedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="updatedList"></ul>
            </details>
            <details>
              <summary>üóëÔ∏è Silinenler <span class="status-badge normal" id="removedTagCount" style="margin-left:auto">0</span></summary>
              <ul id="removedList"></ul>
            </details>
          </div>
        </section>

        <section class="panel">
          <div class="panel-title">
            <span>üîç Filtreleme</span>
            <button class="btn btn-secondary btn-sm" id="clearFiltersBtn" type="button">Temizle</button>
          </div>
          
          <div class="filters-stack">
            <div class="field-group">
              <div class="field-label">Genel Arama</div>
              <input type="text" id="searchInput" placeholder="ƒ∞sim, No, Veli..." />
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="field-group">
                <div class="field-label">Cinsiyet</div>
                <select id="genderFilter">
                  <option value="">T√ºm√º</option>
                  <option value="KIZ">Kƒ±z</option>
                  <option value="ERKEK">Erkek</option>
                </select>
              </div>
              <div class="field-group">
                <div class="field-label">Burs</div>
                <select id="scholarFilter">
                  <option value="">T√ºm√º</option>
                  <option value="nonempty">Burslu</option>
                  <option value="empty">Burssuz</option>
                </select>
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">Kayƒ±t Durumu</div>
              <select id="statusFilter">
                <option value="">T√ºm Durumlar</option>
                <option value="new">Sadece Yeni</option>
                <option value="updated">G√ºncellenenler</option>
                <option value="normal">Deƒüi≈üiklik Yok</option>
              </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="field-group">
                <div class="field-label">Ba≈ülangƒ±√ß Tarihi</div>
                <input type="date" id="dateFrom" />
              </div>
              <div class="field-group">
                <div class="field-label">Biti≈ü Tarihi</div>
                <input type="date" id="dateTo" />
              </div>
            </div>

            <div class="field-group">
                <div class="field-label">Tarih Sƒ±ralama</div>
                <select id="dateSortOrder">
                    <option value="">Otomatik (√ñncelikli Durum)</option>
                    <option value="desc">Yeniden ‚Üí Eskiye</option>
                    <option value="asc">Eskiden ‚Üí Yeniye</option>
                </select>
            </div>

            <div class="field-group">
              <div class="field-label">Sƒ±nƒ±flar</div>
              <div id="classFilterContainer" class="class-chips"></div>
            </div>

            <div class="field-group">
              <label style="display:flex; gap:8px; align-items:center; font-size:13px; cursor:pointer;">
                <input type="checkbox" id="recentOnly" style="width:16px; height:16px;" />
                <span>Sadece son 30 kayƒ±t</span>
              </label>
            </div>
            
            <hr style="border:0; border-top:1px solid var(--border); width:100%;">
            
            <div style="display:flex; flex-direction:column; gap:8px;">
               <button class="btn btn-secondary" id="reloadBtn" type="button">
                 üîÑ Verileri Yenile
               </button>
            </div>
          </div>
        </section>

      </div>

      <div class="table-tools-container">
        
        <div class="toolbar-header">
          <div class="table-toolbar-left" style="display:flex; flex-direction:column; gap:8px;">
            <div class="sheet-tabs" id="sheetTabs"></div>
            <div class="view-toggles">
              <button type="button" data-view="all" class="active" id="viewAllBtn">T√ºm Liste</button>
              <button type="button" data-view="new-updated" id="viewNewUpdatedBtn">‚ú® Deƒüi≈üiklikler</button>
            </div>
          </div>
          
          <div class="table-toolbar-right" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-primary btn-sm no-print" id="saveSnapshotBtn">
              üíæ Kaydet
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="downloadTxtBtn">
              üì• ƒ∞ndir (TXT)
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="uploadTxtBtn">
              üì§ Kar≈üƒ±la≈ütƒ±r
            </button>
            <button class="btn btn-secondary btn-sm no-print" id="printBtn">
              üñ®Ô∏è Yazdƒ±r
            </button>
          </div>
        </div>

        <div style="padding: 8px 24px; background: #fff; border-bottom: 1px solid var(--border); font-size:12px; color:var(--text-muted);" id="listStatusBar">
          Y√ºkleniyor...
        </div>

        <input type="file" id="uploadTxtInput" accept=".txt,.json" style="display:none;" />
        
        <div class="no-print" style="padding: 10px 24px; background: #f8fafc; border-bottom: 1px solid var(--border);">
            <details>
                <summary style="font-size:12px; color:var(--text-muted); cursor:pointer;">üñ®Ô∏è Yazdƒ±rma S√ºtunlarƒ±nƒ± Se√ß</summary>
                <div class="cols" id="printColsContainer" style="display:flex; flex-wrap:wrap; gap:12px; padding-top:8px; font-size:13px;"></div>
            </details>
        </div>

        <div class="table-scroll-area">
          <table id="studentsTable">
            <thead>
              <tr id="tableHeaderRow"></tr>
            </thead>
            <tbody id="tableBody">
              <tr class="loading-row">
                <td colspan="12" style="text-align:center; padding: 40px;">Veriler y√ºkleniyor...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div style="padding: 12px 24px; background: #f8fafc; border-top: 1px solid var(--border); font-size:12px; color:var(--text-muted); text-align:center;">
          <span id="lastSavedInfo">Son kayƒ±t: Yok</span> ‚Ä¢ H√ºcrelere √ßift tƒ±klayarak kopyalayabilirsiniz.
        </div>

      </div>

    </div>
  </div>

  <div class="toast" id="toast">
    <span style="font-size: 18px;">‚úÖ</span>
    <span id="toastMessage">ƒ∞≈ülem ba≈üarƒ±lƒ±.</span>
  </div>

  <script type="module">
    // =======================
    // KONFƒ∞G√úRASYON
    // =======================
    const SHEET_ID = "16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi";

    const SHEET_TABS = [
      { name: "2025-2026", label: "2025-2026 D√∂nemi" }
    ];

    let currentSheetName = SHEET_TABS[0].name;
    const STORAGE_KEY_BASE = "ogrenci_listesi_snapshot_v3_";

    const COLUMNS = [
      { key: "status",   label: "DURUM" },
      { key: "isim",     label: "ƒ∞Sƒ∞M" },
      { key: "soyisim",  label: "SOYƒ∞Sƒ∞M" },
      { key: "cinsiyet", label: "Cƒ∞NSƒ∞YET" },
      { key: "sinif",    label: "SINIF" },
      { key: "okulNo",   label: "OKUL NO" },
      { key: "veliAdi",  label: "VELƒ∞ ADI" },
      { key: "veliSoyadi", label: "VELƒ∞ SOYADI" },
      { key: "veliTelefon", label: "VELƒ∞ TELEFON" },
      { key: "yil",      label: "YIL" },
      { key: "tarih",    label: "TARƒ∞H" },
      { key: "burslu",   label: "BURSLU MU?" }
    ];

    let students = [];
    let snapshot = null;
    let snapshotSource = "none"; 
    let activeViewMode = "all";  

    // =======================
    // FIREBASE
    // =======================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const firebaseAnalytics = getAnalytics(firebaseApp);
    const firebaseDb = getDatabase(firebaseApp);
    const FIREBASE_BASE_PATH = 'snapshots';

    // =======================
    // ARA√áLAR
    // =======================
    function getSheetCsvUrl(sheetName) {
      return "https://docs.google.com/spreadsheets/d/" +
        SHEET_ID +
        "/gviz/tq?tqx=out:csv&sheet=" +
        encodeURIComponent(sheetName);
    }

    function getSnapshotRef() {
      const name = currentSheetName || 'default';
      const safeName = encodeURIComponent(name);
      return ref(firebaseDb, `${FIREBASE_BASE_PATH}/${safeName}`);
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      document.getElementById("toastMessage").textContent = message;
      toast.classList.add("visible");
      setTimeout(() => toast.classList.remove("visible"), 3000);
    }

    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];
        if (c === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
        } else if (c === '"') {
          inQuotes = !inQuotes;
        } else if (c === "," && !inQuotes) {
          currentRow.push(current);
          current = "";
        } else if ((c === "\n" || c === "\r") && !inQuotes) {
          if (current !== "" || currentRow.length > 0) {
            currentRow.push(current);
            rows.push(currentRow);
            currentRow = [];
            current = "";
          }
        } else {
          current += c;
        }
      }
      if (current !== "" || currentRow.length > 0) {
        currentRow.push(current);
        rows.push(currentRow);
      }
      return rows.filter(r => r.length > 0);
    }

    function parseDateTR(str) {
      if (!str) return null;
      const parts = str.trim().split(".");
      if (parts.length !== 3) return null;
      const [g, a, y] = parts.map(p => parseInt(p, 10));
      if (isNaN(g) || isNaN(a) || isNaN(y)) return null;
      return new Date(y, a - 1, g);
    }

    function formatDateTimeForBadge(isoString) {
      if (!isoString) return "‚Äì";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "‚Äì";
      return d.toLocaleDateString("tr-TR", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    function createStudentId(row) {
      const num = (row.okulNo || "").trim();
      const name = (row.isim || "").trim().toUpperCase();
      const surname = (row.soyisim || "").trim().toUpperCase();
      if (num) return `${num}__${name}__${surname}`;
      return `${name}__${surname}`;
    }

    function deepEqual(a, b) {
      if (a === null || b === null || typeof a !== 'object' || typeof b !== 'object') {
        return a === b;
      }
      const keysA = Object.keys(a).sort();
      const keysB = Object.keys(b).sort();
      if (keysA.length !== keysB.length) return false;
      for (let i = 0; i < keysA.length; i++) {
        const keyA = keysA[i];
        const keyB = keysB[i];
        if (keyA !== keyB) return false;
        const valA = a[keyA];
        const valB = b[keyB];
        if (valA === null || valB === null || typeof valA !== 'object' || typeof valB !== 'object') {
          if (valA !== valB) return false;
        } else {
          if (!deepEqual(valA, valB)) return false;
        }
      }
      return true;
    }

    // =======================
    // SNAPSHOT LOGIC
    // =======================
    function buildSnapshotObject(currentStudents) {
      const records = {};
      currentStudents.forEach(s => {
        records[s.id] = {
          id: s.id,
          data: {
            isim: s.isim, soyisim: s.soyisim, cinsiyet: s.cinsiyet,
            sinif: s.sinif, okulNo: s.okulNo, veliAdi: s.veliAdi,
            veliSoyadi: s.veliSoyadi, veliTelefon: s.veliTelefon,
            yil: s.yil, tarih: s.tarih, burslu: s.burslu
          }
        };
      });
      return {
        savedAt: new Date().toISOString(),
        sheetName: currentSheetName,
        records
      };
    }

    function updateSnapshotLabels() {
      const lastSavedInfo = document.getElementById("lastSavedInfo");
      const compareLabel = document.getElementById("compareSourceLabel");

      if (!snapshot) {
        lastSavedInfo.textContent = "Son kaydedilen liste: Hen√ºz yok";
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma: Yok";
        return;
      }

      const count = Object.keys(snapshot.records || {}).length;
      lastSavedInfo.textContent = "Son kayƒ±t: " + formatDateTimeForBadge(snapshot.savedAt) + ` (${count} √∂ƒür.)`;

      if (snapshotSource === "firebase") {
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma: Firebase DB";
      } else if (snapshotSource === "file") {
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma: TXT Dosyasƒ±";
      } else {
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma: Yok";
      }
    }

    async function loadSnapshot() {
      try {
        const snapRef = getSnapshotRef();
        const snapData = await get(snapRef);
        if (!snapData.exists()) {
          snapshot = null;
          snapshotSource = "none";
          updateSnapshotLabels();
          return;
        }
        snapshot = snapData.val();
        snapshotSource = "firebase";
        updateSnapshotLabels();
      } catch (e) {
        console.error("Snapshot y√ºklenemedi", e);
        snapshot = null;
        snapshotSource = "none";
        updateSnapshotLabels();
      }
    }

    async function saveSnapshot(currentStudents) {
      const snap = buildSnapshotObject(currentStudents);
      try {
        const snapRef = getSnapshotRef();
        await set(snapRef, snap);
        snapshot = snap;
        snapshotSource = "firebase";
        updateSnapshotLabels();
        showToast("Liste Firebase'e ba≈üarƒ±yla kaydedildi.");
      } catch (e) {
        console.error("Snapshot kaydedilemedi", e);
        showToast("Hata: Kayƒ±t yapƒ±lamadƒ±.");
      }
    }

    function applySnapshotFromFile(obj) {
      if (!obj || !obj.records) {
        showToast("Hatalƒ± dosya formatƒ±.");
        return;
      }
      snapshot = obj;
      snapshotSource = "file";
      updateSnapshotLabels();
      showToast("TXT y√ºklendi, kar≈üƒ±la≈ütƒ±rma yapƒ±lƒ±yor.");
      loadData();
    }

    // =======================
    // VERƒ∞ Y√úKLEME
    // =======================
    async function loadData() {
      const body = document.getElementById("tableBody");
      body.innerHTML = '<tr class="loading-row"><td colspan="12" style="text-align:center; padding:40px;">Google Tablo\'dan veriler alƒ±nƒ±yor...</td></tr>';
      document.getElementById("lastLoadedInfo").textContent = "Y√ºkleniyor...";

      try {
        const url = getSheetCsvUrl(currentSheetName);
        const res = await fetch(url);
        if (!res.ok) throw new Error("Aƒü hatasƒ±: " + res.status);
        const text = await res.text();

        if (text.startsWith("<")) throw new Error("CSV yerine HTML geldi. Tablo yayƒ±n ayarlarƒ±nƒ± kontrol edin.");

        const rows = parseCSV(text);
        if (!rows.length) {
          body.innerHTML = '<tr class="loading-row"><td colspan="12">Tablo bo≈ü.</td></tr>';
          updateListStatus([]);
          return;
        }

        const header = rows[0].map(h => h.trim());
        const dataRows = rows.slice(1).filter(r => r.some(cell => cell.trim() !== ""));

        const headerIndex = name => header.indexOf(name);
        const idxIsim = headerIndex("ƒ∞sim") === -1 ? 0 : headerIndex("ƒ∞sim");
        const idxSoy = headerIndex("Soyisim*");
        const idxCins = headerIndex("Cinsiyet*");
        const idxSinif = headerIndex("Sƒ±nƒ±f");
        const idxOkulNo = headerIndex("Okul Numarasƒ±");
        const idxVeliAd = headerIndex("Veli Adƒ±");
        const idxVeliSoy = headerIndex("Veli Soyadƒ±");
        const idxVeliTel = headerIndex("Veli Telefon");
        const idxYil = headerIndex("YIL");
        const idxTarih = headerIndex("Tarih");
        const idxBurs = headerIndex("Burslu mu?");

        const parsed = dataRows.map(row => {
          const s = {
            isim: (row[idxIsim] || "").trim(),
            soyisim: (row[idxSoy] || "").trim(),
            cinsiyet: (row[idxCins] || "").trim().toUpperCase(),
            sinif: (row[idxSinif] || "").trim(),
            okulNo: (row[idxOkulNo] || "").trim(),
            veliAdi: (row[idxVeliAd] || "").trim(),
            veliSoyadi: (row[idxVeliSoy] || "").trim(),
            veliTelefon: (row[idxVeliTel] || "").trim(),
            yil: (row[idxYil] || "").trim(),
            tarih: (row[idxTarih] || "").trim(),
            burslu: (row[idxBurs] || "").trim()
          };
          s.id = createStudentId(s);
          s.dateObj = parseDateTR(s.tarih);
          s.status = "normal";
          return s;
        });

        let removed = [];
        if (snapshot && snapshot.records) {
          const prevMap = snapshot.records;
          const currentIds = new Set(parsed.map(s => s.id));

          parsed.forEach(s => {
            const prev = prevMap[s.id];
            if (!prev) {
              s.status = "new";
            } else {
              const prevData = prev.data;
              const currentSlim = {
                isim: s.isim, soyisim: s.soyisim, cinsiyet: s.cinsiyet,
                sinif: s.sinif, okulNo: s.okulNo, veliAdi: s.veliAdi,
                veliSoyadi: s.veliSoyadi, veliTelefon: s.veliTelefon,
                yil: s.yil, tarih: s.tarih, burslu: s.burslu
              };
              if (!deepEqual(prevData, currentSlim)) {
                s.status = "updated";
              }
            }
          });

          for (const prevId in prevMap) {
            if (!currentIds.has(prevId)) {
              removed.push(prevMap[prevId]);
            }
          }
        }

        students = parsed;
        renderHeader();
        populateFilters();
        updateSummary(removed);
        applyFilters(removed);
        document.getElementById("lastLoadedInfo").textContent = `${currentSheetName} | ${formatDateTimeForBadge(new Date().toISOString())}`;
      
      } catch (err) {
        console.error(err);
        body.innerHTML = `<tr class="loading-row"><td colspan="12" style="color:red">Hata: ${err.message}</td></tr>`;
        document.getElementById("lastLoadedInfo").textContent = "Hata olu≈ütu.";
        updateListStatus([]);
      }
    }

    // =======================
    // UI RENDER
    // =======================
    function renderSheetTabs() {
      const container = document.getElementById("sheetTabs");
      container.innerHTML = "";
      SHEET_TABS.forEach(tab => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sheet-tab";
        if (tab.name === currentSheetName) btn.classList.add("active");
        btn.textContent = tab.label;
        btn.addEventListener("click", async () => {
          if (currentSheetName === tab.name) return;
          currentSheetName = tab.name;
          await loadSnapshot();
          renderSheetTabs();
          await loadData();
        });
        container.appendChild(btn);
      });
    }

    function renderHeader() {
      const headerRow = document.getElementById("tableHeaderRow");
      headerRow.innerHTML = "";
      COLUMNS.forEach((col, index) => {
        const th = document.createElement("th");
        th.textContent = col.label;
        th.dataset.field = col.key;
        headerRow.appendChild(th);
      });

      const printContainer = document.getElementById("printColsContainer");
      printContainer.innerHTML = "";
      COLUMNS.forEach(col => {
        const id = "print-col-" + col.key;
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "6px";
        label.innerHTML = `
          <input type="checkbox" id="${id}" data-field="${col.key}" checked />
          <span>${col.label}</span>
        `;
        printContainer.appendChild(label);
      });
    }

    function populateFilters() {
      const container = document.getElementById("classFilterContainer");
      const classes = Array.from(new Set(students.map(s => s.sinif).filter(Boolean))).sort();
      container.innerHTML = "";
      classes.forEach(cls => {
        const id = "class-filter-" + cls.replace(/\s+/g, "_");
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" value="${cls}">
          <span>${cls}</span>
        `;
        container.appendChild(label);
      });
    }

    function getSelectedClasses() {
      const boxes = document.querySelectorAll("#classFilterContainer input[type='checkbox']");
      const selected = [];
      boxes.forEach(cb => { if (cb.checked) selected.push(cb.value); });
      return selected;
    }

    function updateSummary(removedRecords = []) {
      const total = students.length;
      const newCount = students.filter(s => s.status === "new").length;
      const updatedCount = students.filter(s => s.status === "updated").length;
      const removedCount = removedRecords.length;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("newCount").textContent = newCount;
      document.getElementById("updatedCount").textContent = updatedCount;
      document.getElementById("removedCount").textContent = removedCount;

      document.getElementById("newTagCount").textContent = newCount;
      document.getElementById("updatedTagCount").textContent = updatedCount;
      document.getElementById("removedTagCount").textContent = removedCount;

      const fillList = (listId, items, isRemoved = false) => {
        const el = document.getElementById(listId);
        el.innerHTML = "";
        items.forEach(s => {
          const d = isRemoved ? (s.data || {}) : s;
          const li = document.createElement("li");
          li.innerHTML = `<b>${d.okulNo || "?"}</b> ${d.isim} ${d.soyisim} <small>(${d.sinif})</small>`;
          el.appendChild(li);
        });
      };

      fillList("newList", students.filter(s => s.status === "new"));
      fillList("updatedList", students.filter(s => s.status === "updated"));
      fillList("removedList", removedRecords, true);
    }

    function updateListStatus(filteredRows) {
      const bar = document.getElementById("listStatusBar");
      if (!bar) return;
      const visible = filteredRows ? filteredRows.length : 0;
      const total = students.length;
      const recentOnly = document.getElementById("recentOnly").checked;
      
      let msg = `Toplam <strong>${total}</strong> kayƒ±t i√ßinden <strong>${visible}</strong> tanesi g√∂r√ºnt√ºleniyor.`;
      if (recentOnly && visible >= 30) msg += " (Son 30 kayƒ±t filtresi aktif)";
      bar.innerHTML = msg;
    }

    function applyFilters(removedRecords = []) {
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
      const genderVal = document.getElementById("genderFilter").value;
      const scholarVal = document.getElementById("scholarFilter").value;
      const statusVal = document.getElementById("statusFilter").value;
      const recentOnly = document.getElementById("recentOnly").checked;
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;
      const selectedClasses = getSelectedClasses();
      const dateSortOrder = document.getElementById("dateSortOrder").value;

      let fromDate = null;
      let toDate = null;
      if (dateFromVal) fromDate = new Date(dateFromVal + "T00:00:00");
      if (dateToVal)   toDate    = new Date(dateToVal    + "T23:59:59");

      let filtered = students.slice();

      filtered = filtered.filter(s => {
        if (activeViewMode === "new-updated" && !(s.status === "new" || s.status === "updated")) return false;
        if (statusVal) {
          if (statusVal === "normal" && s.status !== "normal") return false;
          if (statusVal === "new" && s.status !== "new") return false;
          if (statusVal === "updated" && s.status !== "updated") return false;
        }
        if (selectedClasses.length && !selectedClasses.includes(s.sinif)) return false;
        if (genderVal && s.cinsiyet !== genderVal) return false;
        if (scholarVal === "nonempty" && !s.burslu) return false;
        if (scholarVal === "empty" && s.burslu) return false;
        if (fromDate && s.dateObj && s.dateObj < fromDate) return false;
        if (toDate && s.dateObj && s.dateObj > toDate) return false;
        
        if (searchText) {
          const combined = Object.values(s).join(" ").toLowerCase();
          if (!combined.includes(searchText)) return false;
        }
        return true;
      });

      // SIRALAMA
      const statusOrder = { new: 0, updated: 1, normal: 2 };
      if (dateSortOrder === "desc" || dateSortOrder === "asc") {
        filtered.sort((a, b) => {
          const da = a.dateObj, db = b.dateObj;
          if (da && db && da.getTime() !== db.getTime()) {
            return dateSortOrder === "desc" ? db - da : da - db;
          } else if (da && !db) return -1;
          else if (!da && db) return 1;
          
          const sa = statusOrder[a.status] ?? 2;
          const sb = statusOrder[b.status] ?? 2;
          if (sa !== sb) return sa - sb;
          return parseInt(b.okulNo || "0") - parseInt(a.okulNo || "0");
        });
      } else {
        filtered.sort((a, b) => {
          const sa = statusOrder[a.status] ?? 2;
          const sb = statusOrder[b.status] ?? 2;
          if (sa !== sb) return sa - sb;
          const da = a.dateObj, db = b.dateObj;
          if (da && db && da.getTime() !== db.getTime()) return db - da;
          return parseInt(b.okulNo || "0") - parseInt(a.okulNo || "0");
        });
      }

      if (recentOnly && filtered.length > 30) filtered = filtered.slice(0, 30);

      renderTable(filtered);
      updateSummary(removedRecords);
      updateListStatus(filtered);
    }

    function renderTable(rows) {
      const body = document.getElementById("tableBody");
      body.innerHTML = "";

      if (!rows.length) {
        body.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:30px; color:var(--text-muted)">E≈üle≈üen kayƒ±t bulunamadƒ±.</td></tr>';
        return;
      }

      rows.forEach(s => {
        const tr = document.createElement("tr");
        if (s.status === "new") tr.classList.add("new-row");
        if (s.status === "updated") tr.classList.add("updated-row");

        COLUMNS.forEach((col, index) => {
          const td = document.createElement("td");
          td.dataset.field = col.key;
          
          if (col.key === "status") {
            const span = document.createElement("span");
            if (s.status === "new") {
              span.className = "status-badge new";
              span.innerHTML = `‚ú® YENƒ∞`;
            } else if (s.status === "updated") {
              span.className = "status-badge updated";
              span.innerHTML = `üìù G√úNCEL`;
            } else {
              span.className = "status-badge normal";
              span.innerHTML = `NORMAL`;
            }
            td.appendChild(span);
          } else {
             if (col.key === "veliTelefon" && s[col.key]) {
               td.innerHTML = `<span style="opacity:0.6">${s[col.key]}</span>`;
             } else {
               td.textContent = s[col.key] || "";
             }
          }
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
      syncPrintColumnVisibility();
    }

    function syncPrintColumnVisibility() {
      const rows = document.querySelectorAll("#studentsTable tr");
      const checkboxes = document.querySelectorAll("#printColsContainer input[type='checkbox']");
      const hiddenFields = new Set();
      checkboxes.forEach(cb => {
        if (!cb.checked) hiddenFields.add(cb.dataset.field);
      });

      rows.forEach(tr => {
        Array.from(tr.children).forEach(cell => {
          const field = cell.dataset.field;
          if (!field) return;
          cell.style.display = hiddenFields.has(field) ? "none" : "";
        });
      });
    }

    // =======================
    // INIT & EVENTS
    // =======================
    function setupEventListeners() {
      const ids = ["searchInput", "genderFilter", "scholarFilter", "statusFilter", "dateFrom", "dateTo", "recentOnly", "dateSortOrder"];
      ids.forEach(id => document.getElementById(id).addEventListener("input", () => applyFilters()));
      
      document.getElementById("classFilterContainer").addEventListener("change", () => applyFilters());

      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el.type==='checkbox') el.checked=false; else el.value="";
        });
        document.querySelectorAll("#classFilterContainer input").forEach(cb => cb.checked=false);
        applyFilters();
      });

      document.getElementById("reloadBtn").addEventListener("click", () => loadData());
      document.getElementById("saveSnapshotBtn").addEventListener("click", () => saveSnapshot(students));
      document.getElementById("printBtn").addEventListener("click", () => {
        syncPrintColumnVisibility();
        window.print();
      });
      document.getElementById("printColsContainer").addEventListener("change", syncPrintColumnVisibility);

      document.getElementById("viewAllBtn").addEventListener("click", (e) => {
        activeViewMode = "all";
        document.querySelectorAll(".view-toggles button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        applyFilters();
      });

      document.getElementById("viewNewUpdatedBtn").addEventListener("click", (e) => {
        activeViewMode = "new-updated";
        document.querySelectorAll(".view-toggles button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
        applyFilters();
      });

      // √áift tƒ±klama ile kopyalama
      document.getElementById("tableBody").addEventListener("dblclick", async e => {
        const cell = e.target.closest("td");
        if (!cell) return;
        const text = cell.innerText.trim();
        if (!text) return;
        try {
          await navigator.clipboard.writeText(text);
          showToast("Kopyalandƒ±: " + text);
        } catch(err) { console.error(err); }
      });

      // TXT ƒ∞ndir
      document.getElementById("downloadTxtBtn").addEventListener("click", () => {
        if (!students.length) return showToast("Liste bo≈ü.");
        const snap = buildSnapshotObject(students);
        const blob = new Blob([JSON.stringify(snap, null, 2)], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `liste_${currentSheetName}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast("TXT ƒ∞ndirildi.");
      });

      // TXT Y√ºkle
      const uploadInput = document.getElementById("uploadTxtInput");
      document.getElementById("uploadTxtBtn").addEventListener("click", () => {
        uploadInput.value = "";
        uploadInput.click();
      });
      uploadInput.addEventListener("change", e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            applySnapshotFromFile(JSON.parse(reader.result));
          } catch(err) { showToast("Dosya okunamadƒ±."); }
        };
        reader.readAsText(file);
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      renderSheetTabs();
      setupEventListeners();
      await loadSnapshot();
      await loadData();
    });
  </script>
</body>
</html>

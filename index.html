<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>√ñƒürenci Listesi Y√∂neticisi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-alt: #ffffff;
      --border: #d1d5db;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-soft: #4b5563;
      --accent: #1f2937;
      --accent-soft: #4b5563;
      --accent-light: #e5e7eb;
      --danger: #b91c1c;
      --success: #047857;
      --warning: #b45309;
      --radius-lg: 18px;
      --radius-md: 14px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.1);
      --shadow-subtle: 0 6px 20px rgba(15, 23, 42, 0.06);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #f9fafb, #e5e7eb);
      color: var(--text-main);
    }

    body, html {
      height: 100%;
      width: 100%;
    }

    .app-shell {
      max-width: 1500px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    header.app-header {
      background: rgba(17, 24, 39, 0.96);
      color: #f9fafb;
      border-radius: 26px;
      padding: 22px 26px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      box-shadow: var(--shadow-soft);
    }

    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title-block h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title-block h1 span.icon {
      font-size: 24px;
    }

    .app-title-block p {
      margin: 0;
      font-size: 13px;
      color: #d1d5db;
    }

    .header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: #d1d5db;
      align-items: center;
      justify-content: flex-end;
    }

    .chip {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(209, 213, 219, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.82);
    }

    .chip strong {
      color: #f9fafb;
    }

    .chip span.icon {
      font-size: 14px;
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(350px, 380px) minmax(0, 1fr);
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 1100px) {
      .layout-main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--bg-alt);
      border-radius: 22px;
      padding: 18px 18px 18px 18px;
      box-shadow: var(--shadow-subtle);
      border: 1px solid var(--border-soft);
    }

    .panel-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .panel-title-row h2 {
      margin: 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-main);
    }

    .panel-title-row h2 span.icon {
      font-size: 18px;
    }

    .panel-subtitle {
      margin: 0;
      font-size: 12px;
      color: var(--text-soft);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 12px;
    }

    @media (max-width: 768px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .field-label {
      font-weight: 500;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .field-label span.badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="date"],
    select {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 7px 10px;
      font-size: 13px;
      background: #f9fafb;
      color: var(--text-main);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
      min-height: 34px;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.18);
      background-color: #ffffff;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 15px;
      height: 15px;
      border-radius: 4px;
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .controls-row {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    button.btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #111827;
      color: #f9fafb;
      letter-spacing: 0.02em;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background-color 0.12s ease, border-color 0.12s ease;
      min-height: 36px;
    }

    button.btn span.icon {
      font-size: 14px;
    }

    button.btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.38);
      background: #030712;
    }

    button.btn-ghost {
      background: #ffffff;
      color: var(--accent);
      border-color: var(--border);
    }

    button.btn-ghost:hover {
      background: #111827;
      color: #f9fafb;
    }

    button.btn-subtle {
      background: #f3f4f6;
      color: var(--text-soft);
      border-color: var(--border-soft);
    }

    button.btn-subtle:hover {
      background: #e5e7eb;
      color: var(--text-main);
    }

    button.btn-sm {
      padding: 7px 12px;
      font-size: 12px;
      min-height: 30px;
    }

    button.btn:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .summary-card {
      border-radius: 16px;
      padding: 10px 11px;
      background: #f9fafb;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .summary-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-title span.icon {
      font-size: 14px;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 600;
    }

    .summary-meta {
      font-size: 10px;
      color: var(--text-soft);
    }

    .summary-card.new {
      border-color: rgba(4, 120, 87, 0.7);
    }

    .summary-card.updated {
      border-color: rgba(180, 83, 9, 0.8);
    }

    .summary-card.removed {
      border-color: rgba(185, 28, 28, 0.8);
    }

    .summary-card.total {
      border-color: rgba(55, 65, 81, 0.8);
    }

    .change-lists {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .change-lists details {
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: #f9fafb;
      padding: 8px 10px;
      margin-top: 6px;
    }

    .change-lists summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .change-lists summary::-webkit-details-marker {
      display: none;
    }

    .change-lists summary .tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
    }

    .change-lists ul {
      margin: 8px 0 0 0;
      padding-left: 14px;
      max-height: 160px;
      overflow: auto;
    }

    .change-lists li {
      margin-bottom: 4px;
    }

    .change-lists .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      margin-left: 4px;
    }

    .table-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sheet-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      background: #f3f4f6;
      border-radius: 999px;
      padding: 4px;
      margin-bottom: 8px;
    }

    .sheet-tab {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
    }

    .sheet-tab span.icon {
      font-size: 14px;
    }

    .sheet-tab.active {
      background: #111827;
      color: #f9fafb;
    }

    .table-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }

    .table-toolbar-left,
    .table-toolbar-right {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .view-toggle {
      border-radius: 999px;
      background: #f3f4f6;
      padding: 3px;
      display: inline-flex;
      gap: 4px;
    }

    .view-toggle button {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: var(--text-soft);
    }

    .view-toggle button.active {
      background: #111827;
      color: #f9fafb;
    }

    .table-container {
      border-radius: 20px;
      background: #ffffff;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      box-shadow: var(--shadow-subtle);
    }

    .table-scroll {
      max-height: 650px;
      overflow: auto;
      scrollbar-width: thin;
    }

    .table-scroll::-webkit-scrollbar {
      width: 7px;
      height: 7px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 999px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 960px;
      font-size: 13px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      border-bottom: 1px solid var(--border);
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: #4b5563;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:nth-child(odd) {
      background: #ffffff;
    }

    tbody td {
      padding: 7px 8px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      cursor: default;
    }

    tbody td span.muted {
      color: var(--text-soft);
      font-size: 12px;
    }

    tbody tr.new-row {
      background: #ecfdf5;
    }

    tbody tr.updated-row {
      background: #fffbeb;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .status-pill.new {
      border-color: rgba(4, 120, 87, 0.7);
      color: var(--success);
      background: #f0fdf4;
    }

    .status-pill.updated {
      border-color: rgba(180, 83, 9, 0.7);
      color: var(--warning);
      background: #fffbeb;
    }

    .status-pill.normal {
      border-color: var(--border-soft);
      color: var(--text-soft);
      background: #f9fafb;
    }

    .status-pill span.icon {
      font-size: 14px;
    }

    .status-pill span.label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .print-options {
      margin-top: 10px;
      padding: 8px 10px;
      background: #f9fafb;
      border-radius: 16px;
      border: 1px dashed var(--border);
      font-size: 11px;
      color: var(--text-soft);
    }

    .print-options .cols {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      margin-top: 6px;
    }

    .print-options label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .print-options input[type="checkbox"] {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .print-hint {
      margin-top: 4px;
      font-size: 10px;
    }

    .col-hidden {
      display: none;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      border-radius: 999px;
      background: #111827;
      color: #f9fafb;
      padding: 9px 15px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
      z-index: 50;
    }

    .toast.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .toast span.icon {
      font-size: 14px;
    }

    .badge-soft {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      color: var(--text-soft);
    }

    .loading-row td {
      text-align: center;
      padding: 20px 0;
      font-size: 13px;
      color: var(--text-soft);
    }

    .muted-tip {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    @media print {
      body {
        background: #ffffff;
        padding: 0;
      }

      header.app-header,
      .panel.filters,
      .table-toolbar,
      .print-options .print-hint,
      .no-print,
      .sheet-tabs {
        display: none !important;
      }

      .app-shell {
        max-width: none;
        margin: 0;
      }

      .panel.table-panel {
        box-shadow: none;
        border-radius: 0;
        border: none;
        padding: 0;
      }

      .table-container {
        box-shadow: none;
        border-radius: 0;
      }

      .table-scroll {
        max-height: none;
      }

      thead th {
        background: #f3f4f6 !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-block">
        <h1>
          <span class="icon">üìã</span>
          √ñƒürenci Listesi Y√∂neticisi
        </h1>
        <p>
          Birden fazla sekmeden veri okuyup deƒüi≈üiklikleri takip eden, TXT ile
          kar≈üƒ±la≈ütƒ±rma yapabilen geni≈ü, modern panel.
        </p>
      </div>
      <div class="header-meta">
        <div class="chip">
          <span class="icon">‚¨õ</span>
          <strong>Siyah / beyaz / gri tema</strong>
        </div>
        <div class="chip">
          <span class="icon">üß†</span>
          <span>localStorage + TXT kar≈üƒ±la≈ütƒ±rma desteƒüi</span>
        </div>
      </div>
    </header>

    <main class="layout-main">
      <!-- SOL PANEL -->
      <section class="panel filters">
        <div class="panel-title-row">
          <h2>
            <span class="icon">üéõÔ∏è</span>
            Filtreler & √ñzet
          </h2>
        </div>
        <p class="panel-subtitle">
          Arama, sƒ±nƒ±f, cinsiyet, burs ve tarih aralƒ±ƒüƒ±yla listeyi daralt.
          √áift tƒ±klama ile herhangi bir h√ºcrenin metnini kopyalayabilirsin.
        </p>

        <div class="filters-grid" style="margin-top: 12px;">
          <div class="field-group" style="grid-column: 1 / -1;">
            <div class="field-label">
              <span>Genel arama</span>
              <span class="badge">isim, veli, numara‚Ä¶</span>
            </div>
            <input type="text" id="searchInput" placeholder="√ñrn: 8D, ZEHRA, 9220, KAYA‚Ä¶" />
          </div>

          <div class="field-group">
            <div class="field-label"><span>Sƒ±nƒ±f</span></div>
            <select id="classFilter">
              <option value="">T√ºm√º</option>
            </select>
          </div>

          <div class="field-group">
            <div class="field-label"><span>Cinsiyet</span></div>
            <select id="genderFilter">
              <option value="">T√ºm√º</option>
              <option value="KIZ">Kƒ±z</option>
              <option value="ERKEK">Erkek</option>
            </select>
          </div>

          <div class="field-group">
            <div class="field-label"><span>Burs durumu</span></div>
            <select id="scholarFilter">
              <option value="">T√ºm√º</option>
              <option value="nonempty">Burslu (dolu h√ºcre)</option>
              <option value="empty">Bo≈ü</option>
            </select>
          </div>

          <div class="field-group">
            <div class="field-label"><span>Durum</span></div>
            <select id="statusFilter">
              <option value="">Hepsi</option>
              <option value="new">Sadece yeni</option>
              <option value="updated">G√ºncellenenler</option>
              <option value="normal">Normal kayƒ±tlar</option>
            </select>
          </div>

          <div class="field-group">
            <div class="field-label"><span>Tarih &ge;</span></div>
            <input type="date" id="dateFrom" />
          </div>

          <div class="field-group">
            <div class="field-label"><span>Tarih &le;</span></div>
            <input type="date" id="dateTo" />
          </div>

          <div class="field-group">
            <label class="checkbox-row">
              <input type="checkbox" id="recentOnly" />
              <span>Yalnƒ±zca en yeni kayƒ±tlarƒ± g√∂ster (√∂rn. ilk 30)</span>
            </label>
          </div>
        </div>

        <div class="controls-row">
          <button class="btn btn-subtle" id="clearFiltersBtn" type="button">
            <span class="icon">üßπ</span>
            Filtreleri temizle
          </button>
          <button class="btn btn-ghost" id="reloadBtn" type="button">
            <span class="icon">üîÑ</span>
            Bu sekmeyi yeniden y√ºkle
          </button>
        </div>

        <p class="muted-tip">
          √áift tƒ±klama ile herhangi bir h√ºcrenin metnini panoya kopyalayabilirsin.
        </p>

        <hr style="border:none;border-top:1px solid var(--border-soft);margin:14px 0;">

        <div>
          <div class="panel-title-row" style="margin-bottom: 6px;">
            <h2 style="font-size: 16px;">
              <span class="icon">üìä</span>
              Deƒüi≈üiklik √ñzeti
            </h2>
          </div>
          <p class="panel-subtitle">
            ≈ûu anki sekme, se√ßili kar≈üƒ±la≈ütƒ±rma kaynaƒüƒ±yla (localStorage veya TXT dosyasƒ±)
            kƒ±yaslanƒ±r. Yeni, g√ºncellenen veya silinen √∂ƒürenciler a≈üaƒüƒ±da √∂zetlenir.
          </p>

          <div class="summary-grid">
            <div class="summary-card total">
              <div class="summary-title">
                <span>Toplam</span>
                <span class="icon">‚¨ú</span>
              </div>
              <div class="summary-value" id="totalCount">‚Äì</div>
              <div class="summary-meta">Tablodaki √∂ƒürenci sayƒ±sƒ±.</div>
            </div>
            <div class="summary-card new">
              <div class="summary-title">
                <span>Yeni</span>
                <span class="icon">üÜï</span>
              </div>
              <div class="summary-value" id="newCount">‚Äì</div>
              <div class="summary-meta">√ñnceki listeye g√∂re yeni eklenen √∂ƒürenciler.</div>
            </div>
            <div class="summary-card updated">
              <div class="summary-title">
                <span>G√ºncellendi</span>
                <span class="icon">‚úèÔ∏è</span>
              </div>
              <div class="summary-value" id="updatedCount">‚Äì</div>
              <div class="summary-meta">Bilgilerinde deƒüi≈üiklik olan √∂ƒürenciler.</div>
            </div>
            <div class="summary-card removed">
              <div class="summary-title">
                <span>Silinen</span>
                <span class="icon">üóëÔ∏è</span>
              </div>
              <div class="summary-value" id="removedCount">‚Äì</div>
              <div class="summary-meta">Eski listede olup ≈üu an olmayan kayƒ±tlar.</div>
            </div>
          </div>

          <div class="change-lists">
            <details>
              <summary>
                <span>üÜï Yeni √∂ƒürenciler</span>
                <span class="tag" id="newTagCount">0</span>
              </summary>
              <ul id="newList"></ul>
            </details>
            <details>
              <summary>
                <span>‚úèÔ∏è G√ºncellenen √∂ƒürenciler</span>
                <span class="tag" id="updatedTagCount">0</span>
              </summary>
              <ul id="updatedList"></ul>
            </details>
            <details>
              <summary>
                <span>üóëÔ∏è Silinen √∂ƒürenciler</span>
                <span class="tag" id="removedTagCount">0</span>
              </summary>
              <ul id="removedList"></ul>
            </details>
            <p class="muted-tip">
              <span class="badge-soft" id="lastSavedInfo">Son kaydedilen liste: ‚Äì</span>
              <span class="badge-soft" id="compareSourceLabel">Kar≈üƒ±la≈ütƒ±rma kaynaƒüƒ±: Yok</span>
            </p>
          </div>
        </div>
      </section>

      <!-- SAƒû PANEL -->
      <section class="panel table-panel">
        <div class="panel-title-row">
          <h2>
            <span class="icon">üßæ</span>
            √ñƒürenci Tablosu
          </h2>
          <span class="badge-soft" id="lastLoadedInfo">Veri y√ºkleniyor‚Ä¶</span>
        </div>

        <!-- Sekme se√ßici -->
        <div class="sheet-tabs no-print" id="sheetTabs"></div>

        <div class="table-toolbar">
          <div class="table-toolbar-left">
            <div class="view-toggle">
              <button type="button" data-view="all" class="active" id="viewAllBtn">
                <span class="icon">‚¨ú</span>
                <span>T√ºm kayƒ±tlar</span>
              </button>
              <button type="button" data-view="new-updated" id="viewNewUpdatedBtn">
                <span class="icon">‚ú®</span>
                <span>Yeni + G√ºncellenen</span>
              </button>
            </div>
          </div>
          <div class="table-toolbar-right">
            <button class="btn btn-subtle btn-sm no-print" id="saveSnapshotBtn" type="button">
              <span class="icon">üíæ</span>
              Bu listeyi hafƒ±zaya kaydet
            </button>
            <button class="btn btn-subtle btn-sm no-print" id="downloadTxtBtn" type="button">
              <span class="icon">üì•</span>
              TXT olarak indir
            </button>
            <button class="btn btn-subtle btn-sm no-print" id="uploadTxtBtn" type="button">
              <span class="icon">üì§</span>
              TXT y√ºkle & kar≈üƒ±la≈ütƒ±r
            </button>
            <button class="btn btn-ghost btn-sm no-print" id="printBtn" type="button">
              <span class="icon">üñ®Ô∏è</span>
              Yazdƒ±r
            </button>
          </div>
        </div>

        <input type="file" id="uploadTxtInput" accept=".txt,.json" style="display:none;" />

        <div class="print-options no-print">
          <div><strong>Yazdƒ±rma se√ßenekleri</strong> üñ®Ô∏è</div>
          <div class="print-hint">
            Yazdƒ±r'a bastƒ±ƒüƒ±nda sadece se√ßili kolonlar g√∂r√ºn√ºr. T√ºm filtreler ge√ßerlidir.
            √áƒ±ktƒ± siyah / beyaz / gri tonlarƒ±nda modern tablolar ≈üeklindedir.
          </div>
          <div class="cols" id="printColsContainer"></div>
        </div>

        <div class="table-container">
          <div class="table-scroll">
            <table id="studentsTable">
              <thead>
                <tr id="tableHeaderRow"></tr>
              </thead>
              <tbody id="tableBody">
                <tr class="loading-row">
                  <td>Veri y√ºkleniyor‚Ä¶</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <span class="icon">üìé</span>
    <span id="toastMessage">Metin kopyalandƒ±.</span>
  </div>

  <script>
    // =======================
    // K O N F ƒ∞ G √ú R A S Y O N
    // =======================
    const SHEET_ID = "16BD_BrNLYBaXviCzB8yDKBGS2Vdj5DHi";

    // Buradaki name alanlarƒ± sekme adlarƒ±dƒ±r (alt tarafta yazan isimler).
    // ƒ∞stersen buraya ba≈üka sekmeleri de ekleyebilirsin.
    const SHEET_TABS = [
      { name: "2025-2026", label: "2025-2026" }
      // { name: "2024-2025", label: "2024-2025" },
      // { name: "2023-2024", label: "2023-2024" }
    ];

    let currentSheetName = SHEET_TABS[0].name;

    const STORAGE_KEY_BASE = "ogrenci_listesi_snapshot_v2_";

    const COLUMNS = [
      { key: "status", label: "Durum" },
      { key: "isim", label: "ƒ∞sim" },
      { key: "soyisim", label: "Soyisim" },
      { key: "cinsiyet", label: "Cinsiyet" },
      { key: "sinif", label: "Sƒ±nƒ±f" },
      { key: "okulNo", label: "Okul Numarasƒ±" },
      { key: "veliAdi", label: "Veli Adƒ±" },
      { key: "veliSoyadi", label: "Veli Soyadƒ±" },
      { key: "veliTelefon", label: "Veli Telefon" },
      { key: "yil", label: "Yƒ±l" },
      { key: "tarih", label: "Tarih" },
      { key: "burslu", label: "Burslu mu?" }
    ];

    let students = [];
    let snapshot = null; // √∂nceki liste
    let snapshotSource = "none"; // "none" | "local" | "file"
    let activeViewMode = "all"; // "all" | "new-updated"

    // =======================
    // A R A √á  F O N K S.
    // =======================

    function getSheetCsvUrl(sheetName) {
      return (
        "https://docs.google.com/spreadsheets/d/" +
        SHEET_ID +
        "/gviz/tq?tqx=out:csv&sheet=" +
        encodeURIComponent(sheetName)
      );
    }

    function getStorageKey() {
      return STORAGE_KEY_BASE + (currentSheetName || "default");
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      const msg = document.getElementById("toastMessage");
      msg.textContent = message;
      toast.classList.add("visible");
      setTimeout(() => {
        toast.classList.remove("visible");
      }, 2000);
    }

    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
        } else if (c === '"') {
          inQuotes = !inQuotes;
        } else if (c === "," && !inQuotes) {
          currentRow.push(current);
          current = "";
        } else if ((c === "\n" || c === "\r") && !inQuotes) {
          if (current !== "" || currentRow.length > 0) {
            currentRow.push(current);
            rows.push(currentRow);
            currentRow = [];
            current = "";
          }
        } else {
          current += c;
        }
      }
      if (current !== "" || currentRow.length > 0) {
        currentRow.push(current);
        rows.push(currentRow);
      }

      return rows.filter((r) => r.length > 0);
    }

    function parseDateTR(str) {
      if (!str) return null;
      const parts = str.trim().split(".");
      if (parts.length !== 3) return null;
      const [g, a, y] = parts.map((p) => parseInt(p, 10));
      if (isNaN(g) || isNaN(a) || isNaN(y)) return null;
      return new Date(y, a - 1, g);
    }

    function formatDateTimeForBadge(isoString) {
      if (!isoString) return "‚Äì";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "‚Äì";
      const datePart = d.toLocaleDateString("tr-TR", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });
      const timePart = d.toLocaleTimeString("tr-TR", {
        hour: "2-digit",
        minute: "2-digit"
      });
      return `${datePart} ${timePart}`;
    }

    function createStudentId(row) {
      const num = (row.okulNo || "").trim();
      const name = (row.isim || "").trim().toUpperCase();
      const surname = (row.soyisim || "").trim().toUpperCase();
      if (num) return `${num}__${name}__${surname}`;
      return `${name}__${surname}`;
    }

    function deepEqual(a, b) {
      return JSON.stringify(a) === JSON.stringify(b);
    }

    // =======================
    //   S N A P S H O T  Y A P I S I
    // =======================

    function buildSnapshotObject(currentStudents) {
      const records = {};
      currentStudents.forEach((s) => {
        records[s.id] = {
          id: s.id,
          data: {
            isim: s.isim,
            soyisim: s.soyisim,
            cinsiyet: s.cinsiyet,
            sinif: s.sinif,
            okulNo: s.okulNo,
            veliAdi: s.veliAdi,
            veliSoyadi: s.veliSoyadi,
            veliTelefon: s.veliTelefon,
            yil: s.yil,
            tarih: s.tarih,
            burslu: s.burslu
          }
        };
      });
      return {
        savedAt: new Date().toISOString(),
        sheetName: currentSheetName,
        records
      };
    }

    function updateSnapshotLabels() {
      const lastSavedInfo = document.getElementById("lastSavedInfo");
      const compareLabel = document.getElementById("compareSourceLabel");

      if (!snapshot) {
        lastSavedInfo.textContent = "Son kaydedilen liste: Hen√ºz yok";
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma kaynaƒüƒ±: Yok";
        return;
      }

      const count = Object.keys(snapshot.records || {}).length;
      lastSavedInfo.textContent =
        "Son kaydedilen liste: " +
        formatDateTimeForBadge(snapshot.savedAt) +
        ` (${count} √∂ƒürenci, sekme: ${snapshot.sheetName || "-"})`;

      if (snapshotSource === "local") {
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma kaynaƒüƒ±: Tarayƒ±cƒ± hafƒ±zasƒ± (localStorage)";
      } else if (snapshotSource === "file") {
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma kaynaƒüƒ±: Y√ºklenen TXT dosyasƒ±";
      } else {
        compareLabel.textContent = "Kar≈üƒ±la≈ütƒ±rma kaynaƒüƒ±: Yok";
      }
    }

    function loadSnapshot() {
      try {
        const raw = localStorage.getItem(getStorageKey());
        if (!raw) {
          snapshot = null;
          snapshotSource = "none";
          updateSnapshotLabels();
          return;
        }
        snapshot = JSON.parse(raw);
        snapshotSource = "local";
        updateSnapshotLabels();
      } catch (e) {
        console.error("Snapshot y√ºklenemedi", e);
        snapshot = null;
        snapshotSource = "none";
        updateSnapshotLabels();
      }
    }

    function saveSnapshot(currentStudents) {
      const snap = buildSnapshotObject(currentStudents);
      try {
        localStorage.setItem(getStorageKey(), JSON.stringify(snap));
        snapshot = snap;
        snapshotSource = "local";
        updateSnapshotLabels();
        showToast("Bu sekmenin listesi tarayƒ±cƒ± hafƒ±zasƒ±na kaydedildi.");
      } catch (e) {
        console.error("Snapshot kaydedilemedi", e);
        showToast("Liste kaydedilirken bir hata olu≈ütu.");
      }
    }

    function applySnapshotFromFile(obj) {
      if (!obj || !obj.records) {
        showToast("TXT i√ßeriƒüi beklenen formatta deƒüil.");
        return;
      }
      snapshot = obj;
      snapshotSource = "file";
      updateSnapshotLabels();
      showToast("TXT dosyasƒ± y√ºklendi, kar≈üƒ±la≈ütƒ±rma bu dosyaya g√∂re yapƒ±lƒ±yor.");
      loadData(); // yeniden oku ve bu snapshot ile kar≈üƒ±la≈ütƒ±r
    }

    // =======================
    //   V E R ƒ∞  Y √ú K L E M E
    // =======================

    async function loadData() {
      const body = document.getElementById("tableBody");
      body.innerHTML =
        '<tr class="loading-row"><td>Google E-Tablo ‚Üí CSV verisi okunuyor‚Ä¶</td></tr>';
      document.getElementById("lastLoadedInfo").textContent =
        "Veri y√ºkleniyor‚Ä¶";

      try {
        const url = getSheetCsvUrl(currentSheetName);
        const res = await fetch(url);
        if (!res.ok) throw new Error("Aƒü hatasƒ±: " + res.status);
        const text = await res.text();

        // Eƒüer CSV yerine HTML hata sayfasƒ± geldiyse uyar
        if (text.startsWith("<")) {
          throw new Error(
            "Eri≈üim izni veya link ayarlarƒ± nedeniyle CSV alƒ±namadƒ± (HTML d√∂nd√º)."
          );
        }

        const rows = parseCSV(text);
        if (!rows.length) {
          body.innerHTML =
            '<tr class="loading-row"><td>CSV i√ßeriƒüi bo≈ü g√∂r√ºn√ºyor.</td></tr>';
          return;
        }

        const header = rows[0].map((h) => h.trim());
        const dataRows = rows.slice(1).filter((r) =>
          r.some((cell) => cell.trim() !== "")
        );

        const headerIndex = (name) => header.indexOf(name);

        const idxIsim = headerIndex("ƒ∞sim") === -1 ? 0 : headerIndex("ƒ∞sim");
        const idxSoy = headerIndex("Soyisim*");
        const idxCins = headerIndex("Cinsiyet*");
        const idxSinif = headerIndex("Sƒ±nƒ±f");
        const idxOkulNo = headerIndex("Okul Numarasƒ±");
        const idxVeliAd = headerIndex("Veli Adƒ±");
        const idxVeliSoy = headerIndex("Veli Soyadƒ±");
        const idxVeliTel = headerIndex("Veli Telefon");
        const idxYil = headerIndex("YIL");
        const idxTarih = headerIndex("Tarih");
        const idxBurs = headerIndex("Burslu mu?");

        const parsed = dataRows.map((row) => {
          const s = {
            isim: (row[idxIsim] || "").trim(),
            soyisim: (row[idxSoy] || "").trim(),
            cinsiyet: (row[idxCins] || "").trim().toUpperCase(),
            sinif: (row[idxSinif] || "").trim(),
            okulNo: (row[idxOkulNo] || "").trim(),
            veliAdi: (row[idxVeliAd] || "").trim(),
            veliSoyadi: (row[idxVeliSoy] || "").trim(),
            veliTelefon: (row[idxVeliTel] || "").trim(),
            yil: (row[idxYil] || "").trim(),
            tarih: (row[idxTarih] || "").trim(),
            burslu: (row[idxBurs] || "").trim()
          };
          s.id = createStudentId(s);
          s.dateObj = parseDateTR(s.tarih);
          s.status = "normal";
          return s;
        });

        let removed = [];
        if (snapshot && snapshot.records) {
          const prevMap = snapshot.records;
          const currentIds = new Set(parsed.map((s) => s.id));

          parsed.forEach((s) => {
            const prev = prevMap[s.id];
            if (!prev) {
              s.status = "new";
            } else {
              const prevData = prev.data;
              const currentSlim = {
                isim: s.isim,
                soyisim: s.soyisim,
                cinsiyet: s.cinsiyet,
                sinif: s.sinif,
                okulNo: s.okulNo,
                veliAdi: s.veliAdi,
                veliSoyadi: s.veliSoyadi,
                veliTelefon: s.veliTelefon,
                yil: s.yil,
                tarih: s.tarih,
                burslu: s.burslu
              };
              if (!deepEqual(prevData, currentSlim)) {
                s.status = "updated";
              }
            }
          });

          for (const prevId in prevMap) {
            if (!currentIds.has(prevId)) {
              removed.push(prevMap[prevId]);
            }
          }
        }

        students = parsed;

        // "Son eklenenler" i√ßin: tarih DESC, yƒ±l DESC, okul no DESC
        students.sort((a, b) => {
          const da = a.dateObj;
          const db = b.dateObj;
          if (da && db && da.getTime() !== db.getTime()) return db - da;
          const ya = parseInt(a.yil || "0", 10);
          const yb = parseInt(b.yil || "0", 10);
          if (ya !== yb) return yb - ya;
          const na = parseInt(a.okulNo || "0", 10);
          const nb = parseInt(b.okulNo || "0", 10);
          return nb - na;
        });

        renderHeader();
        populateFilters();
        updateSummary(removed);
        applyFilters(removed);

        document.getElementById(
          "lastLoadedInfo"
        ).textContent = `Sekme: ${currentSheetName} | Son y√ºkleme: ${formatDateTimeForBadge(
          new Date().toISOString()
        )}`;
      } catch (err) {
        console.error(err);
        body.innerHTML =
          '<tr class="loading-row"><td>Veri y√ºklenirken hata olu≈ütu: ' +
          (err.message || err) +
          "</td></tr>";
        document.getElementById("lastLoadedInfo").textContent =
          "Veri y√ºklenirken hata olu≈ütu.";
      }
    }

    // =======================
    //   A R A Y √ú Z
    // =======================

    function renderSheetTabs() {
      const container = document.getElementById("sheetTabs");
      container.innerHTML = "";
      SHEET_TABS.forEach((tab) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sheet-tab";
        if (tab.name === currentSheetName) btn.classList.add("active");
        btn.innerHTML = `<span class="icon">üìë</span><span>${tab.label}</span>`;
        btn.addEventListener("click", () => {
          if (currentSheetName === tab.name) return;
          currentSheetName = tab.name;
          loadSnapshot(); // o sekmeye ait localStorage
          renderSheetTabs();
          loadData();
        });
        container.appendChild(btn);
      });
    }

    function renderHeader() {
      const headerRow = document.getElementById("tableHeaderRow");
      headerRow.innerHTML = "";
      COLUMNS.forEach((col, index) => {
        const th = document.createElement("th");
        th.textContent = col.label;
        th.dataset.field = col.key;
        th.dataset.colIndex = index;
        headerRow.appendChild(th);
      });

      const printContainer = document.getElementById("printColsContainer");
      printContainer.innerHTML = "";
      COLUMNS.forEach((col) => {
        const id = "print-col-" + col.key;
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" data-field="${col.key}" checked />
          <span>${col.label}</span>
        `;
        printContainer.appendChild(label);
      });
    }

    function populateFilters() {
      const classFilter = document.getElementById("classFilter");
      const classes = Array.from(
        new Set(students.map((s) => s.sinif).filter((x) => x))
      ).sort();
      classFilter.innerHTML = '<option value="">T√ºm√º</option>';
      classes.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        classFilter.appendChild(opt);
      });
    }

    function updateSummary(removedRecords = []) {
      const total = students.length;
      const newCount = students.filter((s) => s.status === "new").length;
      const updatedCount = students.filter((s) => s.status === "updated").length;
      const removedCount = removedRecords.length;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("newCount").textContent = newCount;
      document.getElementById("updatedCount").textContent = updatedCount;
      document.getElementById("removedCount").textContent = removedCount;

      document.getElementById("newTagCount").textContent = newCount;
      document.getElementById("updatedTagCount").textContent = updatedCount;
      document.getElementById("removedTagCount").textContent = removedCount;

      const newList = document.getElementById("newList");
      const updatedList = document.getElementById("updatedList");
      const removedList = document.getElementById("removedList");
      newList.innerHTML = "";
      updatedList.innerHTML = "";
      removedList.innerHTML = "";

      students
        .filter((s) => s.status === "new")
        .forEach((s) => {
          const li = document.createElement("li");
          li.textContent = `${s.okulNo || "‚Äì"} ‚Ä¢ ${s.isim} ${s.soyisim} (${s.sinif})`;
          newList.appendChild(li);
        });

      students
        .filter((s) => s.status === "updated")
        .forEach((s) => {
          const li = document.createElement("li");
          li.textContent = `${s.okulNo || "‚Äì"} ‚Ä¢ ${s.isim} ${s.soyisim} (${s.sinif})`;
          updatedList.appendChild(li);
        });

      removedRecords.forEach((r) => {
        const d = r.data || {};
        const li = document.createElement("li");
        li.innerHTML = `${d.okulNo || "‚Äì"} ‚Ä¢ ${d.isim || ""} ${
          d.soyisim || ""
        } <span class="pill">${d.sinif || ""}</span>`;
        removedList.appendChild(li);
      });
    }

    function applyFilters(removedRecords = []) {
      const searchText = document
        .getElementById("searchInput")
        .value.trim()
        .toLowerCase();
      const classVal = document.getElementById("classFilter").value;
      const genderVal = document.getElementById("genderFilter").value;
      const scholarVal = document.getElementById("scholarFilter").value;
      const statusVal = document.getElementById("statusFilter").value;
      const recentOnly = document.getElementById("recentOnly").checked;
      const dateFromVal = document.getElementById("dateFrom").value;
      const dateToVal = document.getElementById("dateTo").value;

      let fromDate = null;
      let toDate = null;
      if (dateFromVal) fromDate = new Date(dateFromVal + "T00:00:00");
      if (dateToVal) toDate = new Date(dateToVal + "T23:59:59");

      let filtered = students.slice();

      filtered = filtered.filter((s) => {
        if (
          activeViewMode === "new-updated" &&
          !(s.status === "new" || s.status === "updated")
        ) {
          return false;
        }

        if (statusVal) {
          if (statusVal === "normal" && s.status !== "normal") return false;
          if (statusVal === "new" && s.status !== "new") return false;
          if (statusVal === "updated" && s.status !== "updated") return false;
        }

        if (classVal && s.sinif !== classVal) return false;
        if (genderVal && s.cinsiyet !== genderVal) return false;

        if (scholarVal === "nonempty" && !s.burslu) return false;
        if (scholarVal === "empty" && s.burslu) return false;

        if (fromDate && s.dateObj && s.dateObj < fromDate) return false;
        if (toDate && s.dateObj && s.dateObj > toDate) return false;

        if (searchText) {
          const combined = [
            s.isim,
            s.soyisim,
            s.cinsiyet,
            s.sinif,
            s.okulNo,
            s.veliAdi,
            s.veliSoyadi,
            s.veliTelefon,
            s.yil,
            s.tarih,
            s.burslu
          ]
            .join(" ")
            .toLowerCase();
          if (!combined.includes(searchText)) return false;
        }
        return true;
      });

      if (recentOnly && filtered.length > 30) {
        filtered = filtered.slice(0, 30);
      }

      renderTable(filtered);
      updateSummary(removedRecords);
    }

    function renderTable(rows) {
      const body = document.getElementById("tableBody");
      body.innerHTML = "";

      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.className = "loading-row";
        const td = document.createElement("td");
        td.colSpan = COLUMNS.length;
        td.textContent =
          "Filtre sonu√ßlarƒ±na g√∂re g√∂sterilecek √∂ƒürenci bulunamadƒ±.";
        tr.appendChild(td);
        body.appendChild(tr);
        return;
      }

      rows.forEach((s) => {
        const tr = document.createElement("tr");
        if (s.status === "new") tr.classList.add("new-row");
        if (s.status === "updated") tr.classList.add("updated-row");

        COLUMNS.forEach((col, index) => {
          const td = document.createElement("td");
          td.dataset.field = col.key;
          td.dataset.colIndex = index;

          if (col.key === "status") {
            const pill = document.createElement("span");
            pill.className = "status-pill normal";
            let icon = "‚¨ú";
            let text = "NORMAL";
            if (s.status === "new") {
              pill.className = "status-pill new";
              icon = "üÜï";
              text = "YENƒ∞";
            } else if (s.status === "updated") {
              pill.className = "status-pill updated";
              icon = "‚úèÔ∏è";
              text = "G√úNCEL";
            }
            pill.innerHTML = `<span class="icon">${icon}</span><span class="label">${text}</span>`;
            td.appendChild(pill);
          } else {
            let value = s[col.key] || "";
            if (col.key === "veliTelefon" && value) {
              const span = document.createElement("span");
              span.textContent = value;
              span.className = "muted";
              value = "";
              td.appendChild(span);
            }
            if (value) {
              td.textContent = value;
            }
          }

          tr.appendChild(td);
        });

        body.appendChild(tr);
      });

      syncPrintColumnVisibility();
    }

    function syncPrintColumnVisibility() {
      const rows = document.querySelectorAll("#studentsTable tr");
      const checkboxes = document.querySelectorAll(
        "#printColsContainer input[type='checkbox']"
      );

      const hiddenFields = new Set();
      checkboxes.forEach((cb) => {
        const field = cb.dataset.field;
        if (!cb.checked) hiddenFields.add(field);
      });

      rows.forEach((tr) => {
        Array.from(tr.children).forEach((cell) => {
          const field = cell.dataset.field;
          if (!field) return;
          if (hiddenFields.has(field)) {
            cell.classList.add("col-hidden");
          } else {
            cell.classList.remove("col-hidden");
          }
        });
      });
    }

    // =======================
    //   E T K ƒ∞ N L ƒ∞ K L E R
    // =======================

    function setupEventListeners() {
      document
        .getElementById("searchInput")
        .addEventListener("input", () => applyFilters());
      document
        .getElementById("classFilter")
        .addEventListener("change", () => applyFilters());
      document
        .getElementById("genderFilter")
        .addEventListener("change", () => applyFilters());
      document
        .getElementById("scholarFilter")
        .addEventListener("change", () => applyFilters());
      document
        .getElementById("statusFilter")
        .addEventListener("change", () => applyFilters());
      document
        .getElementById("dateFrom")
        .addEventListener("change", () => applyFilters());
      document
        .getElementById("dateTo")
        .addEventListener("change", () => applyFilters());
      document
        .getElementById("recentOnly")
        .addEventListener("change", () => applyFilters());

      document.getElementById("clearFiltersBtn").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        document.getElementById("classFilter").value = "";
        document.getElementById("genderFilter").value = "";
        document.getElementById("scholarFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        document.getElementById("recentOnly").checked = false;
        applyFilters();
      });

      document.getElementById("reloadBtn").addEventListener("click", () => {
        loadData();
      });

      document.getElementById("saveSnapshotBtn").addEventListener("click", () =>
        saveSnapshot(students)
      );

      document.getElementById("printBtn").addEventListener("click", () => {
        syncPrintColumnVisibility();
        window.print();
      });

      document
        .getElementById("printColsContainer")
        .addEventListener("change", () => {
          syncPrintColumnVisibility();
        });

      document.getElementById("viewAllBtn").addEventListener("click", () => {
        activeViewMode = "all";
        document.getElementById("viewAllBtn").classList.add("active");
        document.getElementById("viewNewUpdatedBtn").classList.remove("active");
        applyFilters();
      });

      document
        .getElementById("viewNewUpdatedBtn")
        .addEventListener("click", () => {
          activeViewMode = "new-updated";
          document
            .getElementById("viewNewUpdatedBtn")
            .classList.add("active");
          document.getElementById("viewAllBtn").classList.remove("active");
          applyFilters();
        });

      // √áift tƒ±klama ile h√ºcre kopyalama
      document
        .getElementById("tableBody")
        .addEventListener("dblclick", async (e) => {
          const cell = e.target.closest("td");
          if (!cell) return;
          const text = cell.innerText.trim();
          if (!text) return;
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
            } else {
              const tmp = document.createElement("textarea");
              tmp.value = text;
              document.body.appendChild(tmp);
              tmp.select();
              document.execCommand("copy");
              document.body.removeChild(tmp);
            }
            showToast("Metin panoya kopyalandƒ±.");
          } catch (err) {
            console.error(err);
            showToast("Kopyalama sƒ±rasƒ±nda bir hata olu≈ütu.");
          }
        });

      // TXT ƒ∞NDƒ∞R
      document.getElementById("downloadTxtBtn").addEventListener("click", () => {
        if (!students.length) {
          showToast("ƒ∞ndirilecek liste bulunamadƒ±.");
          return;
        }
        const snap = buildSnapshotObject(students);
        const blob = new Blob([JSON.stringify(snap, null, 2)], {
          type: "text/plain;charset=utf-8"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const safeName = (currentSheetName || "liste").replace(/[^0-9A-Za-z_-]/g, "_");
        a.download = `ogrenci_listesi_${safeName}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("TXT dosyasƒ± indirildi.");
      });

      // TXT Y√úKLE
      const uploadInput = document.getElementById("uploadTxtInput");
      document.getElementById("uploadTxtBtn").addEventListener("click", () => {
        uploadInput.value = "";
        uploadInput.click();
      });
      uploadInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(reader.result);
            applySnapshotFromFile(obj);
          } catch (err) {
            console.error(err);
            showToast("TXT i√ßeriƒüi okunamadƒ± (JSON parse hatasƒ±).");
          }
        };
        reader.readAsText(file, "utf-8");
      });
    }

    // =======================
    // B A ≈û L A T
    // =======================
    document.addEventListener("DOMContentLoaded", () => {
      renderSheetTabs();
      setupEventListeners();
      loadSnapshot();
      loadData();
    });
  </script>
</body>
</html>
